<!DOCTYPE html>
<head>
	<meta http-equiv='Content-Type' content='text/html;charset=utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no'>
	<title>
		基于IntelVT技术的Linux内核调试器（五）-调试器核心
	</title>
	<script src='https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js'>
	</script>
	<style>
		a {color: #607fa6;text-decoration:none;word-wrap:break-word;word-break:break-all;}.rich_media_title{padding-bottom:10px;margin-bottom:14px;border-bottom:1px solid #e7e7eb;font-weight:400;} .rich_media_meta_list{font-size:14px;margin-bottom: 22px;}
		.rich_media_meta{display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:14px;}.rich_media_meta_text{color:#8c8c8c;color:rgba(0, 0, 0, 0.3)}.rich_media_meta_list
		em {font-style: normal;}@media screen and (max-width:768px){.rich_media{position:
		relative;padding: 20px 15px 15px;background-color: #fff;}}.rich_media_content{text-align:justify;} .rich_media_content * {max-width:100%!important;box-sizing: border-box!important;-webkit-box-sizing:
		border-box!important;word-wrap: break-word!important;}.rich_media_content
		blockquote {margin: 0;padding-left: 10px;border-left: 3px solid #dbdbdb;}.rich_media_content
		.list-paddingleft-2 {padding-left: 2.2em;}a.rich_media_meta_nickname{display: none;}@media screen and (min-width:1025px){.rich_media{position:relative;}a.rich_media_meta_nickname{display:inline-block!important;}span.rich_media_meta_nickname
		{display: inline-block!important;}.rich_media {width:677px;margin-left:auto;margin-right:auto;}}a.fwjm{font-size: 12px;color: #ececec;}.tenvideo_player {position: relative;width:
		100 %;height: 100 %;margin: auto;background: #000;}* {margin:0px;padding:0px;} body{line-height: 1.6;letter-spacing: .034em;}
		.dy_all {text-align: center;margin: 30px 0;} .dy_all a {display: inline-block;height:
		38px;line-height: 38px;padding: 0 18px;background-color: #009688;color:
		#fff;white-space: nowrap;font-size: 14px;border: none;border-radius: 2px;cursor:
		pointer;text-align: center;outline: 0;-webkit-appearance: none;transition:
		all .3s;-webkit-transition: all .3s;box-sizing: border-box;} img{max-width: 677px!important;}

		.crawler-info{padding: 8px 0;} .article-link>img{margin-left: 20px;width: 16px;}
		.comment-item::before,.comment-item::after{content:'';display:block;height:0;visibility:hidden;clear:both;*zoom:1;} .comment-item{margin-bottom:30px;}
		.avatar{width:12%; padding-right:10px;float:left;box-sizing:border-box;} .avatar img{width:100%;}
		.comment-body{float:left;width:88%;} .comment-body .comment-info{color:#b3b3b3;margin-bottom:4px;margin-top: -5px;} .comment-body .comment-info>span:last-child{float:right;} 
		.comment-author{border-left:4px solid green;padding-left:6px;margin:8px 0;}

		@media screen and (max-width: 420px) {.article-link>img {margin-left: 0px;}}
		@media screen and (min-width: 480px) {.avatar {width: 9%;}.comment-body {width: 91%;}}
	</style>
</head>
<body>
	<div id='js_article' class='rich_media'>
		<div class="crawler-info">
			<a href='https://www.52pojie.cn' class='fwjm' target='_blank'>
				提供的爬取软件来源于：52pojie.cn@夜泉 免费下载使用
			</a>
			<a href='https://mp.weixin.qq.com/s?__biz=MzI3NzA5MzUxNA==&amp;mid=415595937&amp;idx=1&amp;sn=46eba9d79f78cc3943c02b0c82caf347&amp;chksm=765a5044412dd9529c79d92ccf04a80c1bd685ed600c02b9e11a715309fcfa879a2379e338f5&amp;scene=27#wechat_redirect&cpage=81' target='_blank' class="article-link">
				<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAQCAMAAABA3o1rAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjk4QUEzQzVDNkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjk4QUEzQzVENkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OThBQTNDNUE2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OThBQTNDNUI2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5TKSKsAAAAclBMVEUuLi77+/stLS1VVVXx8fFOTk7s7Ozt7e1qamp5eXlNTU2WlpZFRUU6Ojrq6urn5+d/f3/8/Pw9PT0/Pz+YmJg8PDyZmZlAQECfn5+QkJBBQUFra2vo6OhDQ0OSkpKenp5WVlY+Pj7r6+tpaWksLCz///9o6ILHAAAAJnRSTlP/////////////////////////////////////////////////AKd6gbwAAACNSURBVHjajJHpEoIwDISDVMotcnuCmLz/K9KCdlqO6v7p7Mw3yW4KxG85fnUkIVfZ5J0SsCtqcgRw0HzjQYY2AAOIdRuaK4ReAPJ5nmglL5qICahpU60C0uXguQ9TgIwGJoDnT9z/ABmxt60ot0N2CsDLfb9mvBxs9ql+n5o9bEDBgbif7/1F4g80CjAAqrVAnnsm5f8AAAAASUVORK5CYII=" />
			</a>
		</div>
		<div id="img-content">

                
                <h2 class="rich_media_title" id="activity-name">基于IntelVT技术的Linux内核调试器（五）-调试器核心</h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                                                                            <span class="rich_media_meta rich_media_meta_text">
                                                        mxp
                                                    </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);">Linux内核之旅</a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">Linux内核之旅</strong>
                              <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">LinuxKernelTravel</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">Linux内核之旅</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>


                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2016-01-09</em>





                </div>

                
                
                                
                
                
                
                                                
                                                                
                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <h2><span style=";font-weight:bold;font-size:19px">1 </span><span style=";font-family:黑体;font-weight:bold;font-size:19px">反汇编引擎</span></h2><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">如果说调试框架是一个调试器的灵魂，那么接口与反汇编引擎就是一个调试器的身体。我们在调试过程中是要阅读指令代码的，而反汇编引擎则提供将二进制元指令翻译成可阅读的汇编代码这个功能。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">设计并实现一个初级的反汇编引擎很简单，但是计算机指令系统并不简单，将这个反汇编引擎实现到可以实际应用的级别需要不断地调试与修复</span><span style=";font-size:16px">Bugs</span><span style=";font-family:宋体;font-size:16px">，这个过程需要耗费大量精力。所以我选择了开源反汇编引擎。虽然网上有很多开源反汇编引擎，但是大部分都依赖于用户态的</span><span style=";font-size:16px">C</span><span style=";font-family:宋体;font-size:16px">库，导致不能很好地移植到内核模块上使用，而且具有优秀效率的反汇编引擎很少。这里我选择了</span><span style=";font-size:16px">libudis86</span><span style=";font-family:宋体;font-size:16px">，它是一个开源反汇编引擎，我只对其语法转换部分进行了一些修改，使其反汇编出来的指令格式符合比较好的阅读习惯。</span></p><h3><span style=";font-weight:bold;font-size:16px">1.1 libudis86</span><span style=";font-family:黑体;font-weight:bold;font-size:16px">的基本使用方法</span></h3><p style="text-indent:32px"><span style=";font-size:16px">Libudis86</span><span style=";font-family:宋体;font-size:16px">库的使用很简单，只要一个提供各种信息的结构体，调用</span><span style=";font-size:16px">ud_disasmembe</span><span style=";font-family:宋体;font-size:16px">函数即可。例如下面定义了一个反汇编某个指令的函数：</span></p><p><span style=";font-family:Verdana;font-size:12px">ULONG OriDisasm(PUCHAR str,ULONG Eip)</span></p><p><span style=";font-family:Verdana;font-size:12px">{</span></p><p><span style=";font-family:Verdana;font-size:12px">    UDIS ud_obj;</span></p><p><span style=";font-family:Verdana;font-size:12px">    ULONG len;</span></p><p><span style=";font-family:Verdana;font-size:12px"> </span></p><p><span style=";font-family:Verdana;font-size:12px">    ud_init(&amp;ud_obj);</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">初始化结构体</span></p><p><span style=";font-family:Verdana;font-size:12px">    ud_set_mode(&amp;ud_obj, 32);</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">设置为</span><span style=";font-family:Verdana;font-size:12px">32</span><span style=";font-family:宋体;font-size:12px">位元</span><span style=";font-family:Verdana;font-size:12px">CPU</span><span style=";font-family:宋体;font-size:12px">模式</span></p><p><span style=";font-family:Verdana;font-size:12px">    ud_set_syntax(&amp;ud_obj, UD_SYN_INTEL);</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">结果使用</span><span style=";font-family:Verdana;font-size:12px">Intel</span><span style=";font-family:宋体;font-size:12px">语法</span></p><p><span style=";font-family:Verdana;font-size:12px">    ud_set_pc(&amp;ud_obj,(int)Eip);</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">设置反汇编起点</span></p><p><span style=";font-family:Verdana;font-size:12px">    ud_set_input_buffer(&amp;ud_obj, (uint8_t*)Eip, 32);</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">设置输入缓冲区</span></p><p><span style=";font-family:Verdana;font-size:12px">    len = ud_disassemble(&amp;ud_obj);</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">开始反汇编</span></p><p><span style=";font-family:Verdana;font-size:12px">    strcpy(str,ud_insn_asm(&amp;ud_obj));</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">复制结果</span></p><p><span style=";font-family:Verdana;font-size:12px">    return len;</span></p><p><span style=";font-family:Verdana;font-size:12px">}</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">该函数反汇编</span><span style=";font-size:16px">Eip</span><span style=";font-family:宋体;font-size:16px">指向的二进制元指令码，将结果复制到</span><span style=";font-size:16px">str</span><span style=";font-family:宋体;font-size:16px">指向的缓冲区中。</span></p><h3><span style=";font-weight:bold;font-size:16px">1.2 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">使用</span><span style=";font-weight:bold;font-size:16px">libudis86</span><span style=";font-family:黑体;font-weight:bold;font-size:16px">反汇编某段程序</span></h3><p><span style=";font-family:宋体;font-size:14px">上面的函数</span><span style=";font-size:14px">OriDisasm</span><span style=";font-family:宋体;font-size:14px">只能反汇编一条指令，通常我们的调试器需要反汇编</span><span style="text-indent: 32px; line-height: 1.6; font-family: 宋体;">一段程序。</span><span style="text-indent: 32px; line-height: 1.6;"> OriDisasm</span><span style="text-indent: 32px; line-height: 1.6; font-family: 宋体;">在反汇编一条指令结束后会返回该指令长度（位元组），递增指令指针循环继续这项操作即可反汇编一段代码。</span></p><h3><span style=";font-weight:bold;font-size:16px">1.3 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">向上反汇编：递减命中率算法</span></h3><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">调试器的反汇编窗口应该像控制台窗口一样具有翻页功能，这样便于我们查阅反汇编代码，但是单纯地使用</span><span style=";font-size:16px">libudis86</span><span style=";font-family:宋体;font-size:16px">只能从上往下进行反汇编，如果我们需要向上翻页，则需要从下往上翻页。看似简单，实际上有一个很重要的难题。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">我们知道</span><span style=";font-size:16px">x86</span><span style=";font-family:宋体;font-size:16px">汇编指令是不定长的，一条指令可能最小只占用</span><span style=";font-size:16px">1</span><span style=";font-family:宋体;font-size:16px">个字节，最长可能占用</span><span style=";font-size:16px">15</span><span style=";font-family:宋体;font-size:16px">个字节，而我们并不知道某一条指令它的上一条指令占用多少个位元组，因此不能直接获取某一条指令的上一条指令是什么。例如下面的指令：</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F0  75 64</span><span style=";font-family:Verdana;font-size:12px">jnz</span><span style=";font-family:Verdana;font-size:12px">short 00401856</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F2  8B45 10</span><span style=";font-family:Verdana;font-size:12px">mov</span><span style=";font-family:Verdana;font-size:12px">eax, dword ptr [ebp+10]</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F5  C1E8 10</span><span style=";font-family:Verdana;font-size:12px">shr</span><span style=";font-family:Verdana;font-size:12px">eax, 10</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F8  83F8 07</span><span style=";font-family:Verdana;font-size:12px">cmp</span><span style=";font-family:Verdana;font-size:12px">eax, 7</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">第一列是指令位址，第二列是指令二进制元编码，第三列是对应的汇编代码。假设当前我们反汇编的位置是</span><span style=";font-size:16px">4017F8</span><span style=";font-family:宋体;font-size:16px">那么我们对这个内存位置的</span><span style=";font-size:16px">83 F8 07</span><span style=";font-family:宋体;font-size:16px">进行反汇编可以得到</span><span style=";font-size:16px">cmp eax,7</span><span style=";font-family:宋体;font-size:16px">这条指令，但是我们并不知道这条指令的上一条指令从什么位址开始，如果我们贸然猜测上一条指令的位址显然我们会得到一个错误的反汇编结果。例如对</span><span style=";font-size:16px">4017F6</span><span style=";font-family:宋体;font-size:16px">反汇编得到：</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F6  E8 1083F807</span><span style=";font-family:Verdana;font-size:12px">call</span><span style=";font-family:Verdana;font-size:12px">08389B0B</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">结果是一个占用</span><span style=";font-size:16px">5</span><span style=";font-family:宋体;font-size:16px">个位元组的</span><span style=";font-size:16px">call</span><span style=";font-family:宋体;font-size:16px">指令，而且这个指令覆盖了位于</span><span style=";font-size:16px">4017F8</span><span style=";font-family:宋体;font-size:16px">本来正确的结果。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">我设计了一个算法用以解决这个问题，算法的思想是递减地址指针，从这个指标开始向下循环反汇编，当长度刚刚好到达我们预期的位置时，记录上一条指令的位置。然后将这些结果进行统计。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">例如当前指令是</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F8  83F8 07</span><span style=";font-family:Verdana;font-size:12px">cmp</span><span style=";font-family:Verdana;font-size:12px">eax, 7</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">我们想要知道他的上一条指令是什么，就递减地址，得到</span><span style=";font-size:16px">4017F7</span><span style=";font-family:宋体;font-size:16px">，反汇编得到：</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F7  1083 F807754B</span><span style=";font-family:Verdana;font-size:12px">adc</span><span style=";font-family:Verdana;font-size:12px">byte ptr [ebx+4B7507F8], al</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">结果覆盖了</span><span style=";font-size:16px">4017F8</span><span style=";font-family:宋体;font-size:16px">，此结果作废。继续向上递减。</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F6  E8 1083F807</span><span style=";font-family:Verdana;font-size:12px">call</span><span style=";font-family:Verdana;font-size:12px">08389B0B</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">结果覆盖了</span><span style=";font-size:16px">4017F8</span><span style=";font-family:宋体;font-size:16px">，此结果作废。继续向上递减。</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F5  C1E8 10</span><span style=";font-family:Verdana;font-size:12px">shr</span><span style=";font-family:Verdana;font-size:12px">eax, 10</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F8  83F8 07</span><span style=";font-family:Verdana;font-size:12px">cmp</span><span style=";font-family:Verdana;font-size:12px">eax, 7</span></p><p><span style=";font-family:宋体;font-size:14px"></span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">结果可能正确，记录下上一条指令位址</span><span style=";font-size:16px">4017F5</span><span style=";font-family:宋体;font-size:16px">，命中率为</span><span style=";font-size:16px">1</span><span style=";font-family:宋体;font-size:16px">次。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">继续向上递减。</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F4  10C1</span><span style=";font-family:Verdana;font-size:12px">adc</span><span style=";font-family:Verdana;font-size:12px">cl, al</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F6  E8 1083F807</span><span style=";font-family:Verdana;font-size:12px">call</span><span style=";font-family:Verdana;font-size:12px">08389B0B</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">覆盖了</span><span style=";font-size:16px">4017F8</span><span style=";font-family:宋体;font-size:16px">，此结果作废。继续向上递减。</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F3  45</span><span style=";font-family:Verdana;font-size:12px">inc</span><span style=";font-family:Verdana;font-size:12px">ebp</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F4  10C1</span><span style=";font-family:Verdana;font-size:12px">adc</span><span style=";font-family:Verdana;font-size:12px">cl, al</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F6  E8 1083F807</span><span style=";font-family:Verdana;font-size:12px">call</span><span style=";font-family:Verdana;font-size:12px">08389B0B</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">覆盖了</span><span style=";font-size:16px">4017F8</span><span style=";font-family:宋体;font-size:16px">，此结果作废。继续向上递减。</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F2  8B45 10</span><span style=";font-family:Verdana;font-size:12px">mov</span><span style=";font-family:Verdana;font-size:12px">eax, dword ptr [ebp+10]</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F5  C1E8 10</span><span style=";font-family:Verdana;font-size:12px">shr</span><span style=";font-family:Verdana;font-size:12px">eax, 10</span></p><p><span style=";font-family:Verdana;font-size:12px">004017F8  83F8 07</span><span style=";font-family:Verdana;font-size:12px">cmp</span><span style=";font-family:Verdana;font-size:12px">eax, 7</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">刚好得到</span><span style=";font-size:16px">4017F8</span><span style=";font-family:宋体;font-size:16px">，记录下</span><span style=";font-size:16px">4017F8</span><span style=";font-family:宋体;font-size:16px">的上一条指令是</span><span style=";font-size:16px">4017F5</span><span style=";font-family:宋体;font-size:16px">，因为刚刚记录命中了一次，因此当前的统计结果是：</span><span style=";font-size:16px">4017F8</span><span style=";font-family:宋体;font-size:16px">上一条指令</span><span style=";font-size:16px">4017F5</span><span style=";font-family:宋体;font-size:16px">，命中率</span><span style=";font-size:16px">2</span><span style=";font-family:宋体;font-size:16px">次。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">就这样继续不断递减地址，从递减后的地址向下反汇编，当结果刚好可以到达</span><span style=";font-size:16px">4017F8</span><span style=";font-family:宋体;font-size:16px">时记录下上一条指令位址。假设我们向上递减</span><span style=";font-size:16px">200</span><span style=";font-family:宋体;font-size:16px">字节，记录结果可能如下。</span></p><p><span style=";font-family:Verdana;font-size:12px">4017F5    </span><span style=";font-family:Verdana;font-size:12px">40</span><span style=";font-family:宋体;font-size:12px">次</span></p><p><span style=";font-family:Verdana;font-size:12px">XXXXXX    </span><span style=";font-family:Verdana;font-size:12px">1</span><span style=";font-family:宋体;font-size:12px">次</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">那么根据统计结果上看，上一条指令有很大可能是从</span><span style=";font-size:16px">4017F5</span><span style=";font-family:宋体;font-size:16px">开始，那么我就可以认为上一条指令是</span><span style=";font-size:16px">4017F5</span><span style=";font-family:宋体;font-size:16px">。当然这个结论可能不正确，因为这毕竟是统计学结果。如果想要得到更准确的结果，我们可以采样更多的数据，例如向上递减</span><span style=";font-size:16px">1000</span><span style=";font-family:宋体;font-size:16px">字节。以保证结果的可靠性。</span></p><h2><span style=";font-weight:bold;font-size:19px">2 </span><span style=";font-family:黑体;font-weight:bold;font-size:19px">调试控制台</span></h2><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">调试控制台是整个调试器的工作中心，这个控制台将响应用户的一切输入，完成用户所需的调试功能。</span></p><h3><span style=";font-weight:bold;font-size:16px">2.1 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">命令解析</span></h3><h4><span style=";font-weight:bold;font-size:16px">2.1.1 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">数据结构的设计</span></h4><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">我将所有命令统一定义在一张表里，这个表是如下的数据结构：</span></p><p><span style=";font-family:Verdana;font-size:12px">typedef struct{</span></p><p><span style=";font-family:Verdana;font-size:12px">CHAR *Cmd;</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">命令前缀</span></p><p><span style=";font-family:Verdana;font-size:12px">CHAR *Desc;</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">命令描述</span></p><p><span style=";font-family:Verdana;font-size:12px">CHAR *Usage;</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">命令用法描述</span></p><p><span style=";font-family:Verdana;font-size:12px">CHAR *Example;</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">命令用例</span></p><p><span style=";font-family:Verdana;font-size:12px">PCMD_HANDLER pHandler;</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">命令分发处理函数</span></p><p><span style=";font-family:Verdana;font-size:12px">}CMD_HELP, *PCMD_HELP;</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">这样我就可以把所有命令统一定义，如下所示：</span></p><p><span style=";font-family:Verdana;font-size:12px">CMD_HELP CmdHelp[] = {</span></p><p><span style=";font-family:Verdana;font-size:12px">{&quot;BC&quot;,&quot;Clear breakpoint&quot;,&quot;BC [*|id]&quot;,NULL,CmdClearBreakpoint},</span></p><p><span style=";font-family:Verdana;font-size:12px">{&quot;BL&quot;,&quot;List current breakpoints&quot;,&quot;No param for BL&quot;,NULL,CmdListBreakpoint},</span></p><p><span style=";font-family:Verdana;font-size:12px">{&quot;BPX&quot;,&quot;Breakpoint on execute&quot;,&quot;BPX [addr] if [condition] do [cmd]&quot;,&quot;bpx ntsetvaluekey if \&quot;[[esp+8]+4]==\&quot;imagepath\&quot;\&quot; do \&quot;? byte [esp+4]\&quot;\n&quot;,CmdSetSwBreakpoint},</span></p><p><span style=";font-family:Verdana;font-size:12px">{&quot;CPU&quot;,&quot;Display cpu registers information&quot;,&quot;No param for CPU&quot;,NULL,CmdDisplayCpuReg},</span></p><p><span style=";font-family:Verdana;font-size:12px">{&quot;!DB&quot;,&quot;Display physical memory(byte)&quot;,&quot;!DB [address]&quot;,&quot;!db 39000\n&quot;,CmdDisplayPhysicalMemoryByte},</span></p><p><span style=";font-family:Verdana;font-size:12px">{&quot;!DW&quot;,&quot;Display physical memory(word)&quot;,&quot;!DW [address]&quot;,&quot;!dw 39000\n&quot;,CmdDisplayPhysicalMemoryWord},</span></p><p><span style=";font-family:Verdana;font-size:12px">{&quot;!DD&quot;,&quot;Display physical memory(dword)&quot;,&quot;!DD [address]&quot;,&quot;!dd 39000\n&quot;,CmdDisplayPhysicalMemoryDword},</span></p><p><span style=";font-family:Verdana;font-size:12px">{&quot;DB&quot;,&quot;Display memory(byte)&quot;,&quot;DB [address|symbolname]&quot;,&quot;db [esp+4]\n&quot;,CmdDisplayMemoryByte},</span></p><p><span style=";font-family:Verdana;font-size:12px">{&quot;DW&quot;,&quot;Display memory(word)&quot;,&quot;DW [address|symbolname]&quot;,&quot;dw [esp+4]\n&quot;,CmdDisplayMemoryWord},</span></p><p><span style=";font-family:Verdana;font-size:12px">{&quot;DD&quot;,&quot;Display memory(dword)&quot;,&quot;DD [address|symbolname]&quot;,&quot;dd [esp+4]\n&quot;,CmdDisplayMemoryDword},</span></p><p><span style=";font-family:Verdana;font-size:12px">};</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">这样定义有以下几个好处：</span></p><p style="text-indent:32px"><span style=";font-size:16px">1</span><span style=";font-family:宋体;font-size:16px">、实现命令提示功能，例如输入一个</span><span style=";font-size:16px">B</span><span style=";font-family:宋体;font-size:16px">的时候，通过查这张表可以将所有</span><span style=";font-size:16px">B</span><span style=";font-family:宋体;font-size:16px">打头的指令列出来，让用户一目了然</span><span style=";font-size:16px">B</span><span style=";font-family:宋体;font-size:16px">打头的指令有哪些。</span></p><p style="text-indent:32px"><span style=";font-size:16px">2</span><span style=";font-family:宋体;font-size:16px">、当用户输入了一个确定的指令例如</span><span style=";font-size:16px">BPX</span><span style=";font-family:宋体;font-size:16px">时，可以将</span><span style=";font-size:16px">BPX</span><span style=";font-family:宋体;font-size:16px">的语法自动提示给用户。</span></p><p style="text-indent:32px"><span style=";font-size:16px">3</span><span style=";font-family:宋体;font-size:16px">、当用户输入</span><span style=";font-size:16px">H BPX</span><span style=";font-family:宋体;font-size:16px">请求</span><span style=";font-size:16px">BPX</span><span style=";font-family:宋体;font-size:16px">指令的用法时。可以将</span><span style=";font-size:16px">BPX</span><span style=";font-family:宋体;font-size:16px">指令的语法和用例打印出来。</span></p><p style="text-indent:32px"><span style=";font-size:16px">4</span><span style=";font-family:宋体;font-size:16px">、结构体定义了命令分发处理函数，例如输入</span><span style=";font-size:16px">BPX</span><span style=";font-family:宋体;font-size:16px">就可以跳转到</span><span style=";font-size:16px">BPX</span><span style=";font-family:宋体;font-size:16px">处理函数</span><span style=";font-size:16px">CmdSetSwBreakpoint</span><span style=";font-family:宋体;font-size:16px">，由</span><span style=";font-size:16px">BPX</span><span style=";font-family:宋体;font-size:16px">函数负责解析这个函数。输入</span><span style=";font-size:16px">BC</span><span style=";font-family:宋体;font-size:16px">则跳转到</span><span style=";font-size:16px">BC</span><span style=";font-family:宋体;font-size:16px">处理函数</span><span style=";font-size:16px">CmdClearBreakpoint</span><span style=";font-family:宋体;font-size:16px">中。</span></p><h4><span style=";font-weight:bold;font-size:16px">2.1.2 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">帮助信息与命令提示</span></h4><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">有了上述定义的表，就可以很方便地获取指令帮助信息和命令提示功能。只需枚举表项即可。</span></p><h4><span style=";font-weight:bold;font-size:16px">2.1.3 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">一般命令的解析</span></h4><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">首先对输入语句的开头进行判断，进入相应的命令处理函数中，继续分割出命令的所有参数，然后对参数进行数值转换处理，例如可能需要将字符串转换成</span><span style=";font-size:16px">10</span><span style=";font-family:宋体;font-size:16px">进制或</span><span style=";font-size:16px">16</span><span style=";font-family:宋体;font-size:16px">进制数值类型。最后实现该命令。</span></p><h4><span style=";font-weight:bold;font-size:16px">2.1.4 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">使用</span><span style=";font-weight:bold;font-size:16px">LL-1</span><span style=";font-family:黑体;font-weight:bold;font-size:16px">分析法计算表达式</span></h4><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">有些时候我们需要输入表达式，例如查看</span><span style=";font-size:16px">esi+14h</span><span style=";font-family:宋体;font-size:16px">处指针指向的内存数据，使用命令：</span></p><p><span style=";font-family:Verdana;font-size:12px">dd [esi+eax*4+14]</span></p><p style="text-indent:32px"><span style=";font-size:16px">[esi+eax*4+14]</span><span style=";font-family:宋体;font-size:16px">就是一个表达式，首先计算</span><span style=";font-size:16px">esi+eax*4+14</span><span style=";font-family:宋体;font-size:16px">，方括号表示对指标取值，得到该指针处的地址。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">对表达式的分析我使用了</span><span style=";font-size:16px">LL-1</span><span style=";font-family:宋体;font-size:16px">分析法：算法从左到右分析表达式，设置符号栈和值栈，例如对表达式</span><span style=";font-size:16px">[1+4]&gt;=45&amp;&amp;(([1+8]&lt;9)||([1+c]&amp;10))</span><span style=";font-family:宋体;font-size:16px">分析，步骤如下：</span></p><p><span style=";font-family:宋体;font-size:16px">表</span><span style=";font-size:16px">6-1</span><span style=";font-family:宋体;font-size:16px">：</span><span style=";font-size:16px">LL-1</span><span style=";font-family:宋体;font-size:16px">分析法计算步骤</span></p><table width="538"><tbody><tr style="height:21px"><td width="113" valign="top" style="padding: 0px 7px; border-width: 1px; border-color: windowtext;"><p><span style=";font-family:宋体;font-size:16px">符号栈</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-width: 1px; border-top-color: windowtext; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-family:宋体;font-size:16px">值栈</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-width: 1px; border-top-color: windowtext; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style="font-family:宋体;font-size:16px">串</span></p></td></tr><tr style="height:19px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">[</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><br  /></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1</span></p></td></tr><tr style="height:19px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">[</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">+4]&gt;=45&amp;&amp;(([1+8]&lt;9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:18px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">[ +</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">4]&gt;=45&amp;&amp;(([1+8]&lt;9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:18px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">[ +</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 4</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">]&gt;=45&amp;&amp;(([1+8]&lt;9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:17px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><br  /></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">[5]</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&gt;=45&amp;&amp;(([1+8]&lt;9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:16px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&gt;=</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">[5]</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">45&amp;&amp;(([1+8]&lt;9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:16px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&gt;=</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">[5] 45</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp;(([1+8]&lt;9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:15px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp;</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">(([1+8]&lt;9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:15px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; (</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">([1+8]&lt;9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:13px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( (</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">[1+8]&lt;9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:13px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( ( [</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1+8]&lt;9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:12px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( ( [</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 1</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">+8]&lt;9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:12px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( ( [ +</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 1 </span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">8]&lt;9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:11px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( ( [ +</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 1 8</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">]&lt;9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:10px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( (</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 [9]</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&lt;9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:20px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( ( &lt; </span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 [9]</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">9)||([1+c]&amp;10))</span></p></td></tr><tr style="height:19px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( ( &lt;</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 [9] 9</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">)||([1+c]&amp;10))</span></p></td></tr><tr style="height:18px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; (</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 0</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">||([1+c]&amp;10))</span></p></td></tr><tr style="height:18px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( ||</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 0 </span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">([1+c]&amp;10))</span></p></td></tr><tr style="height:17px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( || (</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 0</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">[1+c]&amp;10))</span></p></td></tr><tr style="height:17px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( || ( [</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 0</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1+c]&amp;10))</span></p></td></tr><tr style="height:19px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( || ( [</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 0 1</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">+c]&amp;10))</span></p></td></tr><tr style="height:20px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( || ( [ +</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 0 1</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">c]&amp;10))</span></p></td></tr><tr style="height:19px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( || ( [ +</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 0 1 c</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">]&amp;10))</span></p></td></tr><tr style="height:18px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( || (</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 0 1c</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;10))</span></p></td></tr><tr style="height:18px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( || ( &amp; </span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 0 1c</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">10))</span></p></td></tr><tr style="height:17px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( || ( &amp;</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 0 1c 10</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">))</span></p></td></tr><tr style="height:17px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp; ( ||</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 0 1</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">)</span></p></td></tr><tr style="height:19px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">&amp;&amp;</span></p></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1 1</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><br  /></td></tr><tr style="height:20px"><td width="113" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><br  /></td><td width="127" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p><span style=";font-size:16px">1</span></p></td><td width="298" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><br  /></td></tr></tbody></table><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">详细算法实现见</span><span style=";font-size:16px">exp.c</span><span style=";font-family:宋体;font-size:16px">和</span><span style=";font-size:16px">exp.h</span><span style=";font-family:宋体;font-size:16px">文件。</span></p><h3><span style=";font-weight:bold;font-size:16px">2.2 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">单步步入</span></h3><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">单步步入是单步执行的一种，他会让调试器跟踪进入到</span><span style=";font-size:16px">call</span><span style=";font-family:宋体;font-size:16px">指向的函数中。</span></p><h4><span style=";font-weight:bold;font-size:16px">2.2.1 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">设置单步</span></h4><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">首先设置一个全局变量表示当前正在进行单步，然后设置单步陷阱标志</span><span style=";font-size:16px">EFLAGS.TF</span><span style=";font-family:宋体;font-size:16px">，并备份当前屏幕。已备退出单步返回操作系统时恢复屏幕。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">需要注意的是，单步时需要清空客户机</span><span style=";font-size:16px">GUEST_INTERRUPTIBILITY_INFO</span><span style=";font-family:宋体;font-size:16px">域、</span><span style=";font-size:16px">GUEST_ACTIVITY_STATE</span><span style=";font-family:宋体;font-size:16px">域，否则在单步</span><span style=";font-size:16px">CLI</span><span style=";font-family:宋体;font-size:16px">指令后会死机。这个</span><span style=";font-size:16px">bug</span><span style=";font-family:宋体;font-size:16px">在</span><span style=";font-size:16px">hyperdbg</span><span style=";font-family:宋体;font-size:16px">中存在，我曾与</span><span style=";font-size:16px">hyperdbg</span><span style=";font-family:宋体;font-size:16px">作者讨论这个问题，最终在</span><span style=";font-size:16px">Intel</span><span style=";font-family:宋体;font-size:16px">手册中找到相关解释。</span></p><h4><span style=";font-weight:bold;font-size:16px">2.2.2 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">回应单步</span></h4><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">设置单步陷阱标志后，执行当前指令后会引发</span><span style=";font-size:16px">DEBUG</span><span style=";font-family:宋体;font-size:16px">异常，即单步异常。异常引发后进入我们的</span><span style=";font-size:16px">VM Exit</span><span style=";font-family:宋体;font-size:16px">处理函数中。我们判断当前为单步操作，进行相应的动作，例如显示反汇编代码，高亮当前汇编代码等等操作。</span></p><h4><span style=";font-weight:bold;font-size:16px">2.2.3 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">取消单步</span></h4><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">取消单步只需要撤销单步陷阱标志</span><span style=";font-size:16px">TF</span><span style=";font-family:宋体;font-size:16px">即可。</span></p><h3><span style=";font-weight:bold;font-size:16px">6.2.3 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">设置断点</span></h3><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">设置断点的原理是替换某个指令为</span><span style=";font-size:16px">INT 3</span><span style=";font-family:宋体;font-size:16px">指令，当程序执行到这个</span><span style=";font-size:16px">INT 3</span><span style=";font-family:宋体;font-size:16px">指令后就会断下来，调试器获得执行机会，继续这条指令的执行前需要恢复原指令，因为原指令已经被替换成了</span><span style=";font-size:16px">INT 3</span><span style=";font-family:宋体;font-size:16px">。</span></p><h4><span style=";font-weight:bold;font-size:16px">2.3.1 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">数据结构的设计</span></h4><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">我定义了如下的结构用于描述一个断点：</span></p><p><span style=";font-family:Verdana;font-size:12px">typedef struct{</span></p><p><span style=";font-family:Verdana;font-size:12px">ULONG ProcessCR3;</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">进程页目录</span></p><p><span style=";font-family:Verdana;font-size:12px">USHORT CodeSeg;</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">代码段</span></p><p><span style=";font-family:Verdana;font-size:12px">ULONG Address;</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">断点地址</span></p><p><span style=";font-family:Verdana;font-size:12px">CHAR OldOpcode;</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">断点位址处原指令备份</span></p><p><span style=";font-family:Verdana;font-size:12px">CHAR IfCondition[128];</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">条件表达式</span></p><p><span style=";font-family:Verdana;font-size:12px">CHAR DoCmd[128];</span><span style=";font-family:Verdana;font-size:12px">//</span><span style=";font-family:宋体;font-size:12px">满足条件后运行的语句</span></p><p><span style=";font-family:Verdana;font-size:12px">}SW_BP, *PSW_BP;</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">一般调试器允许设置的断点数量有限，数组即可满足我们的需求，定义一个全局数组用于保存当前所有的断点。</span></p><h4><span style=";font-weight:bold;font-size:16px">2.3.2 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">设置断点</span></h4><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">首先检查断点数组是否满，找到一个空项，填写相关信息诸如进程页目录，地址，备份原指令。最后将断点处第一个字节写入</span><span style=";font-size:16px">CC</span><span style=";font-family:宋体;font-size:16px">字节（</span><span style=";font-size:16px">INT 3</span><span style=";font-family:宋体;font-size:16px">指令）即可。</span></p><p><span style=";font-family:Verdana;font-size:12px">#define INT3_OPCODE</span><span style=";font-family:Verdana;font-size:12px">0xCC</span></p><h4><span style=";font-weight:bold;font-size:16px">2.3.3 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">回应断点</span></h4><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">当</span><span style=";font-size:16px">CPU</span><span style=";font-family:宋体;font-size:16px">执行</span><span style=";font-size:16px">INT 3</span><span style=";font-family:宋体;font-size:16px">指令后引发</span><span style=";font-size:16px">BREAKPOINT</span><span style=";font-family:宋体;font-size:16px">异常，即断点异常，然后进入我们的</span><span style=";font-size:16px">VM Exit</span><span style=";font-family:宋体;font-size:16px">处理函数，枚举断点数组，判断是否为我们的断点，如果不是则将异常投递回客户机交给客户机操作系统处理，如果是我们的断点，则做出相应动作诸如显示反汇编代码，高亮汇编代码等。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">当我们选择执行这个指令时，调试器将该断点处位址的原指令恢复，然后交给</span><span style=";font-size:16px">CPU</span><span style=";font-family:宋体;font-size:16px">继续运行这段代码。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">但是一旦断点被恢复为原指令后这个断点便不再生效，有时我们希望一个断点可以被多次触发。因此还需要做一些额外操作。我使用的方法是设置一个单步陷阱，当执行过被断点的指令后，调试器会再次获得执行机会，这时我们把上一条指令恢复成</span><span style=";font-size:16px">INT 3</span><span style=";font-family:宋体;font-size:16px">指令，这个断点就可以继续发挥作用了。</span></p><h4><span style=";font-weight:bold;font-size:16px">2.3.4 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">清除断点</span></h4><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">清除某一个断点，首先应当得到这个断点的位置，恢复该位置的指令，最后把对应的断点描述结构清空即可。</span></p><h3><span style=";font-weight:bold;font-size:16px">2.4 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">单步步过</span></h3><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">单步步过是单步执行的另一种，他不会让调试器跟踪进入到</span><span style=";font-size:16px">call</span><span style=";font-family:宋体;font-size:16px">指向的函数中。而是跳过</span><span style=";font-size:16px">call</span><span style=";font-family:宋体;font-size:16px">执行。</span></p><h4><span style=";font-weight:bold;font-size:16px">2.4.1 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">设置单步步过断点</span></h4><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">在单步非</span><span style=";font-size:16px">call</span><span style=";font-family:宋体;font-size:16px">指令时都是通过设置单步陷阱标志</span><span style=";font-size:16px">Eflags.TF</span><span style=";font-family:宋体;font-size:16px">来实现的，但是在设置标志前多一项工作：检查当前指令是否为</span><span style=";font-size:16px">call</span><span style=";font-family:宋体;font-size:16px">。如果当前指令为</span><span style=";font-size:16px">call</span><span style=";font-family:宋体;font-size:16px">，则不设置</span><span style=";font-size:16px">TF</span><span style=";font-family:宋体;font-size:16px">标志，而是将</span><span style=";font-size:16px">call</span><span style=";font-family:宋体;font-size:16px">指令的吓一跳指令设置为断点指令</span><span style=";font-size:16px">INT 3</span><span style=";font-family:宋体;font-size:16px">，这样当</span><span style=";font-size:16px">call</span><span style=";font-family:宋体;font-size:16px">执行完毕后就会触发断点异常，从而实现单步步过</span><span style=";font-size:16px">call</span><span style=";font-family:宋体;font-size:16px">的功能。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">设置断点需要一个结构体来描述一个断点信息以及备份指令，这个结构体其实就是</span><span style=";font-size:16px">SW_BP</span><span style=";font-family:宋体;font-size:16px">，只是换了一个名字，用另外一个数组来描述他。</span></p><h4><span style=";font-weight:bold;font-size:16px">2.4.2 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">回应断点及清除断点</span></h4><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">触发断点异常后首先检查是否为用户设置的断点，如果不是则检查是否为单步步过的断点。当属于单步步过的断点时，就自动恢复断点处的原指令，并删除该断点，因为这种断点我们只使用了一次，触发后就不再需要他了。</span></p><h2><span style=";font-weight:bold;font-size:19px">3 </span><span style=";font-family:黑体;font-weight:bold;font-size:19px">其它功能</span></h2><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">单步和断点功能是一个调试器最基本的功能，另外还应该有一些常用功能来辅助调试工作。</span></p><h3><span style=";font-weight:bold;font-size:16px">3.1 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">查看内存数据</span></h3><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">我一共实现了</span><span style=";font-size:16px">3</span><span style=";font-family:宋体;font-size:16px">个查看内存数据的指令分别是按位元组查看，按字查看，按双字查看。命令分别为</span><span style=";font-size:16px">DB</span><span style=";font-family:宋体;font-size:16px">、</span><span style=";font-size:16px">DW</span><span style=";font-family:宋体;font-size:16px">、</span><span style=";font-size:16px">DD</span><span style=";font-family:宋体;font-size:16px">。就是将某处内存读出并按照相应的格式输出即可。</span></p><h3><span style=";font-weight:bold;font-size:16px">3.2 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">查看页面信息</span></h3><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">页面信息功能可以查看某一个线性地址指向的物理内存地址，以及该页面的相关信息。通过查询</span><span style=";font-size:16px">PDE</span><span style=";font-family:宋体;font-size:16px">、</span><span style=";font-size:16px">PTE</span><span style=";font-family:宋体;font-size:16px">可以得到这些信息。</span></p><h3><span style=";font-weight:bold;font-size:16px">3.3 CallStack</span><span style=";font-family:黑体;font-weight:bold;font-size:16px">（堆栈回溯）</span></h3><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">堆栈回溯也是调试器的重要功能，当程序发生崩溃被调试器拦截时，我们希望得知是由哪个函数调用导致的崩溃，堆栈回溯这个功能就派上了用场。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">大部分</span><span style=";font-size:16px">x86</span><span style=";font-family:宋体;font-size:16px">编译器编译一个函数后，都生成了固定的函数帧头部，大致如下：</span></p><p><span style=";font-family:Verdana;font-size:12px">push</span><span style=";font-family:Verdana;font-size:12px">ebp</span></p><p><span style=";font-family:Verdana;font-size:12px">mov</span><span style=";font-family:Verdana;font-size:12px">esp,ebp</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">而且我们知道</span><span style=";font-size:16px">call</span><span style=";font-family:宋体;font-size:16px">指令的实现其实就是将返回地址压入堆栈并</span><span style=";font-size:16px">jmp</span><span style=";font-family:宋体;font-size:16px">到函数体。所以这样的函数帧头部会产生函数调用链。例如当</span><span style=";font-size:16px">A</span><span style=";font-family:宋体;font-size:16px">调用</span><span style=";font-size:16px">B</span><span style=";font-family:宋体;font-size:16px">，</span><span style=";font-size:16px">B</span><span style=";font-family:宋体;font-size:16px">调用</span><span style=";font-size:16px">C</span><span style=";font-family:宋体;font-size:16px">，在</span><span style=";font-size:16px">C</span><span style=";font-family:宋体;font-size:16px">中观察栈帧结构就如图<span style="font-family:Times New Roman">6</span></span><span style=";font-size:16px">-1</span><span style=";font-family:宋体;font-size:16px">所示：</span></p><p><img data-s="300,640" data-type="png" src="data:image/PNG;base64,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 " src="SeWfibBcBT0EbeMc47V0DsH8iaiaibiabHdkmiaibF4MkKPAHtEUOpHbdbuIu3lmficOmaoWLUXbZicO75zmB9yoRDjkVjg"  data-ratio="0.6064908722109533" data-w="493"  /><br  /><span style=";font-family:宋体;font-size:16px"> </span></p><p><span style=";font-family:宋体;font-size:16px">图</span><span style=";font-size:16px">6-1 </span><span style=";font-family:宋体;font-size:16px">堆栈结构图：</span><span style=";font-size:16px">A</span><span style=";font-family:宋体;font-size:16px">调用</span><span style=";font-size:16px">B</span><span style=";font-family:宋体;font-size:16px">，</span><span style=";font-size:16px">B</span><span style=";font-family:宋体;font-size:16px">调用</span><span style=";font-size:16px">C</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">因此，实现堆栈回溯只需要下面的代码即可完成：</span></p><p><span style=";font-family:Verdana;font-size:12px">while(EBP)</span></p><p><span style=";font-family:Verdana;font-size:12px">{</span></p><p><span style=";font-family:宋体;font-size:12px">返回地址</span><span style=";font-family:Verdana;font-size:12px"> = *(EBP+4);</span></p><p><span style=";font-family:宋体;font-size:12px">打印信息</span><span style=";font-family:Verdana;font-size:12px">;</span></p><p><span style=";font-family:Verdana;font-size:12px">EBP = *EBP;</span></p><p><span style=";font-family:Verdana;font-size:12px">}</span></p><h3><span style=";font-weight:bold;font-size:16px">3.4 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">查看</span><span style=";font-weight:bold;font-size:16px">CPU</span><span style=";font-family:黑体;font-weight:bold;font-size:16px">信息</span></h3><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">这个功能可以实现查看</span><span style=";font-size:16px">CPU</span><span style=";font-family:宋体;font-size:16px">通用寄存器、控制寄存器等常用寄存器的值，以及解析出控制寄存器相应控制位，并在屏幕上打印输出它们。</span></p><h3><span style=";font-weight:bold;font-size:16px">3.5 </span><span style=";font-family:黑体;font-weight:bold;font-size:16px">查看中断描述表</span></h3><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">这个功能可以读取当前</span><span style=";font-size:16px">CPU</span><span style=";font-family:宋体;font-size:16px">的中断描述表，并将对应的中断处理函数打印出来。</span></p><h2><span style=";font-weight:bold;font-size:19px">4 </span><span style=";font-family:黑体;font-weight:bold;font-size:19px">卸载调试器</span></h2><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">卸载调试器其实就是虚拟化框架的卸载，也就是将运行在虚拟</span><span style=";font-size:16px">CPU</span><span style=";font-family:宋体;font-size:16px">上的操作系统“解救”出来，将他放回物理</span><span style=";font-size:16px">CPU</span><span style=";font-family:宋体;font-size:16px">上运行。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">当位于虚拟</span><span style=";font-size:16px">CPU</span><span style=";font-family:宋体;font-size:16px">的操作系统执行我们调试器内核模块的</span><span style=";font-size:16px">module_exit</span><span style=";font-family:宋体;font-size:16px">函数时，会执行一个</span><span style=";font-size:16px">VMCALL</span><span style=";font-family:宋体;font-size:16px">指令，该指令引发</span><span style=";font-size:16px">VM Exit</span><span style=";font-family:宋体;font-size:16px">，进入到</span><span style=";font-size:16px">VM Exit</span><span style=";font-family:宋体;font-size:16px">处理函数，此时</span><span style=";font-size:16px">CPU</span><span style=";font-family:宋体;font-size:16px">模式为</span><span style=";font-size:16px">VMX root</span><span style=";font-family:宋体;font-size:16px">。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">此时我们要做的工作很简单。判断是否是请求卸载调试器，如果是，则删除调试器的所有断点，恢复虚拟</span><span style=";font-size:16px">CPU</span><span style=";font-family:宋体;font-size:16px">的各种控制寄存器，执行</span><span style=";font-size:16px">VMXOFF</span><span style=";font-family:宋体;font-size:16px">指令关闭虚拟</span><span style=";font-size:16px">CPU</span><span style=";font-family:宋体;font-size:16px">，然后跳回</span><span style=";font-size:16px">module_exit</span><span style=";font-family:宋体;font-size:16px">函数即可。</span></p><p style="text-indent:32px"><span style=";font-family:宋体;font-size:16px">这样之后操作系统就又重新回到物理</span><span style=";font-size:16px">CPU</span><span style=";font-family:宋体;font-size:16px">上面执行了，同样的道理，这就是</span><span style=";font-size:16px">CPU</span><span style=";font-family:宋体;font-size:16px">控制权的转移。</span></p><p><br  /></p>
                </div>
                

                
  <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display: none;"></div>


                
                <div class="read-more__area" id="js_more_read_area" style="display:none;">
                    
                </div>

                
                                <div class="reward_area tc reward_area_primary" id="js_preview_reward_author" style="display:none;">
                    <div class="reward-avatar" style="display: none;" id="js_preview_reward_author_avatar">
                        <img src="" alt="" id="js_preview_reward_author_head">
                    </div>
                    
                                        <div class="reward-author" id="js_preview_reward_author_name">mxp</div>
                                        <p class="reward_tips" id="js_preview_reward_author_wording" style="display:none;"></p>
                    <p class="reward_button_wrp">
                    
                      <span class="reward_pop_panel">
                        <img src="https://res.wx.qq.com/mpres/zh_CN/htmledition/pages/home/index/pic_mp_app4290ba.png" alt="">
                        <strong>扫一扫下载订阅号助手，用手机发文章</strong>
                      </span>
                        <a class="reward_button" id='js_preview_reward_author_link' href="##"><span id="js_preview_reward_link_text">赞赏</span></a>
                    </p>
                </div>

                <div class="reward_qrcode_area reward_area tc" id="js_preview_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                    <p id="js_preview_reward_ios_wording" class="reward_tips" style="display:none;"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" src="res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_reward_qrcode.2x42f400.png"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                            </div>
		<div class="comment">
			<h3 style="margin:26px 0;font-weight:100;padding-bottom:4px;border-bottom:1px solid #ccc;">精选留言</h3>
		    暂无...
		</div>
	</div>
	<div class='dy_all'>
		<a href='https://www.52pojie.cn/' target='_blank'>
			吾爱破解论坛
		</a>
	</div>
</body>