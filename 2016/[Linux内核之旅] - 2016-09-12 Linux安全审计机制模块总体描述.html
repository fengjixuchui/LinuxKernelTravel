<!DOCTYPE html>
<head>
	<meta http-equiv='Content-Type' content='text/html;charset=utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no'>
	<title>
		Linux安全审计机制模块总体描述
	</title>
	<script src='https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js'>
	</script>
	<style>
		a {color: #607fa6;text-decoration:none;word-wrap:break-word;word-break:break-all;}.rich_media_title{padding-bottom:10px;margin-bottom:14px;border-bottom:1px solid #e7e7eb;font-weight:400;} .rich_media_meta_list{font-size:14px;margin-bottom: 22px;}
		.rich_media_meta{display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:14px;}.rich_media_meta_text{color:#8c8c8c;color:rgba(0, 0, 0, 0.3)}.rich_media_meta_list
		em {font-style: normal;}@media screen and (max-width:768px){.rich_media{position:
		relative;padding: 20px 15px 15px;background-color: #fff;}}.rich_media_content{text-align:justify;} .rich_media_content * {max-width:100%!important;box-sizing: border-box!important;-webkit-box-sizing:
		border-box!important;word-wrap: break-word!important;}.rich_media_content
		blockquote {margin: 0;padding-left: 10px;border-left: 3px solid #dbdbdb;}.rich_media_content
		.list-paddingleft-2 {padding-left: 2.2em;}a.rich_media_meta_nickname{display: none;}@media screen and (min-width:1025px){.rich_media{position:relative;}a.rich_media_meta_nickname{display:inline-block!important;}span.rich_media_meta_nickname
		{display: inline-block!important;}.rich_media {width:677px;margin-left:auto;margin-right:auto;}}a.fwjm{font-size: 12px;color: #ececec;}.tenvideo_player {position: relative;width:
		100 %;height: 100 %;margin: auto;background: #000;}* {margin:0px;padding:0px;} body{line-height: 1.6;letter-spacing: .034em;}
		.dy_all {text-align: center;margin: 30px 0;} .dy_all a {display: inline-block;height:
		38px;line-height: 38px;padding: 0 18px;background-color: #009688;color:
		#fff;white-space: nowrap;font-size: 14px;border: none;border-radius: 2px;cursor:
		pointer;text-align: center;outline: 0;-webkit-appearance: none;transition:
		all .3s;-webkit-transition: all .3s;box-sizing: border-box;} img{max-width: 677px!important;}

		.crawler-info{padding: 8px 0;} .article-link>img{margin-left: 20px;width: 16px;}
		.comment-item::before,.comment-item::after{content:'';display:block;height:0;visibility:hidden;clear:both;*zoom:1;} .comment-item{margin-bottom:30px;}
		.avatar{width:12%; padding-right:10px;float:left;box-sizing:border-box;} .avatar img{width:100%;}
		.comment-body{float:left;width:88%;} .comment-body .comment-info{color:#b3b3b3;margin-bottom:4px;margin-top: -5px;} .comment-body .comment-info>span:last-child{float:right;} 
		.comment-author{border-left:4px solid green;padding-left:6px;margin:8px 0;}

		@media screen and (max-width: 420px) {.article-link>img {margin-left: 0px;}}
		@media screen and (min-width: 480px) {.avatar {width: 9%;}.comment-body {width: 91%;}}
	</style>
</head>
<body>
	<div id='js_article' class='rich_media'>
		<div class="crawler-info">
			<a href='https://www.52pojie.cn' class='fwjm' target='_blank'>
				提供的爬取软件来源于：52pojie.cn@夜泉 免费下载使用
			</a>
			<a href='https://mp.weixin.qq.com/s?__biz=MzI3NzA5MzUxNA==&amp;mid=2664603097&amp;idx=1&amp;sn=e647f6d3a47a7a52dea43f623b54eb38&amp;chksm=f04db03cc73a392a44184797ea85a3618087fda88ac30487a0b0042c545505342acc7b68a606&amp;scene=27#wechat_redirect&cpage=61' target='_blank' class="article-link">
				<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAQCAMAAABA3o1rAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjk4QUEzQzVDNkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjk4QUEzQzVENkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OThBQTNDNUE2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OThBQTNDNUI2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5TKSKsAAAAclBMVEUuLi77+/stLS1VVVXx8fFOTk7s7Ozt7e1qamp5eXlNTU2WlpZFRUU6Ojrq6urn5+d/f3/8/Pw9PT0/Pz+YmJg8PDyZmZlAQECfn5+QkJBBQUFra2vo6OhDQ0OSkpKenp5WVlY+Pj7r6+tpaWksLCz///9o6ILHAAAAJnRSTlP/////////////////////////////////////////////////AKd6gbwAAACNSURBVHjajJHpEoIwDISDVMotcnuCmLz/K9KCdlqO6v7p7Mw3yW4KxG85fnUkIVfZ5J0SsCtqcgRw0HzjQYY2AAOIdRuaK4ReAPJ5nmglL5qICahpU60C0uXguQ9TgIwGJoDnT9z/ABmxt60ot0N2CsDLfb9mvBxs9ql+n5o9bEDBgbif7/1F4g80CjAAqrVAnnsm5f8AAAAASUVORK5CYII=" />
			</a>
		</div>
		<div id="img-content">

                
                <h2 class="rich_media_title" id="activity-name">Linux安全审计机制模块总体描述</h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                            <span id="copyright_logo" class="rich_media_meta rich_media_meta_text meta_tag_text">原创：</span>
                                                                                        <span class="rich_media_meta rich_media_meta_text">
                                                        刘霞林
                                                    </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);">Linux内核之旅</a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">Linux内核之旅</strong>
                              <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">LinuxKernelTravel</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">Linux内核之旅</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>


                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2016-09-12</em>





                </div>

                
                
                                
                
                
                
                                                
                                <div class="rich_media_thumb_wrp" id="media">
                    
                                        
                                    </div>
                                                
                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <h1><span style="font-size: 16px; color: rgb(2, 30, 170);"><span style="font-size: 16px; font-family: 黑体; font-weight: bold;">1</span><strong><span style="font-size: 16px; font-family: 黑体;">总体描述</span></strong></span></h1><h2 style="margin-top:17px;margin-bottom:17px;margin-left:38px;line-height:172%"><span style="font-size: 16px; color: rgb(2, 30, 170);"><span style="color: rgb(2, 30, 170); font-family: 宋体; font-weight: bold; font-size: 20px;">1.1&nbsp;</span><strong><span style="color: rgb(2, 30, 170); font-size: 16px; font-family: 宋体;">概述</span></strong></span></h2><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">审计是事后认定违反安全规则的分析技术，安全审计为管理员在用户违反安全法则时提供及时的警告信息，实现对系统信息的追踪、审查、统计和报告等功能[1]。<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">linux</span>提供了用来记录系统安全事件的审计系统，审计系统包括用户空间审计系统和内核空间审计系统，用户空间审计系统由一些用户空间的审计程序组成，用来开启内核审计功能、设置审计规则和审计系统状态、接收内核审计系统发送来的审计消息并写入<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">log</span>文件，以及审计消息的检索和生成审计总结报告。内核审计系统用于产生和过滤内核的各种审计消息，本报告重点分析内核审计系统<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">[2]</span>。分析的内容包括：</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">1.审计消息的生成和发送；</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">2.审计消息的过滤；</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">3.对进程和系统调用的审计；</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">4.对文件或目录的审计。</span></p><h2 style="margin-top:17px;margin-bottom:17px;margin-left:38px;line-height:172%"><span style="font-size: 16px; color: rgb(2, 30, 170);"><span style="font-size: 16px; font-family: 宋体; font-weight: bold;">1.2&nbsp;</span><strong><span style="font-size: 16px; font-family: 宋体;">涉及到的源码范围说明</span></strong><strong><span style="font-size: 16px; font-family: 宋体;"></span></strong></span></h2><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">本文所涉及到的源码有以下文件：</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">linux/audit.h &nbsp;&nbsp;主要包括审计事件、规则域的定义和规则结构类型的定义以及部分钩子</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">函数的定义。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">kernel/audit.h &nbsp;包括审计状态的结构类型、规则链表条目、基于节点的哈希规则链表的定义和部分外部函数的声明。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">kernel/audit.c &nbsp;审计系统实现的主要文件，包括审计缓冲区的定义，表示审计系统状态的全局变量的定义，审计消息发送和接收所使用的等待队列的声明和审计消息生成和发送的函数<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">audit_log</span>、<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">audit_log_start</span>、<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">audit_log_format</span>和<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">audit_log_end</span>等函数的定义。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">kernel/auditsc.c &nbsp;对系统调用审计提供支持的文件，包括系统调用进入和退出时执行的函数，进程创建时执行规则过滤的函数和系统调用进入或退出时执行的规则过滤函数。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">kernel/auditfilter.c &nbsp;对规则过滤提供支持的文件，包括规则链表及其锁的定义，添加、删除规则的函数、对规则域表达式进行计算的函数以及根据<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">user</span>规则链表和<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">type</span>规则链表进行规则过滤的函数。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">kernel/audit_watch.c &nbsp;对<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">inode</span>监视提供支持的文件，包括审计监视相关数据结构的定义，审计监视处理实例的初始化函数和审计监视事件处理函数及添加、删除审计监视的函数等。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">linux/fs/notify中与<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">fsnotify</span>支持相关的文件<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">fsnotify.c</span>、<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">fsnotify.h</span>、<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">group.c</span>、<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">mark.c</span>、<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">inode_mark.c</span>。</span></p><h2 style="margin-top:17px;margin-bottom:17px;margin-left:38px;line-height:172%"><span style="font-size: 16px; color: rgb(2, 30, 170);"><span style="font-size: 16px; font-family: 宋体; font-weight: bold;">1.3&nbsp;</span><strong><span style="font-size: 16px; font-family: 宋体;">技术方案及原理</span></strong><strong><span style="font-size: 16px; font-family: 宋体;"></span></strong></span></h2><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">审计系统是评价计算机安全性的重要标准之一，审计系统提供了一种记录系统安全信息的方法。审计系统的审计信息包括:可被审计的事件名称、事件状态<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">(</span>成功或失败<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">)</span>和安全信息等<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">.</span></span></p><h3><span style="font-size: 16px;">1.3.1 Linux<span style="font-size: 16px; font-family: 宋体;">审计系统的架构</span></span></h3><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">Linux 审计系统子系统之间的关系如图<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">1-1</span>所示。应用程序 <span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">auditctl </span>用来设置审计消息过滤规则、查询内核审计系统状态等<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">,</span>它通过 <span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">netlink </span>机制与内核审计系统的 <span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">socket </span>线程进行双向通信。内核其他线程的审计信息由内核审计<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">API </span>先经过规则链表的过滤，然后写入<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">netlink</span>套接字缓冲区队列中，内核线程 <span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">kauditd </span>通过 <span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">netlink </span>机制将审计消息定向发送给用户空间的审计后台 <span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">auditd </span>的主线程<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">,auditd </span>主线程再通过事件队列将审计消息传给审计后台的写 <span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">log </span>文件线程，由写 <span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">log </span>文件线程将审计消息写入 <span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">log </span>文件<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">[2]</span>。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;"><img data-s="300,640" data-type="png" src="http://mmbiz.qpic.cn/mmbiz_png/SeWfibBcBT0H9iasNPH9RPkHiax636MJChzOXhdm3OVTA7jV6npQmJqN88s6NGaeIIOgVjdwtzOSwm0ZZSBjU1crg/0?wx_fmt=png" data-ratio="0.4991304347826087" data-w="575"  /><br  /></span></p><p style="text-indent: 7px; text-align: center;"><span style="font-family: 宋体; text-align: center; line-height: 1.6;">图</span><span style="font-family: 宋体; text-align: center; line-height: 1.6;">1-1 &nbsp;&nbsp;Linux审计系统的架构</span></p><h3><span style="font-size: 16px;">1.3.2 <span style="font-size: 16px; font-family: 宋体;">审计事件分类</span></span></h3><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">所有与安全相关的行为都被生成了相应的的审计消息，为了把审计消息准确地传送给目的用户，审计系统将系统的审计消息事件分为以下几大部分（数字表示审计事件号）：</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">1000~1099 用于审计系统的命令。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">1100~1199 用户空间可信的应用程序消息。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">1200~1299 审计后台进程的内部消息。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">1300~1399 审计事件消息。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">1400~1499 SELinux 使用的消息。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">1500~1599 内核 <span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">LSPP </span>事件。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">1600~1699 内核加密<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">(crypto)</span>事件。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">1700~1799 内核正常记录。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">1800~199 内核完整性事件。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">2000 用于其他没有分类的内核审计消息<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">(</span>假想<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">)</span>。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">2001~2099 未使用<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">(</span>内核<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">)</span>。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">2100~2199 用户空间正常记录。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">2200~2299 用户空间对正常记录相应的动作。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">2300~2399 用户空间产生的 <span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">LSPP </span>事件。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">2400~2499 用户空间加密事件。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">2500~2999 用户空间将来使用<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">(</span>可能是整数标签和相应的事件<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">)</span>。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">1000~1199 是内核和用户空间双向使用的，<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">1200~1299 </span>和 <span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">2100~2999 </span>是用户空间专有的，<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">1300~2099 </span>是内核<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">--&gt;</span>用户空间通信用的。事件的定义在内核和用户空间的审计系统都是一致的。内核审计系统根据审计事件执行相应的操作或者完成相应的审计消息过滤。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">内核审计系统将审计消息写入审计缓冲区，然后通过netlink机制将消息发往用户空间后台进程，因此，每个审计缓冲区都对应着一个<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">netlink</span>套接字缓冲区，<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">netlink</span>套接字缓冲区用来存储用于发送的审计消息记录。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">每条审计消息在送往审计缓冲区时，需要查看是否有空闲缓冲区，如果缓冲区全满，则当前进程阻塞自己等待审计后台进程auditd取走至少一条消息时才能进行发送，另一方面，当审计后台进程存在时，审计消息被发送给审计后台<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">auditd,</span>否则，则由<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">printk</span>发送给日志后台进程，由日志后台将审计消息作为普通的日志记录存放在日志文件中。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">在内核的其它部分会频繁地记录安全审计事件，为了方便用户查看自己关心的审计消息，必须对审计消息进行过滤。在Linux审计系统中，提供了设置审计规则的<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">auditctl</span>工具，在<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">auditctl</span>设置的规则传入内核保存在规则链表上生成审计消息前，必须先经过规则链表的过滤，只有消息是符合某条规则的才会生成这条消息。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">对于进程的审计，系统调用的审计是在系统调用的入口和出口处加上审计函数，内核函数的审计是在函数内部的审计点加上审计hook 函数，这些审计函数将需要截获的消息通过规则过滤后，填充到审计上下文，在系统调用退出时，进程将审计上下文发送给审计后台。 有关进程审计的信息，存放在进程审计上下文中。 每当进程进入系统调用和退出系统调用时<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">,</span>使用审计上下文记录系统调用进入和退出的各种属性数据，如：时间戳、系统调用号、系统调用参数等。审计上下文还通过进程审计辅助数据记录进程运行中的各种关键数据的审计信息（比如进程打开的文件的<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">inode</span>号和所在设备号）。对于系统调用来说，审计上下文只能记录系统调用进入和退出时的审计信息，审计上下文所描述的数据在系统调用退出时通过内核审计系统发送给审计后台后，审计上下文就可以清空，为下次系统调用做好准备。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">对于文件系统的审计，在新版本的的内核中，不再使用inotify来监视文件系统的变化，而是直接使用文件系统监视变化的框架<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">fsnotify</span>来进行文件系统的监视，包括对目录的监视和对文件的监视。对文件系统的审计是借助于<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">fsnotify</span>机制完成的。<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">fsnotify</span>负责监视文件的变化，然后由审计系统生成相关的审计消息。和进程一样，为了截获文件系统的变化，<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">fsnotify</span>机制在文件系统的各个操作函数中加入了 <span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">hook </span>函数，当文件系统调用了这些操作函数改变了文件系统中的文件或目录时，就调用 <span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">hook</span>函数发出相应的事件。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">fsnotify采用事件模型来监视和处理文件系统的变化。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">fsnotify监视审计事件并处理审计事件的过程如图<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">2-1</span>所示。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;"><img data-s="300,640" data-type="png" src="http://mmbiz.qpic.cn/mmbiz_png/SeWfibBcBT0H9iasNPH9RPkHiax636MJChzRRsoB4XicxiaUf4bwPZplbnS2IU7QlYbm70Ed5ylxq97GZib36f0tGx2g/0?wx_fmt=png" data-ratio="0.44761904761904764" data-w="420"  /><br  /></span></p><p style="text-align:center"><span style="line-height: 1.6; font-family: 宋体;">图</span><span style="font-family: 宋体; font-size: 12px;">1-2</span><span style="font-size: 12px;">&nbsp;&nbsp;fsnotify<span style="font-size: 16px; font-family: 宋体;">事件模型</span></span></p><p><span style="font-family: 宋体; font-size: 16px;">下表1-1是<span style="font-size: 16px; font-family: &#39;Times New Roman&#39;;">fsnotify</span>所能监视的各种事件类型。</span></p><table width="568"><tbody><tr><td width="284" valign="top" style="padding: 0px 7px; border-width: 1px; border-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">事件名</span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-width: 1px; border-top-color: windowtext; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">事件描述</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_ACCESS </span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">文件被访问</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_MODIFY </span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">文件被修改</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_ATTRIB </span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 14px;">文件属性被修改，如：uid、gid、日戳等</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_CLOSE_WRITE</span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">写文件操作结束时关闭描述符</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_CLOSE_NOWRITE </span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">关闭了不可写文件描述符</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_OPEN </span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">打开文件</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_MOVED_FROM </span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">文件被移走</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_MOVED_TO </span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">文件被移来</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_DELETE </span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">文件被删除</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_CREATE </span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">创建新文件系统对象</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_DELETE_SELF </span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 14px;">删除了文件自己&nbsp;</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_MOVE_SELF </span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">移动了文件自己</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_CLOSE</span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 14px;">关闭文件，等价于&nbsp;FS_CLOSE_WRITE &nbsp;| FS_CLOSE_NOWRITE</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_MOVE </span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 14px;">移动文件，等价于FS_MOVED_FROM | FS_MOVED_TO</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_UNMOUNT </span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 14px;">文件系统被卸载(umount)</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_Q_OVERFLOW </span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">事件排队溢出</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_IGNORED</span></p><p style="text-align:center"><span style="font-size: 16px;">&nbsp;</span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">文件被忽略</span></p></td></tr><tr><td width="284" valign="top" style="padding: 0px 7px; border-left-width: 1px; border-left-color: windowtext; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">FS_EVENT_ON_CHILD</span></p></td><td width="284" valign="top" style="padding: 0px 7px; border-left-style: none; border-right-width: 1px; border-right-color: windowtext; border-top-style: none; border-bottom-width: 1px; border-bottom-color: windowtext;"><p style="text-align:center"><span style="font-size: 16px;">孩子节点发生的事件</span></p></td></tr></tbody></table><p style="text-indent:0;text-align:center;line-height:24px"><span style="font-size: 16px;"><span style="font-size: 16px; font-family: 宋体;">表</span><span style="font-family: 宋体; font-size: 12px;">1</span><span style="font-size: 12px;">-1<span style="font-size: 16px; font-family: 宋体;">文件系统变化发起的事件说明</span></span></span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">对于审计系统来说，事件处理的过程是类似的，都是将发生的事件信息以审计消息的方式发送给用户，所以审计事件都是交给同一个审计监视处理来处理。</span></p><p style=";line-height:24px"><span style="font-family: 宋体; font-size: 16px;">审计系统关心的事件只是fsnotify定义的事件的一部分，目前审计系统只监视六种审计事件：文件系统对象的创建、删除、移动、文件系统对象自身的删除、移动和孩子节点发生了变化。</span></p><p><br  /></p>
                </div>
                

                
  <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display: none;"></div>


                
                <div class="read-more__area" id="js_more_read_area" style="display:none;">
                    
                </div>

                
                                <div class="reward_area tc reward_area_primary" id="js_reward_area" style="display:none;">
                    <div class="reward-avatar" style="display: none;" id="js_reward_avatar">
                        <img src="" alt="" id="js_reward_author_head">
                    </div>
                    
                                        <div class="reward-author" style="display: none;" id="js_reward_author">刘霞林</div>
                                                            <p class="reward_button_wrp">
                      <span id="js_author_reward_qrcode" class="reward_pop_panel">
                        <img id="js_author_reward_qrcode_img" src="" alt="赞赏二维码">
                        <strong>微信扫一扫赞赏作者</strong>
                      </span>
                        <a class="reward_button" id='js_reward_link' href="##"><span id="js_reward_link_text">赞赏</span></a>
                    </p>
                    <div id="js_reward_inner" class="reward_area_inner" style="display:none;">
                        <p class="weui-loadmore weui-loadmore_line reward_user_tips" id="js_reward_total_parent">
                          <span class="weui-loadmore__tips">
                            <a href="javascript:;" id="js_reward_total"></a>&nbsp;<span id="js_reward_total_text">人赞赏</span>
                        </span>
                        </p>
                        
                        <div id="js_reward_list" class="reward_user_list"></div>
                        <div id="js_reward_pagination" class="simple_pagination" style="display: none;">
                          <button disabled class="btn_sp_prev js_reward_pagination_prev">上一页</button>
                          <span class="sp_page_num_area">
                            <a class="sp_page_current js_reward_pagination_curpage" href="javascript:;">1</a>&#47;<span class="sp_page_num js_reward_pagination_totalpage">3</span>
                          </span>
                          <button class="btn_sp_next js_reward_pagination_next">下一页</button>
                        </div>
                    </div>
                </div>
                                            </div>
		<div class="comment">
			<h3 style="margin:26px 0;font-weight:100;padding-bottom:4px;border-bottom:1px solid #ccc;">精选留言</h3>
		    暂无...
		</div>
	</div>
	<div class='dy_all'>
		<a href='https://www.52pojie.cn/' target='_blank'>
			吾爱破解论坛
		</a>
	</div>
</body>