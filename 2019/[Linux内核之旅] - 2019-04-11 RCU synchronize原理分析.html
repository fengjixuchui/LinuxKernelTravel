<!DOCTYPE html>
<head>
	<meta http-equiv='Content-Type' content='text/html;charset=utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no'>
	<title>
		RCU synchronize原理分析
	</title>
	<script src='https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js'>
	</script>
	<style>
		a {color: #607fa6;text-decoration:none;word-wrap:break-word;word-break:break-all;}.rich_media_title{padding-bottom:10px;margin-bottom:14px;border-bottom:1px solid #e7e7eb;font-weight:400;} .rich_media_meta_list{font-size:14px;margin-bottom: 22px;}
		.rich_media_meta{display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:14px;}.rich_media_meta_text{color:#8c8c8c;color:rgba(0, 0, 0, 0.3)}.rich_media_meta_list
		em {font-style: normal;}@media screen and (max-width:768px){.rich_media{position:
		relative;padding: 20px 15px 15px;background-color: #fff;}}.rich_media_content{text-align:justify;} .rich_media_content * {max-width:100%!important;box-sizing: border-box!important;-webkit-box-sizing:
		border-box!important;word-wrap: break-word!important;}.rich_media_content
		blockquote {margin: 0;padding-left: 10px;border-left: 3px solid #dbdbdb;}.rich_media_content
		.list-paddingleft-2 {padding-left: 2.2em;}a.rich_media_meta_nickname{display: none;}@media screen and (min-width:1025px){.rich_media{position:relative;}a.rich_media_meta_nickname{display:inline-block!important;}span.rich_media_meta_nickname
		{display: inline-block!important;}.rich_media {width:677px;margin-left:auto;margin-right:auto;}}a.fwjm{font-size: 12px;color: #ececec;}.tenvideo_player {position: relative;width:
		100 %;height: 100 %;margin: auto;background: #000;}* {margin:0px;padding:0px;} body{line-height: 1.6;letter-spacing: .034em;}
		.dy_all {text-align: center;margin: 30px 0;} .dy_all a {display: inline-block;height:
		38px;line-height: 38px;padding: 0 18px;background-color: #009688;color:
		#fff;white-space: nowrap;font-size: 14px;border: none;border-radius: 2px;cursor:
		pointer;text-align: center;outline: 0;-webkit-appearance: none;transition:
		all .3s;-webkit-transition: all .3s;box-sizing: border-box;} img{max-width: 677px!important;}

		.crawler-info{padding: 8px 0;} .article-link>img{margin-left: 20px;width: 16px;}
		.comment-item::before,.comment-item::after{content:'';display:block;height:0;visibility:hidden;clear:both;*zoom:1;} .comment-item{margin-bottom:30px;}
		.avatar{width:12%; padding-right:10px;float:left;box-sizing:border-box;} .avatar img{width:100%;}
		.comment-body{float:left;width:88%;} .comment-body .comment-info{color:#b3b3b3;margin-bottom:4px;margin-top: -5px;} .comment-body .comment-info>span:last-child{float:right;} 
		.comment-author{border-left:4px solid green;padding-left:6px;margin:8px 0;}

		@media screen and (max-width: 420px) {.article-link>img {margin-left: 0px;}}
		@media screen and (min-width: 480px) {.avatar {width: 9%;}.comment-body {width: 91%;}}
	</style>
</head>
<body>
	<div id='js_article' class='rich_media'>
		<div class="crawler-info">
			<a href='https://www.52pojie.cn' class='fwjm' target='_blank'>
				提供的爬取软件来源于：52pojie.cn@夜泉 免费下载使用
			</a>
			<a href='https://mp.weixin.qq.com/s?__biz=MzI3NzA5MzUxNA==&amp;mid=2664606377&amp;idx=1&amp;sn=03f0795ad80a6ee6eeb421d10c6b118d&amp;chksm=f04d874cc73a0e5a1689a868c1c18b0c2cdcc334683f3786c11157221dc36e1b6363851dcc2a&amp;scene=27#wechat_redirect&cpage=6' target='_blank' class="article-link">
				<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAQCAMAAABA3o1rAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjk4QUEzQzVDNkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjk4QUEzQzVENkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OThBQTNDNUE2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OThBQTNDNUI2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5TKSKsAAAAclBMVEUuLi77+/stLS1VVVXx8fFOTk7s7Ozt7e1qamp5eXlNTU2WlpZFRUU6Ojrq6urn5+d/f3/8/Pw9PT0/Pz+YmJg8PDyZmZlAQECfn5+QkJBBQUFra2vo6OhDQ0OSkpKenp5WVlY+Pj7r6+tpaWksLCz///9o6ILHAAAAJnRSTlP/////////////////////////////////////////////////AKd6gbwAAACNSURBVHjajJHpEoIwDISDVMotcnuCmLz/K9KCdlqO6v7p7Mw3yW4KxG85fnUkIVfZ5J0SsCtqcgRw0HzjQYY2AAOIdRuaK4ReAPJ5nmglL5qICahpU60C0uXguQ9TgIwGJoDnT9z/ABmxt60ot0N2CsDLfb9mvBxs9ql+n5o9bEDBgbif7/1F4g80CjAAqrVAnnsm5f8AAAAASUVORK5CYII=" />
			</a>
		</div>
		<div id="img-content">

                
                <h2 class="rich_media_title" id="activity-name">RCU synchronize原理分析</h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                                                                            <span class="rich_media_meta rich_media_meta_text">
                                                        ​itrocker
                                                    </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);">Linux内核之旅</a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">Linux内核之旅</strong>
                              <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">LinuxKernelTravel</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">Linux内核之旅</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>


                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2019-04-11</em>





                </div>

                
                
                                
                
                
                
                                                
                                                                
                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">RCU（Read-Copy&nbsp;Update）是Linux内核比较成熟的新型读写锁，具有较高的读写并发性能，常常用在需要互斥的性能关键路径。在kernel中，rcu有tiny&nbsp;rcu和tree&nbsp;rcu两种实现，tiny&nbsp;rcu更加简洁，通常用在小型嵌入式系统中，tree&nbsp;rcu则被广泛使用在了server,&nbsp;desktop以及android系统中。本文将以tree&nbsp;rcu为分析对象。</span><br  /></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><br  /></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 20px;"><strong>1&nbsp;</strong><strong>如何度过宽限期</strong></span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">RCU的核心理念是读者访问的同时，写者可以更新访问对象的副本，但写者需要等待所有读者完成访问之后，才能删除老对象。这个过程实现的关键和难点就在于如何判断所有的读者已经完成访问。通常把写者开始更新，到所有读者完成访问这段时间叫做宽限期（Grace&nbsp;Period）。内核中实现宽限期等待的函数是synchronize_rcu。</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 18px;"><strong>1.1&nbsp;</strong><strong>读者锁的标记</strong></span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">在普通的TREE&nbsp;RCU实现中，rcu_read_lock和rcu_read_unlock的实现非常简单，分别是关闭抢占和打开抢占：</span></p><pre class="prettyprint lang-cpp linenums" style="border-width: 0px;border-style: solid;border-color: rgb(136, 136, 136);font-size: 12px;overflow: auto;margin-top: 5px;margin-bottom: 5px;line-height: 16px;color: rgb(50, 50, 50);text-align: left;background-color: rgb(255, 255, 255);"><ol class=" list-paddingleft-2" style=""><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">staticinlinevoid</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> __rcu_read_lock</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">void</span><span style="font-size: 16px;color: rgb(102, 102, 0);">)</span></span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">{</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">preempt_disable</span><span style="font-size: 16px;color: rgb(102, 102, 0);">();</span></span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">}</span></p></li><li><p><span style="color: rgb(0, 0, 0);font-size: 16px;">&nbsp;</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">staticinlinevoid</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> __rcu_read_unlock</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">void</span><span style="font-size: 16px;color: rgb(102, 102, 0);">)</span></span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">{</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">preempt_enable</span><span style="font-size: 16px;color: rgb(102, 102, 0);">();</span></span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">}</span></p></li></ol></pre><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">这时是否度过宽限期的判断就比较简单：每个CPU都经过一次抢占。因为发生抢占，就说明不在rcu_read_lock和rcu_read_unlock之间，必然已经完成访问或者还未开始访问。</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 18px;"><strong>1.2&nbsp;</strong><strong>每个CPU</strong><strong>度过quiescnet state</strong></span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">接下来我们看每个CPU上报完成抢占的过程。</span><span style="font-size: 16px;">kernel把这个完成抢占的状态称为quiescent&nbsp;state。</span><span style="font-size: 16px;">每个CPU在时钟中断的处理函数中，都会判断当前CPU是否度过quiescent&nbsp;state。</span></p><pre class="prettyprint lang-cpp linenums" style="border-width: 0px;border-style: solid;border-color: rgb(136, 136, 136);font-size: 12px;overflow: auto;margin-top: 5px;margin-bottom: 5px;line-height: 16px;color: rgb(50, 50, 50);text-align: left;background-color: rgb(255, 255, 255);"><ol class=" list-paddingleft-2" style=""><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">void</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> update_process_times</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(102, 0, 102);">int</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> user_tick</span><span style="font-size: 16px;color: rgb(102, 102, 0);">)</span></span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">{</span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">......</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">rcu_check_callbacks</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">cpu</span><span style="font-size: 16px;color: rgb(102, 102, 0);">,</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> user_tick</span><span style="font-size: 16px;color: rgb(102, 102, 0);">);</span></span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">......</span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">}</span></p></li><li><p><span style="color: rgb(0, 0, 0);font-size: 16px;">&nbsp;</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">void</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> rcu_check_callbacks</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(102, 0, 102);">int</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> cpu</span><span style="font-size: 16px;color: rgb(102, 102, 0);">,</span><span style="font-size: 16px;color: rgb(102, 0, 102);">int</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> user</span><span style="font-size: 16px;color: rgb(102, 102, 0);">)</span></span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">{</span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">......</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">if</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">user </span><span style="font-size: 16px;color: rgb(102, 102, 0);">||</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> rcu_is_cpu_rrupt_from_idle</span><span style="font-size: 16px;color: rgb(102, 102, 0);">()){</span></span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">/*在用户态上下文，或者idle上下文，说明已经发生过抢占*/</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">rcu_sched_qs</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">cpu</span><span style="font-size: 16px;color: rgb(102, 102, 0);">);</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">rcu_bh_qs</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">cpu</span><span style="font-size: 16px;color: rgb(102, 102, 0);">);</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(102, 102, 0);">}</span><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">elseif</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(!</span><span style="font-size: 16px;color: rgb(0, 0, 0);">in_softirq</span><span style="font-size: 16px;color: rgb(102, 102, 0);">()){</span></span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">/*仅仅针对使用rcu_read_lock_bh类型的rcu，不在softirq，</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;"> *说明已经不在read_lock关键区域*/</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">rcu_bh_qs</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">cpu</span><span style="font-size: 16px;color: rgb(102, 102, 0);">);</span></span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">}</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">rcu_preempt_check_callbacks</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">cpu</span><span style="font-size: 16px;color: rgb(102, 102, 0);">);</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">if</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">rcu_pending</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">cpu</span><span style="font-size: 16px;color: rgb(102, 102, 0);">))</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">invoke_rcu_core</span><span style="font-size: 16px;color: rgb(102, 102, 0);">();</span></span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">......</span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">}</span></p></li></ol></pre><p style="text-indent: 2em;"><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;text-align: left;background-color: rgb(255, 255, 255);text-indent: 28px;line-height: 1.5;">这里补充一个细节说明，Tree&nbsp;RCU有多个类型的RCU&nbsp;State，用于不同的RCU场景，包括rcu_sched_state、rcu_bh_state和rcu_preempt_state。不同的场景使用不同的RCU&nbsp;API，度过宽限期的方式就有所区别。例如上面代码中的rcu_sched_qs和rcu_bh_qs，就是为了标记不同的state度过quiescent&nbsp;state。普通的RCU例如内核线程、系统调用等场景，使用rcu_read_lock或者rcu_read_lock_sched，他们的实现是一样的；软中断上下文则可以使用rcu_read_lock_bh，使得宽限期更快度过。</span></span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">细分这些场景是为了提高RCU的效率。</span><span style="font-size: 16px;">rcu_preempt_state将在下文进行说明。</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 18px;"><strong>1.3&nbsp;</strong><strong>汇报宽限期度过</strong></span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">每个CPU度过quiescent&nbsp;state之后，需要向上汇报直至所有CPU完成quiescent&nbsp;state，从而标识宽限期的完成，这个汇报过程在软中断RCU_SOFTIRQ中完成。</span><span style="font-size: 16px;">软中断的唤醒则是在上述的时钟中断中进行。</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">update_process_times</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">&nbsp;&nbsp;&nbsp; -&gt; rcu_check_callbacks</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt; invoke_rcu_core</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">RCU_SOFTIRQ软中断处理的汇报流程如下：</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">rcu_process_callbacks</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">&nbsp;&nbsp;&nbsp; -&gt; __rcu_process_callbacks</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt; rcu_check_quiescent_state</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt; rcu_report_qs_rdp</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt; rcu_report_qs_rnp</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">其中rcu_report_qs_rnp是从叶子节点向根节点的遍历过程，同一个节点的子节点都通过quiescent&nbsp;state后，该节点也设置为通过。</span></p><p style="text-align: center;"><img class="rich_pages" data-copyright="0" data-ratio="0.6007827788649707" data-s="300,640" src="data:image/PNG;base64,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 " src="SeWfibBcBT0GEgozMo2sxTU4aE8KwCsWuks7tAaUVHkZ5ztLtrLhh1ibUhHg8cUbGDx7qQGPkBIwP78BYib1j2q2A"  data-type="png" data-w="511" style=""  /></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">这个树状的汇报过程，也就是“Tree&nbsp;RCU”这个名字得来的缘由。</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">树结构每层的节点数量和叶子节点数量由一系列的宏定义来决定：</span></p><pre class="prettyprint lang-cpp linenums" style="border-width: 0px;border-style: solid;border-color: rgb(136, 136, 136);font-size: 12px;overflow: auto;margin-top: 5px;margin-bottom: 5px;line-height: 16px;color: rgb(50, 50, 50);text-align: left;background-color: rgb(255, 255, 255);"><ol class=" list-paddingleft-2" style=""><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(136, 0, 0);">#define</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> MAX_RCU_LVLS </span><span style="font-size: 16px;color: rgb(0, 102, 102);">4</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(136, 0, 0);">#define</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> RCU_FANOUT_1      </span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">CONFIG_RCU_FANOUT_LEAF</span><span style="font-size: 16px;color: rgb(102, 102, 0);">)</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(136, 0, 0);">#define</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> RCU_FANOUT_2      </span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">RCU_FANOUT_1 </span><span style="font-size: 16px;color: rgb(102, 102, 0);">*</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> CONFIG_RCU_FANOUT</span><span style="font-size: 16px;color: rgb(102, 102, 0);">)</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(136, 0, 0);">#define</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> RCU_FANOUT_3      </span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">RCU_FANOUT_2 </span><span style="font-size: 16px;color: rgb(102, 102, 0);">*</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> CONFIG_RCU_FANOUT</span><span style="font-size: 16px;color: rgb(102, 102, 0);">)</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(136, 0, 0);">#define</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> RCU_FANOUT_4      </span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">RCU_FANOUT_3 </span><span style="font-size: 16px;color: rgb(102, 102, 0);">*</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> CONFIG_RCU_FANOUT</span><span style="font-size: 16px;color: rgb(102, 102, 0);">)</span></span></p></li><li><p><span style="color: rgb(0, 0, 0);font-size: 16px;">&nbsp;</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#if NR_CPUS &lt;= RCU_FANOUT_1</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define RCU_NUM_LVLS      1</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_0      1</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_1      (NR_CPUS)</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_2      0</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_3      0</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_4      0</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(136, 0, 0);">#elif</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> NR_CPUS </span><span style="font-size: 16px;color: rgb(102, 102, 0);">&lt;=</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> RCU_FANOUT_2</span></span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define RCU_NUM_LVLS      2</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_0      1</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_1      DIV_ROUND_UP(NR_CPUS, RCU_FANOUT_1)</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_2      (NR_CPUS)</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_3      0</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_4      0</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(136, 0, 0);">#elif</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> NR_CPUS </span><span style="font-size: 16px;color: rgb(102, 102, 0);">&lt;=</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> RCU_FANOUT_3</span></span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define RCU_NUM_LVLS      3</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_0      1</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_1      DIV_ROUND_UP(NR_CPUS, RCU_FANOUT_2)</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_2      DIV_ROUND_UP(NR_CPUS, RCU_FANOUT_1)</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_3      (NR_CPUS)</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_4      0</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(136, 0, 0);">#elif</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> NR_CPUS </span><span style="font-size: 16px;color: rgb(102, 102, 0);">&lt;=</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> RCU_FANOUT_4</span></span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define RCU_NUM_LVLS      4</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_0      1</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_1      DIV_ROUND_UP(NR_CPUS, RCU_FANOUT_3)</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_2      DIV_ROUND_UP(NR_CPUS, RCU_FANOUT_2)</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_3      DIV_ROUND_UP(NR_CPUS, RCU_FANOUT_1)</span></p></li><li><p><span style="color: rgb(136, 0, 0);font-size: 16px;">#  define NUM_RCU_LVL_4      (NR_CPUS)</span><span style="color: rgb(136, 0, 0);"></span></p></li></ol></pre><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 18px;"><strong>1.4&nbsp;</strong><strong>宽限期的发起与完成</strong></span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">所有宽限期的发起和完成都是由同一个内核线程rcu_gp_kthread来完成。</span><span style="font-size: 16px;">通过判断rsp-&gt;gp_flags&nbsp;&amp;&nbsp;RCU_GP_FLAG_INIT来决定是否发起一个gp；</span><span style="font-size: 16px;">通过判断!</span><span style="font-size: 16px;">&nbsp;(rnp-&gt;qsmask)&nbsp;&amp;&amp;&nbsp;!</span><span style="font-size: 16px;">rcu_preempt_blocked_readers_cgp(rnp))来决定是否结束一个gp</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="text-indent: 28px;font-size: 16px;">发起一个GP时，rsp-&gt;gpnum++；</span><span style="text-indent: 28px;font-size: 16px;">结束一个GP时，rsp-&gt;completed&nbsp;=&nbsp;rsp-&gt;gpnum。</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 28px;"><span style="font-size: 16px;"></span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 18px;"><strong>1.5 rcu callbacks</strong><strong>处理</strong></span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">rcu的callback通常是在sychronize_rcu中添加的wakeme_after_rcu，也就是唤醒synchronize_rcu的进程，它正在等待GP的结束。</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; callbacks的处理同样在软中断RCU_SOFTIRQ中完成</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">rcu_process_callbacks</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">&nbsp;&nbsp;&nbsp; -&gt; __rcu_process_callbacks</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt; invoke_rcu_callbacks</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt; rcu_do_batch</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt; __rcu_reclaim</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">这里RCU的callbacks链表采用了一种分段链表的方式，整个callback链表，根据具体GP结束的时间，分成若干段：</span><span style="font-size: 16px;">nxtlist&nbsp;--&nbsp;*nxttail[RCU_DONE_TAIL]&nbsp;--&nbsp;*nxttail[RCU_WAIT_TAIL]&nbsp;--&nbsp;*nxttail[RCU_NEXT_READY_TAIL]&nbsp;--&nbsp;*nxttail[RCU_NEXT_TAIL]。</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">rcu_do_batch只处理nxtlist&nbsp;--&nbsp;*nxttail[RCU_DONE_TAIL]之间的callbacks。</span><span style="font-size: 16px;">每个GP结束都会重新调整callback所处的段位，每个新的callback将会添加在末尾，也就是*nxttail[RCU_NEXT_TAIL]。</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size: 20px;"><strong>2&nbsp;</strong><strong>可抢占的RCU</strong></span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">如果config文件定义了CONFIG_TREE_PREEMPT_RCU=y，那么sychronize_rcu将默认使用rcu_preempt_state。</span><span style="font-size: 16px;">这类rcu的特点就在于read_lock期间是允许其它进程抢占的，因此它判断宽限期度过的方法就不太一样。</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">从rcu_read_lock和rcu_read_unlock的定义就可以知道，TREE_PREEMPT_RCU并不是以简单的经过抢占为CPU渡过GP的标准，而是有个rcu_read_lock_nesting计数</span></p><pre class="prettyprint lang-cpp linenums" style="border-width: 0px;border-style: solid;border-color: rgb(136, 136, 136);font-size: 12px;overflow: auto;margin-top: 5px;margin-bottom: 5px;line-height: 16px;color: rgb(50, 50, 50);text-align: left;background-color: rgb(255, 255, 255);"><ol class=" list-paddingleft-2" style=""><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">void</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> __rcu_read_lock</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">void</span><span style="font-size: 16px;color: rgb(102, 102, 0);">)</span></span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">{</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">current</span><span style="font-size: 16px;color: rgb(102, 102, 0);">-&gt;</span><span style="font-size: 16px;color: rgb(0, 0, 0);">rcu_read_lock_nesting</span><span style="font-size: 16px;color: rgb(102, 102, 0);">++;</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">barrier</span><span style="font-size: 16px;color: rgb(102, 102, 0);">();</span><span style="font-size: 16px;color: rgb(136, 0, 0);">/* critical section after entry code. */</span></span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">}</span></p></li><li><p><span style="color: rgb(0, 0, 0);font-size: 16px;">&nbsp;</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">void</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> __rcu_read_unlock</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">void</span><span style="font-size: 16px;color: rgb(102, 102, 0);">)</span></span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">{</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">struct</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> task_struct </span><span style="font-size: 16px;color: rgb(102, 102, 0);">*</span><span style="font-size: 16px;color: rgb(0, 0, 0);">t </span><span style="font-size: 16px;color: rgb(102, 102, 0);">=</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> current</span><span style="font-size: 16px;color: rgb(102, 102, 0);">;</span></span></p></li><li><p><span style="color: rgb(0, 0, 0);font-size: 16px;">&nbsp;</span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">if</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">t</span><span style="font-size: 16px;color: rgb(102, 102, 0);">-&gt;</span><span style="font-size: 16px;color: rgb(0, 0, 0);">rcu_read_lock_nesting </span><span style="font-size: 16px;color: rgb(102, 102, 0);">!=</span><span style="font-size: 16px;color: rgb(0, 102, 102);">1</span><span style="font-size: 16px;color: rgb(102, 102, 0);">){</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(102, 102, 0);">--</span><span style="font-size: 16px;color: rgb(0, 0, 0);">t</span><span style="font-size: 16px;color: rgb(102, 102, 0);">-&gt;</span><span style="font-size: 16px;color: rgb(0, 0, 0);">rcu_read_lock_nesting</span><span style="font-size: 16px;color: rgb(102, 102, 0);">;</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(102, 102, 0);">}</span><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">else</span><span style="font-size: 16px;color: rgb(102, 102, 0);">{</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">barrier</span><span style="font-size: 16px;color: rgb(102, 102, 0);">();</span><span style="font-size: 16px;color: rgb(136, 0, 0);">/* critical section before exit code. */</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">t</span><span style="font-size: 16px;color: rgb(102, 102, 0);">-&gt;</span><span style="font-size: 16px;color: rgb(0, 0, 0);">rcu_read_lock_nesting </span><span style="font-size: 16px;color: rgb(102, 102, 0);">=</span><span style="font-size: 16px;color: rgb(0, 0, 0);"> INT_MIN</span><span style="font-size: 16px;color: rgb(102, 102, 0);">;</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">barrier</span><span style="font-size: 16px;color: rgb(102, 102, 0);">();</span><span style="font-size: 16px;color: rgb(136, 0, 0);">/* assign before -&gt;rcu_read_unlock_special load */</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 136);font-weight: bold;">if</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">unlikely</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">ACCESS_ONCE</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">t</span><span style="font-size: 16px;color: rgb(102, 102, 0);">-&gt;</span><span style="font-size: 16px;color: rgb(0, 0, 0);">rcu_read_unlock_special</span><span style="font-size: 16px;color: rgb(102, 102, 0);">)))</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">rcu_read_unlock_special</span><span style="font-size: 16px;color: rgb(102, 102, 0);">(</span><span style="font-size: 16px;color: rgb(0, 0, 0);">t</span><span style="font-size: 16px;color: rgb(102, 102, 0);">);</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">barrier</span><span style="font-size: 16px;color: rgb(102, 102, 0);">();</span><span style="font-size: 16px;color: rgb(136, 0, 0);">/* -&gt;rcu_read_unlock_special load before assign */</span></span></p></li><li><p><span style="font-size: 16px;"><span style="font-size: 16px;color: rgb(0, 0, 0);">t</span><span style="font-size: 16px;color: rgb(102, 102, 0);">-&gt;</span><span style="font-size: 16px;color: rgb(0, 0, 0);">rcu_read_lock_nesting </span><span style="font-size: 16px;color: rgb(102, 102, 0);">=</span><span style="font-size: 16px;color: rgb(0, 102, 102);">0</span><span style="font-size: 16px;color: rgb(102, 102, 0);">;</span></span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">}</span></p></li><li><p><span style="color: rgb(102, 102, 0);font-size: 16px;">}</span></p></li></ol></pre><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">当抢占发生时，__schedule函数会调用rcu_note_context_switch来通知RCU更新状态，如果当前CPU处于rcu_read_lock状态，当前进程将会放入rnp-&gt;blkd_tasks阻塞队列，并呈现在rnp-&gt;gp_tasks链表中。</span></p><p style="padding-bottom: 15px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);text-indent: 2em;"><span style="font-size: 16px;">从上文1.3节宽限期的结束处理过程我们可以知道，rcu_gp_kthread会判断!</span><span style="font-size: 16px;">&nbsp;(rnp-&gt;qsmask)&nbsp;&amp;&amp;&nbsp;!</span><span style="font-size: 16px;">rcu_preempt_blocked_readers_cgp(rnp))两个条件来决定GP是否完成，其中!</span><span style="font-size: 16px;">rnp-&gt;qsmask代表每个CPU都经过一次quiescent&nbsp;state，quiescent&nbsp;state的定义与传统RCU一致；</span><span style="font-size: 16px;">!</span><span style="font-size: 16px;">rcu_preempt_blocked_readers_cgp(rnp)这个条件就代表了rcu是否还有阻塞的进程。</span></p><p><br  /></p>
                </div>
                

                
  <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display: none;"></div>


                
                <div class="read-more__area" id="js_more_read_area" style="display:none;">
                    
                </div>

                
                                <div class="reward_area tc reward_area_primary" id="js_preview_reward_author" style="display:none;">
                    <div class="reward-avatar" style="display: none;" id="js_preview_reward_author_avatar">
                        <img src="" alt="" id="js_preview_reward_author_head">
                    </div>
                    
                                        <div class="reward-author" id="js_preview_reward_author_name">​itrocker</div>
                                        <p class="reward_tips" id="js_preview_reward_author_wording" style="display:none;"></p>
                    <p class="reward_button_wrp">
                    
                      <span class="reward_pop_panel">
                        <img src="https://res.wx.qq.com/mpres/zh_CN/htmledition/pages/home/index/pic_mp_app4290ba.png" alt="">
                        <strong>扫一扫下载订阅号助手，用手机发文章</strong>
                      </span>
                        <a class="reward_button" id='js_preview_reward_author_link' href="##"><span id="js_preview_reward_link_text">赞赏</span></a>
                    </p>
                </div>

                <div class="reward_qrcode_area reward_area tc" id="js_preview_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                    <p id="js_preview_reward_ios_wording" class="reward_tips" style="display:none;"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" src="res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_reward_qrcode.2x42f400.png"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                            </div>
		<div class="comment">
			<h3 style="margin:26px 0;font-weight:100;padding-bottom:4px;border-bottom:1px solid #ccc;">精选留言</h3>
		    暂无...
		</div>
	</div>
	<div class='dy_all'>
		<a href='http://www.wowotech.net/kernel_synchronization/223.html' target='_blank'>
			阅读全文
		</a>
	</div>
</body>