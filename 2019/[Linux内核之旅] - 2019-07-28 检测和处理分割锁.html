<!DOCTYPE html>
<head>
	<meta http-equiv='Content-Type' content='text/html;charset=utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no'>
	<title>
		检测和处理分割锁
	</title>
	<script src='https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js'>
	</script>
	<style>
		a {color: #607fa6;text-decoration:none;word-wrap:break-word;word-break:break-all;}.rich_media_title{padding-bottom:10px;margin-bottom:14px;border-bottom:1px solid #e7e7eb;font-weight:400;} .rich_media_meta_list{font-size:14px;margin-bottom: 22px;}
		.rich_media_meta{display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:14px;}.rich_media_meta_text{color:#8c8c8c;color:rgba(0, 0, 0, 0.3)}.rich_media_meta_list
		em {font-style: normal;}@media screen and (max-width:768px){.rich_media{position:
		relative;padding: 20px 15px 15px;background-color: #fff;}}.rich_media_content{text-align:justify;} .rich_media_content * {max-width:100%!important;box-sizing: border-box!important;-webkit-box-sizing:
		border-box!important;word-wrap: break-word!important;}.rich_media_content
		blockquote {margin: 0;padding-left: 10px;border-left: 3px solid #dbdbdb;}.rich_media_content
		.list-paddingleft-2 {padding-left: 2.2em;}a.rich_media_meta_nickname{display: none;}@media screen and (min-width:1025px){.rich_media{position:relative;}a.rich_media_meta_nickname{display:inline-block!important;}span.rich_media_meta_nickname
		{display: inline-block!important;}.rich_media {width:677px;margin-left:auto;margin-right:auto;}}a.fwjm{font-size: 12px;color: #ececec;}.tenvideo_player {position: relative;width:
		100 %;height: 100 %;margin: auto;background: #000;}* {margin:0px;padding:0px;} body{line-height: 1.6;letter-spacing: .034em;}
		.dy_all {text-align: center;margin: 30px 0;} .dy_all a {display: inline-block;height:
		38px;line-height: 38px;padding: 0 18px;background-color: #009688;color:
		#fff;white-space: nowrap;font-size: 14px;border: none;border-radius: 2px;cursor:
		pointer;text-align: center;outline: 0;-webkit-appearance: none;transition:
		all .3s;-webkit-transition: all .3s;box-sizing: border-box;} img{max-width: 677px!important;}

		.crawler-info{padding: 8px 0;} .article-link>img{margin-left: 20px;width: 16px;}
		.comment-item::before,.comment-item::after{content:'';display:block;height:0;visibility:hidden;clear:both;*zoom:1;} .comment-item{margin-bottom:30px;}
		.avatar{width:12%; padding-right:10px;float:left;box-sizing:border-box;} .avatar img{width:100%;}
		.comment-body{float:left;width:88%;} .comment-body .comment-info{color:#b3b3b3;margin-bottom:4px;margin-top: -5px;} .comment-body .comment-info>span:last-child{float:right;} 
		.comment-author{border-left:4px solid green;padding-left:6px;margin:8px 0;}

		@media screen and (max-width: 420px) {.article-link>img {margin-left: 0px;}}
		@media screen and (min-width: 480px) {.avatar {width: 9%;}.comment-body {width: 91%;}}
	</style>
</head>
<body>
	<div id='js_article' class='rich_media'>
		<div class="crawler-info">
			<a href='https://www.52pojie.cn' class='fwjm' target='_blank'>
				提供的爬取软件来源于：52pojie.cn@夜泉 免费下载使用
			</a>
			<a href='https://mp.weixin.qq.com/s?__biz=MzI3NzA5MzUxNA==&amp;mid=2664606720&amp;idx=1&amp;sn=d11278f7c3e4d6314542ce4115111bfb&amp;chksm=f04d81e5c73a08f358b0a8404c8d701e03760bdccca0d1cbd3fcfb43973432d8c05610f7c1f8&amp;scene=27#wechat_redirect&cpage=1' target='_blank' class="article-link">
				<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAQCAMAAABA3o1rAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjk4QUEzQzVDNkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjk4QUEzQzVENkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OThBQTNDNUE2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OThBQTNDNUI2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5TKSKsAAAAclBMVEUuLi77+/stLS1VVVXx8fFOTk7s7Ozt7e1qamp5eXlNTU2WlpZFRUU6Ojrq6urn5+d/f3/8/Pw9PT0/Pz+YmJg8PDyZmZlAQECfn5+QkJBBQUFra2vo6OhDQ0OSkpKenp5WVlY+Pj7r6+tpaWksLCz///9o6ILHAAAAJnRSTlP/////////////////////////////////////////////////AKd6gbwAAACNSURBVHjajJHpEoIwDISDVMotcnuCmLz/K9KCdlqO6v7p7Mw3yW4KxG85fnUkIVfZ5J0SsCtqcgRw0HzjQYY2AAOIdRuaK4ReAPJ5nmglL5qICahpU60C0uXguQ9TgIwGJoDnT9z/ABmxt60ot0N2CsDLfb9mvBxs9ql+n5o9bEDBgbif7/1F4g80CjAAqrVAnnsm5f8AAAAASUVORK5CYII=" />
			</a>
		</div>
		<div id="img-content">

                
                <h2 class="rich_media_title" id="activity-name">检测和处理分割锁</h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                                                                                            
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);">Linux内核之旅</a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">Linux内核之旅</strong>
                              <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">LinuxKernelTravel</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">Linux内核之旅</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>


                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2019-07-28</em>





                </div>

                
                
                                <a class="original_area_primary" id="copyright_info" href="##" style="visibility:hidden">
                    <span class="tips_global_primary">文章转载自公众号</span>
                    <span class="radius_avatar">
                                            <img class="avatar" src="http://wx.qlogo.cn/mmhead/Q3auHgzwzM6cga6DtKYhNxna0Eias71mxPD7sVuxpg2WTY7ZBPvzBqQ/0" alt="内核月谈">
                                          </span>
                    <span class="original_primary_nickname rich_media_meta_link js_nickname">内核月谈</span>
                                        <span class="tips_global_primary" id="js_comma">，</span>
                    <span class="original_primary_author_wrp tips_global_primary" id="js_author">
                      作者                                            阿里  雏雁
                                          </span>
                                    </a>
                                
                
                
                
                                                
                                                                
                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <header class="site-header" style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px 0px 1px;border-top-style: initial;border-right-style: initial;border-bottom-style: solid;border-left-style: initial;border-top-color: initial;border-right-color: initial;border-bottom-color: rgb(217, 217, 217);border-left-color: initial;font-variant-numeric: inherit;font-variant-east-asian: inherit;font-stretch: inherit;font-size: 16px;line-height: inherit;font-family: consolas, monaco, courier, &quot;courier new&quot;, fixed-width;vertical-align: baseline;min-height: 80px;color: rgba(51, 51, 51, 0.8);text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><nav class="nav" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;min-height: 64px;"><p><br  /></p></nav></header><p><br  /></p><article class="post container" itemscope="" itemtype="http://schema.org/BlogPosting" style="box-sizing: border-box;margin-right: auto;margin-left: auto;border-width: 0px;border-style: initial;border-color: initial;font-variant-numeric: inherit;font-variant-east-asian: inherit;font-stretch: inherit;font-size: 16px;line-height: inherit;font-family: consolas, monaco, courier, &quot;courier new&quot;, fixed-width;vertical-align: baseline;max-width: 800px;color: rgba(51, 51, 51, 0.8);text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><header class="post-header" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;"><h1 class="post-title" itemprop="name headline" style="box-sizing: border-box;margin-bottom: 2em;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: 700;font-stretch: inherit;font-size: 1.875rem;line-height: 1.2;vertical-align: baseline;color: rgb(51, 51, 51);"></h1></header><blockquote style="box-sizing: border-box;margin-top: 1.5em;margin-bottom: 1.5em;padding-top: 0px;padding-left: 1.5em;border-width: 0px 0px 0px 0.75em;border-top-style: initial;border-right-style: initial;border-bottom-style: initial;border-top-color: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: rgb(204, 204, 204);font-style: inherit;font-variant: inherit;font-weight: inherit;font-stretch: inherit;font-size: inherit;line-height: 1.8;font-family: inherit;vertical-align: baseline;quotes: none;color: rgb(51, 51, 51);background-color: rgb(242, 242, 242);"><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">本文在解读 https://lwn.net/Articles/790464/ 的基础上，加入自己理解，与原文存在差异。</p></blockquote><h3 style="box-sizing: border-box;margin-top: 0.75em;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: 700;font-stretch: inherit;font-size: 1.5rem;line-height: 1.2;vertical-align: baseline;">从地址不对齐访问到split lock</h3><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">Intel CPU微架构允许不对齐的内存访问，但ARM、RISC-V等架构却不允许。在众多的不对齐中，一个特殊的场景是：原子操作的操作数（由于地址不对齐）跨越两个cache lines，Intel将之叫做split lock。它有两个特征：</p><ol style="list-style-type: square;margin-left: 1.2em;" class=" list-paddingleft-2"><li><p>原子操作，即汇编指令包含Lock前缀；</p></li><li><p>操作数地址不对齐，还跨越两个cache lines；</p></li></ol><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">其实大部分吃瓜群众都不知道这个特性，但是它却对应用性能影响极大。最近，Intel工程师Fenghua Yu同学正在开发一组内核补丁，用于检测和处理split lock，现在已经发出了第8版code review。阿里巴巴在多年前就意识到split lock的危害，在线上实施了大规模监控，并采取必要隔离措施。</p><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">下面通过一小段代码给吃瓜群众一个感性的认识：</p><pre class="highlight" style="box-sizing: border-box;padding: 1.5em;border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);font-style: inherit;font-variant: inherit;font-weight: inherit;font-stretch: inherit;font-size: 1em;line-height: 23px;vertical-align: baseline;overflow: auto;max-height: 60em;box-shadow: rgba(0, 0, 0, 0.1) 0px 0px 2px;word-break: inherit;overflow-wrap: inherit;"><code style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: inherit;font-stretch: inherit;font-size: 1em;line-height: 1.75em;vertical-align: baseline;background-image: none;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;border-radius: 0px;">  <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">1</span> <span class="err" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(166, 23, 23);background-color: rgb(227, 210, 210);">#</span><span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">include</span><span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">&lt;</span><span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">stdio</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">.</span><span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">h</span><span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">&gt;</span><br  />  <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">2</span> <span class="err" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(166, 23, 23);background-color: rgb(227, 210, 210);">#</span><span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">include</span> <span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">&lt;</span><span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">sys</span><span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">/</span><span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">mman</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">.</span><span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">h</span><span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">&gt;</span><br  />  <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">3</span> <br  />  <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">4</span> <span class="err" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(166, 23, 23);background-color: rgb(227, 210, 210);">#</span><span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">pragma</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">pack</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">(</span><span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">push</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">,</span><span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">2</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">)</span><br  />  <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">5</span> <span class="k" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">struct</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">counter</span><br  />  <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">6</span> <span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">{</span><br  />  <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">7</span>     <span class="kt" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;color: rgb(68, 85, 136);">char</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">buf</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">[</span><span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">62</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">];</span><br  />  <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">8</span>     <span class="kt" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;color: rgb(68, 85, 136);">long</span> <span class="kt" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;color: rgb(68, 85, 136);">long</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">c</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">;</span><br  />  <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">9</span> <span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">};</span><br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">10</span> <span class="err" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(166, 23, 23);background-color: rgb(227, 210, 210);">#</span><span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">pragma</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">pack</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">(</span><span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">pop</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">)</span><br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">11</span> <br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">12</span> <span class="kt" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;color: rgb(68, 85, 136);">int</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">main</span> <span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">()</span> <span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">{</span><br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">13</span>     <span class="k" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">struct</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">counter</span> <span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">*</span><span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">p</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">;</span><br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">14</span>     <span class="kt" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;color: rgb(68, 85, 136);">int</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">size</span> <span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">=</span> <span class="k" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">sizeof</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">(</span><span class="k" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">struct</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">counter</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">);</span><br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">15</span>     <span class="kt" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;color: rgb(68, 85, 136);">int</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">prot</span> <span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">=</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">PROT_READ</span> <span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">|</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">PROT_WRITE</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">;</span><br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">16</span>     <span class="kt" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;color: rgb(68, 85, 136);">int</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">flags</span> <span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">=</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">MAP_PRIVATE</span> <span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">|</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">MAP_ANONYMOUS</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">;</span><br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">17</span> <br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">18</span>     <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">p</span> <span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">=</span> <span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">(</span><span class="k" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">struct</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">counter</span> <span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">*</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">)</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">mmap</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">(</span><span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">0</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">,</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">size</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">,</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">prot</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">,</span> <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">flags</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">,</span> <span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">-</span><span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">1</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">,</span> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">0</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">);</span><br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">19</span> <br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">20</span>     <span class="nf" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;color: rgb(153, 0, 0);">while</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">(</span><span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">1</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">)</span> <span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">{</span><br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">21</span>         <span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">__sync_fetch_and_add</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">(</span><span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">&amp;</span><span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">p</span><span class="o" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">-&gt;</span><span class="n" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">c</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">,</span> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">1</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">);</span><br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">22</span>     <span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">}</span><br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">23</span> <br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">24</span>     <span class="k" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: bold;font-stretch: inherit;font-size: inherit;line-height: inherit;font-family: inherit;vertical-align: baseline;">return</span> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">0</span><span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">;</span><br  /> <span class="mi" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;color: rgb(0, 153, 153);">25</span> <span class="p" style="box-sizing: border-box;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">}</span><br  /></code></pre><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">Intel cpu中，一个cache line 只有64个字节，struct counter中的成员 c 占8个字节，buf填充了62个字节。因此，一旦访问成员c，就涉及两个cache lines的内容的拼接；代码21行中，执行原子操作 __sync_fetch_and_add()会触发split lock。</p><h3 style="box-sizing: border-box;margin-top: 0.75em;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: 700;font-stretch: inherit;font-size: 1.5rem;line-height: 1.2;vertical-align: baseline;">split lock 的危害</h3><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">Intel处理器很贴心，自动处理了不对齐的内存访问，甚至能保证split lock操作的正确性；但是也给程序的性能埋下一颗很难被发现的雷。</p><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">学过体系结构的同学都应该知道，缓存一制性协议MESI只能保证cache line粒度的一致性。同时访问两个cache lines不是常见操作，为保证split lock的原子性，设计硬件时使用特殊逻辑（冷路径）来处理：锁住整个访存总线，阻止其它逻辑cpu访存。</p><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">从原理出发，我们很容易想到，锁住总线将导致其它core上访存操作受阻，宏观表现为平均访存延时显著上升。为不让各位看官白走一趟，小编在自己的skylake机器上测了一组数据，随着split lock速率的增加，访存延迟呈指数恶化。</p><p style="text-align: center;"><img class="rich_pages" data-ratio="0.6452476572958501" data-s="300,640" src="data:image/PNG;base64,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 " src="bDZYPQUwvDm2z41aQuraGyDeYYkMicQ4t6gdMuLeOIYoeINgnmZnY8cgFVnyLBTian1jOzcB9ZtvqsbicvVJj2Oiaw"  data-type="png" data-w="747" style=""  /></p><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">场景下，在Guest中执行一个用户态进程，就可以阻塞物理机上其它核的访存操作，导致整机性能下降；极端情况下，甚导致整机的拒绝服务（DoS）攻击。这是一个严重的故障隔离问题。<br  /></p><h3 style="box-sizing: border-box;margin-top: 0.75em;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: 700;font-stretch: inherit;font-size: 1.5rem;line-height: 1.2;vertical-align: baseline;">解决方案</h3><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">Intel 即将发布的下一代处理器 (Tremont和Ice Lake) 新增了Alignment Check (#AC)异常，并提供一个硬件开关。当开关使能的情况下，cpu产生split lock时，可以触发异常。至于采取什么动作就取决于注册的异常处理程序了，这正是Fenghua同学要做的事。而在早期的cpu上，只能通过perf监控sq_misc.split_lock 事件的数量，用于调试目的。</p><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">接下来，我们来看看这组内核补丁是如何处理#AC异常的。从整体看，可以将一个机器上运行的代码分为三类：固件、内核、用户态软件。</p><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">如果split lock出现在内核中，只打印warning，然后关闭当前cpu的检测功能。报出warning之后，重新执行被打断的指令，系统继续运行。是打印warning还是直接panic，是社区当前讨论的一个焦点。比较合理的解释是：内核中产生split lock是bug，但是该bug没有严重到需要直接panic。</p><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">如果split lock出现在用户态程序中，默认会发送一个SIGBUS信号，导致进程异常退出。只有当开发人员修复后才能正常运行程序。</p><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">当split lock出现在系统固件代码中，系统将会夯（hang）住。之所以这么设计，是内核开发人员担心，如果不暴露问题，固件厂商永远不会关注修复这类问题。</p><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">处理split lock的方式，有warning，sigbus, hang，都不是省油的灯。我们可能会担心，代码我改不了，一旦出现了split lock怎么办？好在设计者提供了关闭接口：</p><ol style="list-style-type: square;margin-left: 1.2em;" class=" list-paddingleft-2"><li><p>在内核启动参数中加入nosplit_lock_detect</p></li><li><p>echo 0 &gt; /sys/devices/system/cpu/split_lock_detect</p></li></ol><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">这组内核补丁经过多轮review，社区的反馈都比较积极，包括Thomas Gleixner和Ingo Molnar等大佬。虽然还剩下一些小问题，预计不久将被合入内核主线。</p><h3 style="box-sizing: border-box;margin-top: 0.75em;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: 700;font-stretch: inherit;font-size: 1.5rem;line-height: 1.2;vertical-align: baseline;">号外</h3><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">如何在现有的cpu上检测split lock呢？</p><pre class="highlight" style="box-sizing: border-box;padding: 1.5em;border-width: 1px;border-style: solid;border-color: rgb(204, 204, 204);font-style: inherit;font-variant: inherit;font-weight: inherit;font-stretch: inherit;font-size: 1em;line-height: 23px;vertical-align: baseline;overflow: auto;max-height: 60em;box-shadow: rgba(0, 0, 0, 0.1) 0px 0px 2px;word-break: inherit;overflow-wrap: inherit;"><code style="box-sizing: border-box;border-width: initial;border-style: none;border-color: initial;font-style: inherit;font-variant: inherit;font-weight: inherit;font-stretch: inherit;font-size: 1em;line-height: 1.75em;vertical-align: baseline;background-image: none;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;border-radius: 0px;">perf stat -e cpu/event=0xf4,umask=0x10/ -a -I 1000<br  /></code></pre><p style="box-sizing: border-box;margin-bottom: 0.75em;border-width: 0px;border-style: initial;border-color: initial;font: inherit;vertical-align: baseline;">其中 event=0xf4, umask=0x10 对应PMU事件sq_misc.split_lock。</p></article><p><br  /></p><p><br  /></p>
                </div>
                

                
  <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display: none;"></div>


                
                <div class="read-more__area" id="js_more_read_area" style="display:none;">
                    
                </div>

                
                                <div class="reward_area tc reward_area_primary" id="js_preview_reward_author" style="display:none;">
                    <div class="reward-avatar" style="display: none;" id="js_preview_reward_author_avatar">
                        <img src="" alt="" id="js_preview_reward_author_head">
                    </div>
                    
                                        <div class="reward-author" id="js_preview_reward_author_name">阿里  雏雁</div>
                                        <p class="reward_tips" id="js_preview_reward_author_wording" style="display:none;"></p>
                    <p class="reward_button_wrp">
                    
                      <span class="reward_pop_panel">
                        <img src="https://res.wx.qq.com/mpres/zh_CN/htmledition/pages/home/index/pic_mp_app4290ba.png" alt="">
                        <strong>扫一扫下载订阅号助手，用手机发文章</strong>
                      </span>
                        <a class="reward_button" id='js_preview_reward_author_link' href="##"><span id="js_preview_reward_link_text">赞赏</span></a>
                    </p>
                </div>

                <div class="reward_qrcode_area reward_area tc" id="js_preview_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                    <p id="js_preview_reward_ios_wording" class="reward_tips" style="display:none;"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" src="res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_reward_qrcode.2x42f400.png"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                            </div>
		<div class="comment">
			<h3 style="margin:26px 0;font-weight:100;padding-bottom:4px;border-bottom:1px solid #ccc;">精选留言</h3>
		    暂无...
		</div>
	</div>
	<div class='dy_all'>
		<a href='https://www.52pojie.cn/' target='_blank'>
			吾爱破解论坛
		</a>
	</div>
</body>