<!DOCTYPE html>
<head>
	<meta http-equiv='Content-Type' content='text/html;charset=utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no'>
	<title>
		Linux内核调试工具（二）-crash
	</title>
	<script src='https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js'>
	</script>
	<style>
		a {color: #607fa6;text-decoration:none;word-wrap:break-word;word-break:break-all;}.rich_media_title{padding-bottom:10px;margin-bottom:14px;border-bottom:1px solid #e7e7eb;font-weight:400;} .rich_media_meta_list{font-size:14px;margin-bottom: 22px;}
		.rich_media_meta{display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:14px;}.rich_media_meta_text{color:#8c8c8c;color:rgba(0, 0, 0, 0.3)}.rich_media_meta_list
		em {font-style: normal;}@media screen and (max-width:768px){.rich_media{position:
		relative;padding: 20px 15px 15px;background-color: #fff;}}.rich_media_content{text-align:justify;} .rich_media_content * {max-width:100%!important;box-sizing: border-box!important;-webkit-box-sizing:
		border-box!important;word-wrap: break-word!important;}.rich_media_content
		blockquote {margin: 0;padding-left: 10px;border-left: 3px solid #dbdbdb;}.rich_media_content
		.list-paddingleft-2 {padding-left: 2.2em;}a.rich_media_meta_nickname{display: none;}@media screen and (min-width:1025px){.rich_media{position:relative;}a.rich_media_meta_nickname{display:inline-block!important;}span.rich_media_meta_nickname
		{display: inline-block!important;}.rich_media {width:677px;margin-left:auto;margin-right:auto;}}a.fwjm{font-size: 12px;color: #ececec;}.tenvideo_player {position: relative;width:
		100 %;height: 100 %;margin: auto;background: #000;}* {margin:0px;padding:0px;} body{line-height: 1.6;letter-spacing: .034em;}
		.dy_all {text-align: center;margin: 30px 0;} .dy_all a {display: inline-block;height:
		38px;line-height: 38px;padding: 0 18px;background-color: #009688;color:
		#fff;white-space: nowrap;font-size: 14px;border: none;border-radius: 2px;cursor:
		pointer;text-align: center;outline: 0;-webkit-appearance: none;transition:
		all .3s;-webkit-transition: all .3s;box-sizing: border-box;} img{max-width: 677px!important;}

		.crawler-info{padding: 8px 0;} .article-link>img{margin-left: 20px;width: 16px;}
		.comment-item::before,.comment-item::after{content:'';display:block;height:0;visibility:hidden;clear:both;*zoom:1;} .comment-item{margin-bottom:30px;}
		.avatar{width:12%; padding-right:10px;float:left;box-sizing:border-box;} .avatar img{width:100%;}
		.comment-body{float:left;width:88%;} .comment-body .comment-info{color:#b3b3b3;margin-bottom:4px;margin-top: -5px;} .comment-body .comment-info>span:last-child{float:right;} 
		.comment-author{border-left:4px solid green;padding-left:6px;margin:8px 0;}

		@media screen and (max-width: 420px) {.article-link>img {margin-left: 0px;}}
		@media screen and (min-width: 480px) {.avatar {width: 9%;}.comment-body {width: 91%;}}
	</style>
</head>
<body>
	<div id='js_article' class='rich_media'>
		<div class="crawler-info">
			<a href='https://www.52pojie.cn' class='fwjm' target='_blank'>
				提供的爬取软件来源于：52pojie.cn@夜泉 免费下载使用
			</a>
			<a href='https://mp.weixin.qq.com/s?__biz=MzI3NzA5MzUxNA==&amp;mid=414427089&amp;idx=1&amp;sn=25ed8d9de8f0e67d8a8590a1612d5d8b&amp;chksm=762c8a34415b03228d7666528567b022eaff535100112160eae16853c13085a9d0bc1d11d756&amp;scene=27#wechat_redirect&cpage=82' target='_blank' class="article-link">
				<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAQCAMAAABA3o1rAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjk4QUEzQzVDNkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjk4QUEzQzVENkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OThBQTNDNUE2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OThBQTNDNUI2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5TKSKsAAAAclBMVEUuLi77+/stLS1VVVXx8fFOTk7s7Ozt7e1qamp5eXlNTU2WlpZFRUU6Ojrq6urn5+d/f3/8/Pw9PT0/Pz+YmJg8PDyZmZlAQECfn5+QkJBBQUFra2vo6OhDQ0OSkpKenp5WVlY+Pj7r6+tpaWksLCz///9o6ILHAAAAJnRSTlP/////////////////////////////////////////////////AKd6gbwAAACNSURBVHjajJHpEoIwDISDVMotcnuCmLz/K9KCdlqO6v7p7Mw3yW4KxG85fnUkIVfZ5J0SsCtqcgRw0HzjQYY2AAOIdRuaK4ReAPJ5nmglL5qICahpU60C0uXguQ9TgIwGJoDnT9z/ABmxt60ot0N2CsDLfb9mvBxs9ql+n5o9bEDBgbif7/1F4g80CjAAqrVAnnsm5f8AAAAASUVORK5CYII=" />
			</a>
		</div>
		<div id="img-content">

                
                <h2 class="rich_media_title" id="activity-name">Linux内核调试工具（二）-crash</h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                                                                            <span class="rich_media_meta rich_media_meta_text">
                                                        zhangskd
                                                    </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);">Linux内核之旅</a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">Linux内核之旅</strong>
                              <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">LinuxKernelTravel</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">Linux内核之旅</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>


                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2015-12-31</em>





                </div>

                
                
                                
                
                
                
                                                
                                                                
                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <p style="line-height: 25.6px; white-space: normal;"><span style="color: rgb(2, 30, 170);">题记：对于内核开发人员，crash 已经成为必不可少的一个工具。内核固然高深，但是通过 kdump 和 crash 这对战友的亲密配合，很多问题都会迎刃而解。本文仅介绍了 crash 的基本知识，更多的技巧还需要读者在实践中不断探索和总结。</span></p><p style="line-height: 25.6px; white-space: normal;"><br  /></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 16px;">当系统崩溃时，通过kdump可以获得当时的内存转储文件vmcore，但是该如何分析vmcore呢？</span></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 16px;">crash是一个用于分析内核转储文件的工具，一般和kdump搭配使用。</span></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 16px;">使用crash时，要求调试内核vmlinux在编译时带有-g选项，即带有调试信息。</span></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 16px;">如果没有指定vmcore，则默认使用实时系统的内存来分析。</span></p><p style="line-height: 25.6px; white-space: normal;"><br  /></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 16px;">值得一提的是，crash也可以用来分析实时的系统内存，是一个很强大的调试工具。</span></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 16px;">crash使用gdb作为内部引擎，语法类似于gdb，命令的使用说明可以用&lt;cmd&gt; help来查看。</span></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 16px;">使用crash需要安装crash工具包和内核调试信息包：</span></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 16px;">crash</span></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 16px;">kernel-debuginfo-common</span></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 16px;">kernel-debuginfo</span></p><p style="line-height: 25.6px; white-space: normal;"><br  /></p><h2 style="font-family: Arial; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">crash使用</span></h2><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">Analyze Linux crash dump data or a live system.</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">crash [OPTION] NAMELIST MEMORY-IMAGE      (dumpfile form)</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">crash [OPTION] [NAMELIST]                                   (live system form)</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">使用crash来调试vmcore，至少需要两个参数：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">NAMELIST：未压缩的内核映像文件vmlinux，默认位于/usr/lib/debug/lib/modules/$(uname -r)/vmlinux，由</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">内核调试信息包提供。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">MEMORY-IMAGE：内存转储文件vmcore，默认位于/var/crash/%HOST-%DATE/vmcore，由kdump生成。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">例如：# crash /usr/lib/debug/lib/modules/$(uname -r)/vmlinux   /var/crash/%HOST-%DATE/vmcore</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"><strong>(1) 错误类型</strong></span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">首先可以在vmcore-dmesg.txt中先查看错误类型，如：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">1. divide error: 0000 [#1] SMP，除数为0造成内核崩溃，由1号CPU触发。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">2. BUG: unable to handle kernel NULL pointer dereference at 000000000000012c，引用空指针。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">这样一来就能知道引发内核崩溃的错误类型。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"><strong>(2) 错误地点</strong></span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">RIP为造成内核崩溃的指令，Call Trace为函数调用栈，通过RIP和Call Trace可以确定函数的调用路径，以及在</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">哪个函数中的哪条指令引发了错误。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">例如RIP为：[&lt;ffffffff812cdb54&gt;] ? tcp_enter_loss+0x1d3/0x23b</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">[&lt;ffffffff812cdb54&gt;]是指令在内存中的虚拟地址。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">tcp_enter_loss是函数名(symbol)。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">0x1d3是这条指令相对于tcp_enter_loss入口的偏移，0x23b是函数编译成机器码后的长度。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">这样一来就能确定在哪个函数中引发了错误，以及错误的大概位置。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">Call Trace为函数的调用栈，是从下往上看的。可以用来分析函数的调用关系。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"><strong>(3) crash基本输出</strong></span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># crash /usr/lib/debug/lib/modules/$(uname -r)/vmlinux   /var/crash/%HOST-%DATE/vmcore</span></p><ol start="1" style="" class=" list-paddingleft-2"><li><p><span style="color: black; font-size: 16px; background-color: inherit;"> KERNEL: /usr/lib/debug/lib/modules/2.6.32-358.el6.x86_64/vmlinux  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">UMPFILE: vmcore  [PARTIAL DUMP]  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">   CPUS: 12  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">   DATE: Fri Sep 19 16:47:01 2014  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;"> UPTIME: 7 days, 06:37:46  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">AVERAGE: 0.19, 0.05, 0.01  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  TASKS: 282  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">ODENAME: localhost.localdomain  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">RELEASE: 2.6.32-358.el6.x86_64  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">VERSION: #1 SMP Tue Oct 29 10:18:21 CST 2013  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">MACHINE: x86_64  (1999 Mhz)  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;"> MEMORY: 48 GB  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  PANIC: &quot;Oops: 0002 [#1] SMP &quot; (check log for details)  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">    PID: 0  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">COMMAND: &quot;swapper&quot;  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">   TASK: ffffffff81a8d020  (1 of 12)  [THREAD_INFO: ffffffff81a00000]  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">    CPU: 0  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  STATE: TASK_RUNNING (PANIC)  </span></p></li></ol><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">这些基本输出信息简单明了，可由sys命令触发。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"><strong>(4) crash常用命令</strong></span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">bt：打印函数调用栈，displays a task&#39;s kernel-stack backtrace，可以指定进程号bt &lt;pid&gt;。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">log：打印系统消息缓冲区，displays the kernel log_buf contents，如log | tail -n 30。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">ps：显示进程的状态，&gt;表示活跃的进程，如ps | grep RU。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">sys：显示系统概况。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">kmem -i：显示内存使用信息。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">dis &lt;addr&gt;：对给定地址进行反汇编。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">exception RIP即为造成错误的指令。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">关于log命令：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">内核首先把消息打印到内核态的ring buffer，用户态的klogd负责读取并转发给syslogd，让它记录到磁盘。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">在内核崩溃时，可能无法把消息记录到磁盘，但是ring buffer中一般会有记录。所以log命令有时候能查看</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">到系统日志中所缺失的信息。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"><strong>(5) 结构体和变量</strong></span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">查看结构体中所有成员的值，例如：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># ps | grep RU</span></p><ol start="1" style="" class=" list-paddingleft-2"><li><p><span style="color: black; font-size: 16px; background-color: inherit;">&gt;     0      0   0  ffffffff81a8d020  RU   0.0       0      0  [swapper]  </span></p><p><span style="color: black; font-size: 16px; background-color: inherit;"></span></p></li></ol><p style="line-height: 25.6px; white-space: normal;"><span style="font-family: Arial; line-height: 26px; font-size: 16px; background-color: rgb(255, 255, 255);"># struct task_struct ffffffff81a8d020</span></p><p style="line-height: 25.6px; white-space: normal;"><br  /></p><ol start="1" style="" class=" list-paddingleft-2"><li><p><span style="color: black; font-size: 16px; background-color: inherit;">struct task_struct {  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  state = 0,   </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  stack = 0xffffffff81a00000,   </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  usage = {  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">    counter = 2  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  },   </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  flags = 2097408,   </span></p></li></ol><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">显示整个结构体的定义：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># struct task_struct</span></p><ol start="1" style="" class=" list-paddingleft-2"><li><p><span style="color: black; font-size: 16px; background-color: inherit;">struct task_struct {  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">    volatile long int state;  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">    void *stack;  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">    atomic_t usage;  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">    unsigned int flags;  </span></p></li></ol><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 16px;">           </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">显示整个结构体的定义，以及每个成员的偏移：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># struct -o task_struct</span></p><ol start="1" style="" class=" list-paddingleft-2"><li><p><span style="color: black; font-size: 16px; background-color: inherit;">struct task_struct {  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">     [0] volatile long int state;  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">     [8] void *stack;  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">    [16] atomic_t usage;  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">    [20] unsigned int flags;  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">    ...  </span></p></li></ol><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">显示结构体中的成员定义，以及它的偏移：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># struct task_struct.pid</span></p><ol start="1" style="" class=" list-paddingleft-2"><li><p><span style="color: black; font-size: 16px; background-color: inherit;">struct task_struct {  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  [1192] pid_t pid;  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">}  </span></p></li></ol><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">显示结构体中成员的值：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># struct task_struct.pid ffffffff81a8d020</span></p><ol start="1" style="" class=" list-paddingleft-2"><li><p><span style="color: black; font-size: 16px; background-color: inherit;">pid = 0  </span></p></li></ol><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">查看全局变量的值：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># p sysctl_tcp_rmem</span></p><ol start="1" style="" class=" list-paddingleft-2"><li><p><span style="color: black; font-size: 16px; background-color: inherit;">sysctl_tcp_rmem = $4 =   </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;"> {40960, 873800, 41943040}  </span></p></li></ol><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">查看percpu全局变量(加前缀per_cpu_)：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># p per_cpu__irq_stat</span></p><ol start="1" style="" class=" list-paddingleft-2"><li><p><span style="color: black; font-size: 16px; background-color: inherit;">PER-CPU DATA TYPE:  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  irq_cpustat_t per_cpu__irq_stat; // 变量类型的声明  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">PER-CPU ADDRESSES:  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  [0]: ffff880028216540 // 0号CPU对应变量的地址  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  [1]: ffff880645416540  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  ...  </span></p></li></ol><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">查看0号CPU对应变量的值：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># struct irq_cpustat_t ffff880028216540</span></p><ol start="1" style="" class=" list-paddingleft-2"><li><p><span style="color: black; font-size: 16px; background-color: inherit;">truct irq_cpustat_t {  </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  __softirq_pending = 0,   </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  __nmi_count = 4780195,   </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  irq0_irqs = 148,   </span></p></li><li><p><span style="color: black; font-size: 16px; background-color: inherit;">  ...  </span></p></li></ol><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"><strong>(6) 反汇编和源码行</strong></span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">反汇编：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># dis ffffffffa021ba91 // 反汇编一条指令</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># dis -l probe_2093+497 10 // 反汇编从某个地址开始的10条指令<br  /></span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">对于内核中的符号：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># sym tcp_v4_do_rcv // 通过symbol，显示虚拟地址和源码位置</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># sym ffffffff8149f930 // 通过虚拟地址，显示symbol和源码位置</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">对于模块中的符号：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">需要先加载相应的模块进来，才能显示符号对应的源码：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># mod // 查看模块</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># mod -s module /path/to/module.ko // 加载模块</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># sym symbol // 显示符号对应的模块源码，也可以用virtual address</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"><strong>(7) 修改内存</strong></span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">提供动态的修改运行中内核的功能，以供调试，但是RHEL和CentOS上不允许。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">wr：modifies the contents of memory.</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">wr [-u | -k | -p] [-8 | -16 | -32 | -64] [address | symbol] value</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">使用例子：</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"># p sysctl_tcp_timestamps</span></p><ol start="1" style="" class=" list-paddingleft-2"><li><p><span style="color: black; font-size: 16px; background-color: inherit;">sysctl_tcp_timestamps = $3 = 1  </span></p></li></ol><p style="line-height: 25.6px; white-space: normal;"><span style="font-family: Arial; line-height: 26px; font-size: 16px; background-color: rgb(255, 255, 255);"># wr sysctl_tcp_timestamps 0</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">/dev/crash的文件属性是rw，但是crash_fops中并没有提供写函数，所以还是只读的。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">这个功能很有用，但被RHEL和CentOS禁止了，所以如需动态修改运行内核还是用systemtap吧。</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><h2 style="font-family: Arial; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">Reference</span></h2><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;"> </span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">[1]. </span><span style="font-size: 16px;">http://www.ibm.com/developerworks/cn/linux/l-cn-kdump1/</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">[2]. </span><span style="font-size: 16px;">http://www.ibm.com/developerworks/cn/linux/l-cn-kdump2/</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">[3]. </span><span style="font-size: 16px;">http://www.ibm.com/developerworks/cn/linux/l-cn-kdump3/</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">[4]. </span><span style="font-size: 16px;">http://www.ibm.com/developerworks/cn/linux/l-cn-kdump4/</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">[5]. </span><span style="font-size: 16px;">http://www.ibm.com/developerworks/cn/linux/l-cn-dumpanalyse/</span></p><p style="font-family: Arial; font-size: 14px; line-height: 26px; white-space: normal; background-color: rgb(255, 255, 255);"><span style="font-size: 16px;">[6]. </span><span style="font-size: 16px;">http://people.redhat.com/anderson/crash_whitepaper/</span></p><p style="line-height: 25.6px; white-space: normal;"><br  /></p>
                </div>
                

                
  <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display: none;"></div>


                
                <div class="read-more__area" id="js_more_read_area" style="display:none;">
                    
                </div>

                
                                <div class="reward_area tc reward_area_primary" id="js_preview_reward_author" style="display:none;">
                    <div class="reward-avatar" style="display: none;" id="js_preview_reward_author_avatar">
                        <img src="" alt="" id="js_preview_reward_author_head">
                    </div>
                    
                                        <div class="reward-author" id="js_preview_reward_author_name">zhangskd</div>
                                        <p class="reward_tips" id="js_preview_reward_author_wording" style="display:none;"></p>
                    <p class="reward_button_wrp">
                    
                      <span class="reward_pop_panel">
                        <img src="https://res.wx.qq.com/mpres/zh_CN/htmledition/pages/home/index/pic_mp_app4290ba.png" alt="">
                        <strong>扫一扫下载订阅号助手，用手机发文章</strong>
                      </span>
                        <a class="reward_button" id='js_preview_reward_author_link' href="##"><span id="js_preview_reward_link_text">赞赏</span></a>
                    </p>
                </div>

                <div class="reward_qrcode_area reward_area tc" id="js_preview_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                    <p id="js_preview_reward_ios_wording" class="reward_tips" style="display:none;"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" src="res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_reward_qrcode.2x42f400.png"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                            </div>
		<div class="comment">
			<h3 style="margin:26px 0;font-weight:100;padding-bottom:4px;border-bottom:1px solid #ccc;">精选留言</h3>
		    暂无...
		</div>
	</div>
	<div class='dy_all'>
		<a href='http://blog.csdn.net/zhangskd/article/details/38084337' target='_blank'>
			阅读全文
		</a>
	</div>
</body>