<!DOCTYPE html>
<head>
	<meta http-equiv='Content-Type' content='text/html;charset=utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no'>
	<title>
		LWN 106177- 四级页表
	</title>
	<script src='https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js'>
	</script>
	<style>
		a {color: #607fa6;text-decoration:none;word-wrap:break-word;word-break:break-all;}.rich_media_title{padding-bottom:10px;margin-bottom:14px;border-bottom:1px solid #e7e7eb;font-weight:400;} .rich_media_meta_list{font-size:14px;margin-bottom: 22px;}
		.rich_media_meta{display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:14px;}.rich_media_meta_text{color:#8c8c8c;color:rgba(0, 0, 0, 0.3)}.rich_media_meta_list
		em {font-style: normal;}@media screen and (max-width:768px){.rich_media{position:
		relative;padding: 20px 15px 15px;background-color: #fff;}}.rich_media_content{text-align:justify;} .rich_media_content * {max-width:100%!important;box-sizing: border-box!important;-webkit-box-sizing:
		border-box!important;word-wrap: break-word!important;}.rich_media_content
		blockquote {margin: 0;padding-left: 10px;border-left: 3px solid #dbdbdb;}.rich_media_content
		.list-paddingleft-2 {padding-left: 2.2em;}a.rich_media_meta_nickname{display: none;}@media screen and (min-width:1025px){.rich_media{position:relative;}a.rich_media_meta_nickname{display:inline-block!important;}span.rich_media_meta_nickname
		{display: inline-block!important;}.rich_media {width:677px;margin-left:auto;margin-right:auto;}}a.fwjm{font-size: 12px;color: #ececec;}.tenvideo_player {position: relative;width:
		100 %;height: 100 %;margin: auto;background: #000;}* {margin:0px;padding:0px;} body{line-height: 1.6;letter-spacing: .034em;}
		.dy_all {text-align: center;margin: 30px 0;} .dy_all a {display: inline-block;height:
		38px;line-height: 38px;padding: 0 18px;background-color: #009688;color:
		#fff;white-space: nowrap;font-size: 14px;border: none;border-radius: 2px;cursor:
		pointer;text-align: center;outline: 0;-webkit-appearance: none;transition:
		all .3s;-webkit-transition: all .3s;box-sizing: border-box;} img{max-width: 677px!important;}

		.crawler-info{padding: 8px 0;} .article-link>img{margin-left: 20px;width: 16px;}
		.comment-item::before,.comment-item::after{content:'';display:block;height:0;visibility:hidden;clear:both;*zoom:1;} .comment-item{margin-bottom:30px;}
		.avatar{width:12%; padding-right:10px;float:left;box-sizing:border-box;} .avatar img{width:100%;}
		.comment-body{float:left;width:88%;} .comment-body .comment-info{color:#b3b3b3;margin-bottom:4px;margin-top: -5px;} .comment-body .comment-info>span:last-child{float:right;} 
		.comment-author{border-left:4px solid green;padding-left:6px;margin:8px 0;}

		@media screen and (max-width: 420px) {.article-link>img {margin-left: 0px;}}
		@media screen and (min-width: 480px) {.avatar {width: 9%;}.comment-body {width: 91%;}}
	</style>
</head>
<body>
	<div id='js_article' class='rich_media'>
		<div class="crawler-info">
			<a href='https://www.52pojie.cn' class='fwjm' target='_blank'>
				提供的爬取软件来源于：52pojie.cn@夜泉 免费下载使用
			</a>
			<a href='https://mp.weixin.qq.com/s?__biz=MzI3NzA5MzUxNA==&amp;mid=2664605698&amp;idx=1&amp;sn=baa53e1d15d9f92f4b71f9f7cafbacf4&amp;chksm=f04d85e7c73a0cf1aa09b6390ae2c8bd93b2e5e79b36054d519bfeeb9da982fc86d8faf18839&amp;scene=27#wechat_redirect&cpage=15' target='_blank' class="article-link">
				<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAQCAMAAABA3o1rAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjk4QUEzQzVDNkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjk4QUEzQzVENkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OThBQTNDNUE2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OThBQTNDNUI2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5TKSKsAAAAclBMVEUuLi77+/stLS1VVVXx8fFOTk7s7Ozt7e1qamp5eXlNTU2WlpZFRUU6Ojrq6urn5+d/f3/8/Pw9PT0/Pz+YmJg8PDyZmZlAQECfn5+QkJBBQUFra2vo6OhDQ0OSkpKenp5WVlY+Pj7r6+tpaWksLCz///9o6ILHAAAAJnRSTlP/////////////////////////////////////////////////AKd6gbwAAACNSURBVHjajJHpEoIwDISDVMotcnuCmLz/K9KCdlqO6v7p7Mw3yW4KxG85fnUkIVfZ5J0SsCtqcgRw0HzjQYY2AAOIdRuaK4ReAPJ5nmglL5qICahpU60C0uXguQ9TgIwGJoDnT9z/ABmxt60ot0N2CsDLfb9mvBxs9ql+n5o9bEDBgbif7/1F4g80CjAAqrVAnnsm5f8AAAAASUVORK5CYII=" />
			</a>
		</div>
		<div id="img-content">

                
                <h2 class="rich_media_title" id="activity-name">LWN 106177: 四级页表</h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                                                                            <span class="rich_media_meta rich_media_meta_text">
                                                        Wang Chen
                                                    </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);">Linux内核之旅</a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">Linux内核之旅</strong>
                              <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">LinuxKernelTravel</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">Linux内核之旅</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>


                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2018-09-24</em>





                </div>

                
                
                                
                
                
                
                                                
                                                                
                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <blockquote style="white-space: normal;margin: 20px auto;padding-right: 1.03em;padding-left: 1.03em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: inherit;vertical-align: baseline;quotes: none;border-left-width: 2px;border-left-style: dotted;border-left-color: rgb(220, 222, 224);color: rgb(102, 102, 102);letter-spacing: 1px;"><p style="margin-top: 10px;margin-bottom: 10px;font-family: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;white-space: pre-wrap;word-wrap: break-word;overflow: hidden;text-indent: 1.16em;"><span style="caret-color: rgb(102, 102, 102);color: rgb(102, 102, 102);font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;letter-spacing: 1px;white-space: pre-wrap;background-color: rgb(252, 252, 252);">Most Linux users probably have a sufficiently interesting life that they spend little time imagining how page tables are represented in the kernel. Many of those who do ponder on that issue may think in terms of a linear array which maps virtual addresses onto their corresponding physical addresses. This view of page tables is enough to understand the basic function that they perform, but the real situation is more complicated than that.</span></p></blockquote><p style="white-space: normal;margin-bottom: 0.67em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;text-indent: 1.16em;caret-color: rgb(64, 64, 64);color: rgb(64, 64, 64);letter-spacing: 1px;">绝大多数 Linux 的用户并不会真正去仔细考虑内核中有关处理页表（page tables）的问题。即使对于那些真的关心这个问题的人来说，其中的大部分人可能会认为，在设计上，使用一个简单的数组，数组的每一项用于记录虚拟地址到物理地址的对应关系，如此这般已足以支持地址翻译的基本功能。但实际上真正实现起来，远比这复杂得多。</p><blockquote style="white-space: normal;margin: 20px auto;padding-right: 1.03em;padding-left: 1.03em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: inherit;vertical-align: baseline;quotes: none;border-left-width: 2px;border-left-style: dotted;border-left-color: rgb(220, 222, 224);color: rgb(102, 102, 102);letter-spacing: 1px;"><p style="margin-top: 10px;margin-bottom: 10px;font-family: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;white-space: pre-wrap;word-wrap: break-word;overflow: hidden;text-indent: 1.16em;"><span style="caret-color: rgb(102, 102, 102);color: rgb(102, 102, 102);font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;letter-spacing: 1px;white-space: pre-wrap;background-color: rgb(252, 252, 252);">A single array large enough to hold the page table entries for a single process would be huge. On a typical x86 system, a page table entry requires 32 bits, so 1024 of them (covering 4MB of virtual address space) can be stored in one page. If the virtual address space is 3GB (as it is on many x86 systems), 768 pages would be required to hold all of the page table entries. Allocating that much contiguous memory (for each process) would be impossible, even if that sort of memory overhead were tolerable.</span></p></blockquote><p style="white-space: normal;margin-bottom: 0.67em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;text-indent: 1.16em;caret-color: rgb(64, 64, 64);color: rgb(64, 64, 64);letter-spacing: 1px;">对每一个进程来说，如果我们用一个数组来存放该进程的所有页表项，其耗费的内存量是非常巨大的。在一个典型的 x86 系统上，一个页表项占用 32 个比特位（即 4 个字节），因此一个物理页（page，在 32 位的架构中典型的大小是 4K 字节）中可以存放的页表项个数就是 1024 个（也就是可以映射总共 4MB 大小的虚拟地址空间）。如果要覆盖 3GB 大小的虚拟地址空间（常见的 x86 系统基本上都是这种情况），则需要 768 个物理页来保存所有的页表项条目。话再说回来，即便我们可以真的容忍这么大的内存开销，但要一次性分配如此容量的 “连续” 的内存（注意是对每个进程），也几乎是不可能的。</p><blockquote style="white-space: normal;margin: 20px auto;padding-right: 1.03em;padding-left: 1.03em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: inherit;vertical-align: baseline;quotes: none;border-left-width: 2px;border-left-style: dotted;border-left-color: rgb(220, 222, 224);color: rgb(102, 102, 102);letter-spacing: 1px;"><p style="margin-top: 10px;margin-bottom: 10px;font-family: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;white-space: pre-wrap;word-wrap: break-word;overflow: hidden;text-indent: 1.16em;"><span style="caret-color: rgb(102, 102, 102);color: rgb(102, 102, 102);font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;letter-spacing: 1px;white-space: pre-wrap;background-color: rgb(252, 252, 252);">The fact is that most processes only use a small portion of the total virtual address space - but the parts they use are widely scattered over that space. Program text lives down near the bottom, heap memory and dynamic libraries are distributed throughout the middle, and the stack is put up at the very top. So the real page table structure must handle a sparse, widely distributed set of virtual addresses without wasting excessive amounts of memory or requiring large, physically-contiguous arrays.</span></p></blockquote><p style="white-space: normal;margin-bottom: 0.67em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;text-indent: 1.16em;caret-color: rgb(64, 64, 64);color: rgb(64, 64, 64);letter-spacing: 1px;">实际情况是，在运行时，绝大多数进程只会使用整个虚拟地址空间的一小部分，并且这一小部分还是非常离散地分布在整个地址空间范围内。譬如，程序的代码段一般会被加载在虚拟地址的低地址区间，堆和动态库占用了虚拟地址空间的中间部分，而栈则处于地址空间的高地址区间。因此，针对虚拟地址空间上分布的这种稀疏特性，页表结构采用一个物理上连续的大数组未免显得过于浪费。</p><blockquote style="white-space: normal;margin: 20px auto;padding-right: 1.03em;padding-left: 1.03em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: inherit;vertical-align: baseline;quotes: none;border-left-width: 2px;border-left-style: dotted;border-left-color: rgb(220, 222, 224);color: rgb(102, 102, 102);letter-spacing: 1px;"><p style="margin-top: 10px;margin-bottom: 10px;font-family: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;white-space: pre-wrap;word-wrap: break-word;overflow: hidden;text-indent: 1.16em;"><span style="caret-color: rgb(102, 102, 102);color: rgb(102, 102, 102);font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;letter-spacing: 1px;white-space: pre-wrap;background-color: rgb(252, 252, 252);">To that end, modern processors which use page tables use a hierarchical, tree structure. This structure allows the table to be broken up into individual pages, and the subtrees corresponding to unused parts of the address space can be absent.</span><span style="background-color: rgb(252, 252, 252);text-indent: 1.16em;">The Linux kernel works with a three-level structure which looks like this:</span></p></blockquote><p style="white-space: normal;margin-bottom: 0.67em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;text-indent: 1.16em;caret-color: rgb(64, 64, 64);color: rgb(64, 64, 64);letter-spacing: 1px;">基于以上考虑，支持分页机制的现代处理器在页表设计上使用的都是分层的树状结构。该结构允许将大的表（table）分解成单独的（不连续的）页（page），这样下一级子树中没有对地址进行映射的表项就可以不加载（即不占用内存）。当前（译者注，内核版本 2.6.11 之前）Linux 内核的页表模型使用如下图所示的三级结构：</p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.5813609467455622" data-s="300,640" src="data:image/PNG;base64,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 " src="SeWfibBcBT0EAC0PNGibALKuibTmG1sEVEdPvtRGxs39fmZeZTnlFl6r0wD8mwicK30rHUlVLFvUcDAHYc2UpJLiaQQ"  data-type="png" data-w="676" style=""  /></p><blockquote style="white-space: normal;margin: 20px auto;padding-right: 1.03em;padding-left: 1.03em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: inherit;vertical-align: baseline;quotes: none;border-left-width: 2px;border-left-style: dotted;border-left-color: rgb(220, 222, 224);color: rgb(102, 102, 102);letter-spacing: 1px;"><p style="margin-top: 10px;margin-bottom: 10px;font-family: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;white-space: pre-wrap;word-wrap: break-word;overflow: hidden;text-indent: 1.16em;"><span style="caret-color: rgb(102, 102, 102);color: rgb(102, 102, 102);font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;letter-spacing: 1px;white-space: pre-wrap;background-color: rgb(252, 252, 252);">On an x86 system running in the PAE mode (only needed when more than 4GB of memory is installed), all three levels of page tables are present. The page global directory (PGD) contains only four entries, each corresponding to 1GB of virtual address space; the PGD is indexed using the top two bits of the virtual address. Each PGD entry points to a page middle directory (PMD), which holds 512 entries indexed by bits 21-29 of the virtual address. The PMD entry (if it is not empty) points to an actual page table. Using bits 12-20 of the virtual address to index into that page table yields the actual physical address of the page, assuming that page is currently resident in RAM.</span></p></blockquote><p style="white-space: normal;margin-bottom: 0.67em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;text-indent: 1.16em;caret-color: rgb(64, 64, 64);color: rgb(64, 64, 64);letter-spacing: 1px;">当 x86 系统运行在 PAE （Physical Address Extension）模式时（该模式仅在系统安装了超过 4GB 的物理内存时才需要使能），Linux 内核会全面启用这种三级的页表机制。页全局目录（Page Global Directory，以下简称 PGD）仅包含四项，每一项对应 1GB 的虚拟地址空间；PGD 使用虚拟地址的前两位进行索引。每一项 PGD 条目指向一个页中间目录（Page Middle Directory，以下简称 PMD），每一个 PMD 表包含 512 项条目，每一项可以通过虚拟地址的 21-29 位进行索引。每一个 PMD 条目（除非其值为空）指向页表（Page Table，即上图中的 PTE。每个 PTE 表也是同样包含 512 个条目）。通过虚拟地址的 12-20 位作为索引可以在 PTE 表中定位表项并最终获得页（page）的物理地址（译者注，这里的页（page）指的是虚拟地址所映射的物理内存字节单元所在的物理页），除非该页的内容当前没有驻留在内存中。</p><blockquote style="white-space: normal;margin: 20px auto;padding-right: 1.03em;padding-left: 1.03em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: inherit;vertical-align: baseline;quotes: none;border-left-width: 2px;border-left-style: dotted;border-left-color: rgb(220, 222, 224);color: rgb(102, 102, 102);letter-spacing: 1px;"><p style="margin-top: 10px;margin-bottom: 10px;font-family: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;white-space: pre-wrap;word-wrap: break-word;overflow: hidden;text-indent: 1.16em;"><span style="caret-color: rgb(102, 102, 102);color: rgb(102, 102, 102);font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;letter-spacing: 1px;white-space: pre-wrap;background-color: rgb(252, 252, 252);">The current 2.6 kernel implements a three-level page table for all architectures. As it turns out, the bulk of x86 systems will not be running in the PAE mode; on those systems, the hardware only supports two levels of page tables. The PGD holds 1024 entries (bits 22-31), each of which points to a 1024-entry page table (bits 12-21). For the benefit of the rest of the kernel, the page table access functions are set up to emulate the existence of a single-entry PMD, so these systems still appear to use a three-level page table.</span></p></blockquote><p style="white-space: normal;margin-bottom: 0.67em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;text-indent: 1.16em;caret-color: rgb(64, 64, 64);color: rgb(64, 64, 64);letter-spacing: 1px;">当前的 2.6 版本的内核对所有的体系架构均采用通用的三级页表进行处理。但事实上，大部分 x86 系统并不会在 PAE 模式下运行；在有些系统上，硬件仅支持两级页表。相应地在这些处理器上运行的 Linux 内核中，每个 PGD 拥有 1024 个条目（使用虚拟地址的 22-31 位进行索引），每个 PGD 条目直接指向页表（Page Table，即 PTE），这里的每个 PTE 含有 1024 个条目（采用虚拟地址的 12-21 位进行索引）。因为中间少了一级 PMD，为了让内核的其他部分在访问页表时感觉不到体系架构的差异，相关页表 API 函数会模拟一个虚拟的 PMD 级别，每个 PMD 只含一项。这种抽象保持了代码结构的统一，让整个系统看上去仍然使用的是三级页表。</p><blockquote style="white-space: normal;margin: 20px auto;padding-right: 1.03em;padding-left: 1.03em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: inherit;vertical-align: baseline;quotes: none;border-left-width: 2px;border-left-style: dotted;border-left-color: rgb(220, 222, 224);color: rgb(102, 102, 102);letter-spacing: 1px;"><p style="margin-top: 10px;margin-bottom: 10px;font-family: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;white-space: pre-wrap;word-wrap: break-word;overflow: hidden;text-indent: 1.16em;"><span style="caret-color: rgb(102, 102, 102);color: rgb(102, 102, 102);font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;letter-spacing: 1px;white-space: pre-wrap;background-color: rgb(252, 252, 252);">The three-level design is wired deeply into the kernel. Any code which must manually map a virtual address into its physical counterpart must do something like this (error handling and other details omitted):</span></p></blockquote><p style="white-space: normal;margin-bottom: 0.67em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;text-indent: 1.16em;caret-color: rgb(64, 64, 64);color: rgb(64, 64, 64);letter-spacing: 1px;">三级页表模型的概念已经深深烙印在内核的设计中。任何需要手动根据虚拟地址获取物理地址的操作都需要严格按照以下三步进行（这里省略了错误处理和其他细节）：</p><pre class="highlight prettyprint linenums prettyprinted" style="margin: 0px auto 0.67em;padding: 2px;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: 20px;vertical-align: baseline;word-break: break-all;word-wrap: break-word;white-space: pre-wrap;background-color: rgb(245, 245, 245);border: 1px solid rgb(204, 204, 204);width: 758.078125px;"><ol class="linenums list-paddingleft-2" style="margin-left: 2.5em;"><li><p><code style="font-family: Courier, monospace;font-size: 10.805398941040039px;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;background-color: transparent;border: 0px;border-top-left-radius: 3px;border-top-right-radius: 3px;border-bottom-right-radius: 3px;border-bottom-left-radius: 3px;color: inherit;"><span class="pln" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(0, 0, 0);">pmd </span><span class="pun" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(102, 102, 0);">=</span><span class="pln" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(0, 0, 0);"> pmd_offset</span><span class="pun" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(102, 102, 0);">(</span><span class="pln" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(0, 0, 0);">pgd</span><span class="pun" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(102, 102, 0);">,</span><span class="pln" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(0, 0, 0);"> address</span><span class="pun" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(102, 102, 0);">);</span></code></p></li><li><p><code style="font-family: Courier, monospace;font-size: 10.805398941040039px;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;background-color: transparent;border: 0px;border-top-left-radius: 3px;border-top-right-radius: 3px;border-bottom-right-radius: 3px;border-bottom-left-radius: 3px;color: inherit;"><span class="pln" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(0, 0, 0);">pte </span><span class="pun" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(102, 102, 0);">=</span><span class="pln" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(0, 0, 0);"> </span><span class="pun" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(102, 102, 0);">*</span><span class="pln" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(0, 0, 0);">pte_offset_map</span><span class="pun" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(102, 102, 0);">(</span><span class="pln" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(0, 0, 0);">pmd</span><span class="pun" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(102, 102, 0);">,</span><span class="pln" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(0, 0, 0);"> address</span><span class="pun" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(102, 102, 0);">);</span></code></p></li><li><p><code style="font-family: Courier, monospace;font-size: 10.805398941040039px;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;background-color: transparent;border: 0px;border-top-left-radius: 3px;border-top-right-radius: 3px;border-bottom-right-radius: 3px;border-bottom-left-radius: 3px;color: inherit;"><span class="pln" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(0, 0, 0);">page </span><span class="pun" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(102, 102, 0);">=</span><span class="pln" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(0, 0, 0);"> pte_page</span><span class="pun" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(102, 102, 0);">(</span><span class="pln" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(0, 0, 0);">pte</span><span class="pun" style="font-family: inherit;font-size: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: inherit;vertical-align: baseline;color: rgb(102, 102, 0);">);</span></code></p></li></ol></pre><blockquote style="white-space: normal;margin: 20px auto;padding-right: 1.03em;padding-left: 1.03em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: inherit;vertical-align: baseline;quotes: none;border-left-width: 2px;border-left-style: dotted;border-left-color: rgb(220, 222, 224);color: rgb(102, 102, 102);letter-spacing: 1px;"><p style="margin-top: 10px;margin-bottom: 10px;font-family: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;white-space: pre-wrap;word-wrap: break-word;overflow: hidden;text-indent: 1.16em;"><span style="caret-color: rgb(102, 102, 102);color: rgb(102, 102, 102);font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;letter-spacing: 1px;white-space: pre-wrap;background-color: rgb(252, 252, 252);">Similarly, any kernel function which affects a range of virtual addresses must implement a depth-first traversal of the relevant portion of the three-level tree. Most of these traversals of the page table tree have been isolated behind functions, but it is still surprising how many places are coded around the three-level assumption. But it all works fine, since the architecture-specific code makes it looks like all systems have three-level page tables.</span></p></blockquote><p style="white-space: normal;margin-bottom: 0.67em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;text-indent: 1.16em;caret-color: rgb(64, 64, 64);color: rgb(64, 64, 64);letter-spacing: 1px;">基于以上机制，如果一个内核函数需要访问一段虚拟地址范围的话，则需要对三级页表的相关部分按照深度优先的方式进行遍历。绝大部分的遍历逻辑已经被封装在相应函数中，但是内核中仍然存在很多自己遍历的代码，而且都是基于三级模型的假设。庆幸的是目前它们都还工作正常，这可能主要要归功于体系架构方面的代码，它们对内核通用部分的封装使得所有的系统看起来似乎都是以三级页表的方式工作的。</p><blockquote style="white-space: normal;margin: 20px auto;padding-right: 1.03em;padding-left: 1.03em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: inherit;vertical-align: baseline;quotes: none;border-left-width: 2px;border-left-style: dotted;border-left-color: rgb(220, 222, 224);color: rgb(102, 102, 102);letter-spacing: 1px;"><p style="margin-top: 10px;margin-bottom: 10px;font-family: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;white-space: pre-wrap;word-wrap: break-word;overflow: hidden;text-indent: 1.16em;"><span style="caret-color: rgb(102, 102, 102);color: rgb(102, 102, 102);font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;letter-spacing: 1px;white-space: pre-wrap;background-color: rgb(252, 252, 252);">The only problem is that some hardware actually supports four-level tables. The example which is driving the current changes is x86-64. The current x86-64 port emulates a three-level architecture by using a single, shared, top-level directory (“PML4”) and fitting (most of) the virtual address space in a three-level tree pointed to by a single PML4 entry. It all works, but it limits Linux processes to a mere 512GB of virtual address space. Such limits are irksome to the kernel developers when the hardware can do more, and, besides, somebody is likely to release a web browser or office suite which runs into that limit in the near future.</span></p></blockquote><p style="white-space: normal;margin-bottom: 0.67em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;text-indent: 1.16em;caret-color: rgb(64, 64, 64);color: rgb(64, 64, 64);letter-spacing: 1px;">目前唯一的问题是某些硬件实际上是按照四级页表方式工作的。譬如 x86-64，这也是目前推动内核进一步升级的原因。当前移植 x86-64 的代码中定义了一个共享的顶级表（“PML4”），其每一项都指向一个三层的页表结构，通过这种方式对 Linux 内核模拟三级页表模型，以支持（大部分的）虚拟地址空间。但该方式存在一个问题，就是会限制一个 Linux 进程的虚拟地址空间不能超过 512GB。对内核开发人员来说，这是一个令人讨厌的限制，因为这导致我们无法充分发挥硬件的潜能。而且，很有可能在不久的将来，就会出现一个 Web 浏览器或者办公软件在内存需求上会突破这个限制。</p><blockquote style="white-space: normal;margin: 20px auto;padding-right: 1.03em;padding-left: 1.03em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: inherit;vertical-align: baseline;quotes: none;border-left-width: 2px;border-left-style: dotted;border-left-color: rgb(220, 222, 224);color: rgb(102, 102, 102);letter-spacing: 1px;"><p style="margin-top: 10px;margin-bottom: 10px;font-family: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;white-space: pre-wrap;word-wrap: break-word;overflow: hidden;text-indent: 1.16em;"><span style="caret-color: rgb(102, 102, 102);color: rgb(102, 102, 102);font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;letter-spacing: 1px;white-space: pre-wrap;background-color: rgb(252, 252, 252);">The solution is to shift the kernel over to using four-level page tables everywhere, with the fourth level emulated (and optimized out of existence) on architectures which do not support it. Andi Kleen has posted a four-level page tables patch which implements this change. With Andi’s patch, the x86-64 architecture implements a 512-entry PML4 directory, 512-entry PGD, 512-entry PMD, and 512-entry PTE. After various deductions, that is sufficient to implement a 128TB address space, which should last for a little while.</span></p></blockquote><p style="white-space: normal;margin-bottom: 0.67em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;text-indent: 1.16em;caret-color: rgb(64, 64, 64);color: rgb(64, 64, 64);letter-spacing: 1px;">看起来目前有必要将内核的通用页表模型升级到四级，对物理上不支持四级的体系架构则在软件上对第四级进行模拟（编译优化使其实际并不存在）。基于以上思路，Andi Kleen 开发了一个四级页表补丁。在该补丁中，x86-64 架构上的页表实现方式为：第四级 PML4 表包含 512项，第三级 PGD 表 包含 512 项，第二级 PMD 表包含 512 项、第一级 PTE 表包含 512 项。按以上方式计算，至少可以支持 128TB 的地址空间，这应该够我们用一段时间的了。</p><blockquote style="white-space: normal;margin: 20px auto;padding-right: 1.03em;padding-left: 1.03em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: inherit;vertical-align: baseline;quotes: none;border-left-width: 2px;border-left-style: dotted;border-left-color: rgb(220, 222, 224);color: rgb(102, 102, 102);letter-spacing: 1px;"><p style="margin-top: 10px;margin-bottom: 10px;font-family: inherit;font-style: inherit;font-variant-caps: inherit;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;white-space: pre-wrap;word-wrap: break-word;overflow: hidden;text-indent: 1.16em;"><span style="caret-color: rgb(102, 102, 102);color: rgb(102, 102, 102);font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;letter-spacing: 1px;white-space: pre-wrap;background-color: rgb(252, 252, 252);">The actual patch works as one might expect; code which currently handles three-level page tables is extended to deal with the fourth level. There is a default PML4 implementation which can be included by architectures which do not have four-level tables; that should make porting most architectures to the new scheme relatively easy. That work is likely to happen in the near future, after which Andi has stated his intention to get the four-level patch merged into the -mm tree. Andrew Morton has already said (at the kernel summit) that he would consider merging such a patch. Your Linux system may be running with four-level page tables in the near future.</span></p></blockquote><p style="white-space: normal;margin-bottom: 0.67em;font-family: &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimSun, 宋体, Heiti, 黑体;font-size: 13.34000015258789px;font-stretch: inherit;line-height: 21.3439998626709px;vertical-align: baseline;text-indent: 1.16em;caret-color: rgb(64, 64, 64);color: rgb(64, 64, 64);letter-spacing: 1px;">补丁的运行效果看上去还不错; 当前处理三级页表的代码被扩展为支持处理第四级（即 PML4）。补丁中提供了一个缺省的 PML4 的实现，没有四级页表的架构可以直接使用（译者注，指用其模拟第四级）；这使得大多数体系架构移植到新方案上时相对容易。移植工作很快就会展开，Andi 表示他打算在移植工作完成后将他的四级页表补丁合并到 “-mm” 代码仓库中。Andrew Morton 也已经（在内核峰会上）表示他会考虑合并该补丁。您的 Linux 系统很可能在不久的将来就会使用四级页表。</p><p><span style="color: rgb(255, 169, 0);background-color: rgb(255, 254, 213);">本文转发自：http://tinylab.org/lwn-106177-four-level-pt/?from=groupmessage&amp;isappinstalled=0</span><span style="color: rgb(255, 169, 0);"><span style="color: rgb(255, 169, 0);background-color: rgb(255, 218, 169);"></span></span></p>
                </div>
                

                
  <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display: none;"></div>


                
                <div class="read-more__area" id="js_more_read_area" style="display:none;">
                    
                </div>

                
                                <div class="reward_area tc reward_area_primary" id="js_preview_reward_author" style="display:none;">
                    <div class="reward-avatar" style="display: none;" id="js_preview_reward_author_avatar">
                        <img src="" alt="" id="js_preview_reward_author_head">
                    </div>
                    
                                        <div class="reward-author" id="js_preview_reward_author_name">Wang Chen</div>
                                        <p class="reward_tips" id="js_preview_reward_author_wording" style="display:none;"></p>
                    <p class="reward_button_wrp">
                    
                      <span class="reward_pop_panel">
                        <img src="https://res.wx.qq.com/mpres/zh_CN/htmledition/pages/home/index/pic_mp_app4290ba.png" alt="">
                        <strong>扫一扫下载订阅号助手，用手机发文章</strong>
                      </span>
                        <a class="reward_button" id='js_preview_reward_author_link' href="##"><span id="js_preview_reward_link_text">赞赏</span></a>
                    </p>
                </div>

                <div class="reward_qrcode_area reward_area tc" id="js_preview_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                    <p id="js_preview_reward_ios_wording" class="reward_tips" style="display:none;"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" src="res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_reward_qrcode.2x42f400.png"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                            </div>
		<div class="comment">
			<h3 style="margin:26px 0;font-weight:100;padding-bottom:4px;border-bottom:1px solid #ccc;">精选留言</h3>
		    暂无...
		</div>
	</div>
	<div class='dy_all'>
		<a href='http://tinylab.org/lwn-106177-four-level-pt/?from=groupmessage\x26amp;isappinstalled=0' target='_blank'>
			阅读全文
		</a>
	</div>
</body>