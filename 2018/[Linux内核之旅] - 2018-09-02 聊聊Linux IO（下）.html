<!DOCTYPE html>
<head>
	<meta http-equiv='Content-Type' content='text/html;charset=utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no'>
	<title>
		聊聊Linux IO（下）
	</title>
	<script src='https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js'>
	</script>
	<style>
		a {color: #607fa6;text-decoration:none;word-wrap:break-word;word-break:break-all;}.rich_media_title{padding-bottom:10px;margin-bottom:14px;border-bottom:1px solid #e7e7eb;font-weight:400;} .rich_media_meta_list{font-size:14px;margin-bottom: 22px;}
		.rich_media_meta{display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:14px;}.rich_media_meta_text{color:#8c8c8c;color:rgba(0, 0, 0, 0.3)}.rich_media_meta_list
		em {font-style: normal;}@media screen and (max-width:768px){.rich_media{position:
		relative;padding: 20px 15px 15px;background-color: #fff;}}.rich_media_content{text-align:justify;} .rich_media_content * {max-width:100%!important;box-sizing: border-box!important;-webkit-box-sizing:
		border-box!important;word-wrap: break-word!important;}.rich_media_content
		blockquote {margin: 0;padding-left: 10px;border-left: 3px solid #dbdbdb;}.rich_media_content
		.list-paddingleft-2 {padding-left: 2.2em;}a.rich_media_meta_nickname{display: none;}@media screen and (min-width:1025px){.rich_media{position:relative;}a.rich_media_meta_nickname{display:inline-block!important;}span.rich_media_meta_nickname
		{display: inline-block!important;}.rich_media {width:677px;margin-left:auto;margin-right:auto;}}a.fwjm{font-size: 12px;color: #ececec;}.tenvideo_player {position: relative;width:
		100 %;height: 100 %;margin: auto;background: #000;}* {margin:0px;padding:0px;} body{line-height: 1.6;letter-spacing: .034em;}
		.dy_all {text-align: center;margin: 30px 0;} .dy_all a {display: inline-block;height:
		38px;line-height: 38px;padding: 0 18px;background-color: #009688;color:
		#fff;white-space: nowrap;font-size: 14px;border: none;border-radius: 2px;cursor:
		pointer;text-align: center;outline: 0;-webkit-appearance: none;transition:
		all .3s;-webkit-transition: all .3s;box-sizing: border-box;} img{max-width: 677px!important;}

		.crawler-info{padding: 8px 0;} .article-link>img{margin-left: 20px;width: 16px;}
		.comment-item::before,.comment-item::after{content:'';display:block;height:0;visibility:hidden;clear:both;*zoom:1;} .comment-item{margin-bottom:30px;}
		.avatar{width:12%; padding-right:10px;float:left;box-sizing:border-box;} .avatar img{width:100%;}
		.comment-body{float:left;width:88%;} .comment-body .comment-info{color:#b3b3b3;margin-bottom:4px;margin-top: -5px;} .comment-body .comment-info>span:last-child{float:right;} 
		.comment-author{border-left:4px solid green;padding-left:6px;margin:8px 0;}

		@media screen and (max-width: 420px) {.article-link>img {margin-left: 0px;}}
		@media screen and (min-width: 480px) {.avatar {width: 9%;}.comment-body {width: 91%;}}
	</style>
</head>
<body>
	<div id='js_article' class='rich_media'>
		<div class="crawler-info">
			<a href='https://www.52pojie.cn' class='fwjm' target='_blank'>
				提供的爬取软件来源于：52pojie.cn@夜泉 免费下载使用
			</a>
			<a href='https://mp.weixin.qq.com/s?__biz=MzI3NzA5MzUxNA==&amp;mid=2664605648&amp;idx=1&amp;sn=a34438c0c1eda0a7471e94e6fc3c84fd&amp;chksm=f04d8a35c73a032357ada37dcc409b47c7e183aa5e2bcf4adbb8730549cf6b02dbbad737e4e8&amp;scene=27#wechat_redirect&cpage=16' target='_blank' class="article-link">
				<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAQCAMAAABA3o1rAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjk4QUEzQzVDNkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjk4QUEzQzVENkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OThBQTNDNUE2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OThBQTNDNUI2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5TKSKsAAAAclBMVEUuLi77+/stLS1VVVXx8fFOTk7s7Ozt7e1qamp5eXlNTU2WlpZFRUU6Ojrq6urn5+d/f3/8/Pw9PT0/Pz+YmJg8PDyZmZlAQECfn5+QkJBBQUFra2vo6OhDQ0OSkpKenp5WVlY+Pj7r6+tpaWksLCz///9o6ILHAAAAJnRSTlP/////////////////////////////////////////////////AKd6gbwAAACNSURBVHjajJHpEoIwDISDVMotcnuCmLz/K9KCdlqO6v7p7Mw3yW4KxG85fnUkIVfZ5J0SsCtqcgRw0HzjQYY2AAOIdRuaK4ReAPJ5nmglL5qICahpU60C0uXguQ9TgIwGJoDnT9z/ABmxt60ot0N2CsDLfb9mvBxs9ql+n5o9bEDBgbif7/1F4g80CjAAqrVAnnsm5f8AAAAASUVORK5CYII=" />
			</a>
		</div>
		<div id="img-content">

                
                <h2 class="rich_media_title" id="activity-name">聊聊Linux IO（下）</h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                                                                            <span class="rich_media_meta rich_media_meta_text">
                                                        浅墨
                                                    </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);">Linux内核之旅</a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">Linux内核之旅</strong>
                              <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">LinuxKernelTravel</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">Linux内核之旅</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>


                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2018-09-02</em>





                </div>

                
                
                                
                
                
                
                                                
                                                                
                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <h3 style="white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1.3em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;font-size: 22.399999618530273px;vertical-align: baseline;line-height: 1em;color: rgb(51, 51, 51);-webkit-font-smoothing: antialiased;">Page Cache 的同步</h3><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">广义上Cache的同步方式有两种，即<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Write Through（写穿）</code>和<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Write back（写回）</code>. 从名字上就能看出这两种方式都是从写操作的不同处理方式引出的概念（纯读的话就不存在Cache一致性了，不是么）。对应到Linux的<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Page Cache</code>上所谓<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Write Through</code>就是指<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">write(2)</code>操作将数据拷贝到<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Page Cache</code>后立即和下层进行同步的写操作，完成下层的更新后才返回。而<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Write back</code>正好相反，指的是写完<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Page Cache</code>就可以返回了。<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Page Cache</code>到下层的更新操作是异步进行的。</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">Linux下<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Buffered IO</code>默认使用的是<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Write back</code>机制，即文件操作的写只写到<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Page Cache</code>就返回，之后<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Page Cache</code>到磁盘的更新操作是异步进行的。<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Page Cache</code>中被修改的内存页称之为脏页（Dirty Page），脏页在特定的时候被一个叫做<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">pdflush(Page Dirty Flush)</code>的内核线程写入磁盘，写入的时机和条件如下：</p><ul style="list-style-type: none;" class=" list-paddingleft-2"><li><p>当空闲内存低于一个特定的阈值时，内核必须将脏页写回磁盘，以便释放内存。</p></li><li><p>当脏页在内存中驻留时间超过一个特定的阈值时，内核必须将超时的脏页写回磁盘。</p></li><li><p>用户进程调用<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">sync(2)</code>、<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">fsync(2)</code>、<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">fdatasync(2)</code>系统调用时，内核会执行相应的写回操作。</p></li></ul><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);"><span style="font-size: 16px;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;background-color: rgb(250, 250, 250);">刷新策略由以下几个参数决定（数值单位均为1/100秒）：</span></p><pre style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 0px;margin-bottom: 0px;padding: 0px;border: none;outline: 0px;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 0.9em;vertical-align: baseline;background-color: rgb(45, 45, 45);color: rgb(204, 204, 204);line-height: 1.5;border-top-left-radius: 0.35em;border-top-right-radius: 0.35em;border-bottom-right-radius: 0.35em;border-bottom-left-radius: 0.35em;word-wrap: break-word;caret-color: rgb(204, 204, 204);"><p># flush每隔5秒执行一次</p><p>root@082caa3dfb1d / $ sysctl vm.dirty_writeback_centisecs</p><p>vm.dirty_writeback_centisecs = 500</p><p># 内存中驻留30秒以上的脏数据将由flush在下一次执行时写入磁盘</p><p>root@082caa3dfb1d / $ sysctl vm.dirty_expire_centisecs</p><p>vm.dirty_expire_centisecs = 3000</p><p># 若脏页占总物理内存10％以上，则触发flush把脏数据写回磁盘</p><p>root@082caa3dfb1d / $ sysctl vm.dirty_background_ratio</p><p>vm.dirty_background_ratio = 10</p></pre><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);"><span style="font-size: 16px;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;background-color: rgb(250, 250, 250);"></span></p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">默认是写回方式，如果想指定某个文件是写穿方式呢？即写操作的可靠性压倒效率的时候，能否做到呢？当然能，除了之前提到的<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">fsync(2)</code>之类的系统调用外，在<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">open(2)</code>打开文件时，传入<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">O_SYNC</code>这个flag即可实现。这里给篇参考文章[5]，不再赘述（更好的选择是去读TLPI相关章节）。</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">文件读写遭遇断电时，数据还安全吗？相信你有自己的答案了。使用<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">O_SYNC</code>或者<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">fsync(2)</code>刷新文件就能保证安全吗？现代磁盘一般都内置了缓存，代码层面上也只能讲数据刷新到磁盘的缓存了。当数据已经进入到磁盘的高速缓存时断电了会怎么样？这个恐怕不能一概而论了。不过可以使用<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">hdparm -W0</code>命令关掉这个缓存，相应的，磁盘性能必然会降低。</p><h3 style="white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1.3em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;font-size: 22.399999618530273px;vertical-align: baseline;line-height: 1em;color: rgb(51, 51, 51);-webkit-font-smoothing: antialiased;">文件操作与锁</h3><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">当多个进程/线程对同一个文件发生写操作的时候会发生什么？如果写的是文件的同一个位置呢？这个问题讨论起来有点复杂了。首先<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">write(2)</code>调用不是原子操作，不要被TLPI的中文版5.2章节的第一句话误导了（英文版也是有歧义的，作者在这里给出了勘误信息）。当多个<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">write(2)</code>操作对一个文件的同一部分发起写操作的时候，情况实际上和多个线程访问共享的变量没有什么区别。按照不同的逻辑执行流，会有很多种可能的结果。也许大多数情况下符合预期，但是本质上这样的代码是不可靠的。</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">特别的，文件操作中有两个操作是内核保证原子的。分别是<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">open(2)</code>调用的<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">O_CREAT</code>和<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">O_APPEND</code>这两个flag属性。前者是文件不存在就创建，后者是每次写文件时把文件游标移动到文件最后追加写（NFS等文件系统不保证这个flag）。有意思的问题来了，以<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">O_APPEND</code>方式打开的文件<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">write(2)</code>操作是不是原子的？文件游标的移动和调用写操作是原子的，那写操作本身会不会发生改变呢？有的开源软件比如apache写日志就是这样写的，这是可靠安全的吗？坦白讲我也不清楚，有人说<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Then O_APPEND is atomic and write-in-full for all reasonably-sized&gt; writes to regular files.</code>但是我也没有找到很权威的说法。这里给出一个邮件列表上的讨论，可以参考下[6]。今天先放过去，后面有时间的话专门研究下这个问题。如果你能给出很明确的说法和证明，还望不吝赐教。</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">Linux下的文件锁有两种，分别是<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">flock(2)</code>的方式和<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">fcntl(2)</code>的方式，前者源于BSD，后者源于System V，各有限制和应用场景。老规矩，TLPI上讲的很清楚的这里不赘述。我个人是没有用过文件锁的，系统设计的时候一般会避免多个执行流写一个文件的情况，或者在代码逻辑上以mutex加锁，而不是直接加锁文件本身。数据库场景下这样的操作可能会多一些（这个纯属臆测），这就不是我了解的范畴了。</p><h3 style="white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1.3em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;font-size: 22.399999618530273px;vertical-align: baseline;line-height: 1em;color: rgb(51, 51, 51);-webkit-font-smoothing: antialiased;">磁盘的性能测试</h3><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">在具体的机器上跑服务程序，如果涉及大量IO的话，首先要对机器本身的磁盘性能有明确的了解，包括不限于IOPS、IO Depth等等。这些数据不仅能指导系统设计，也能帮助资源规划以及定位系统瓶颈。比如我们知道机械磁盘的连续读写性能一般不会超过120M/s，而普通的SSD磁盘随意就能超过机械盘几倍（商用SSD的连续读写速率达到2G+/s不是什么新鲜事）。另外由于磁盘的工作原理不同，机械磁盘需要旋转来寻找数据存放的磁道，所以其随机存取的效率受到了“寻道时间”的严重影响，远远小于连续存取的效率；而SSD磁盘读写任意扇区可以认为是相同的时间，随机存取的性能远远超过机械盘。所以呢，在机械磁盘作为底层存储时，如果一个线程写文件很慢的话，多个线程分别去写这个文件的各个部分能否加速呢？不见得吧？如果这个文件很大，各个部分的寻道时间带来极大的时间消耗的话，效率就很低了（先不考虑<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">Page Cache</code>）。SSD呢？可以明确，设计合理的话，SSD多线程读写文件的效率会高于单线程。当前的SSD盘很多都以高并发的读取为卖点的，一个线程压根就喂不饱一块SSD盘。一般SSD的IO Depth都在32甚至更高，使用32或者64个线程才能跑满一个SSD磁盘的带宽（同步IO情况下）。</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">具体的SSD原理不在本文计划内，这里给出一篇详细的参考文章[7]。有时候一些文章中所谓的STAT磁盘一般说的就是机械盘（虽然STAT本身只是一个总线接口）。接口会影响存储设备的最大速率，基本上是<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">STAT -&gt; PCI-E -&gt; NVMe</code>的发展路径，具体请自行Google了解。</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">具体的设备一般使用<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">fio</code>工具[8]来测试相关磁盘的读写性能。fio的介绍和使用教程有很多[9]，不再赘述。这里不想贴性能数据的原因是存储介质的发展实在太快了，一方面不想贴某些很快就过时的数据以免让初学者留下不恰当的第一印象，另一方面也希望读写自己实践下fio命令。</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">前文提到存储介质的原理会影响程序设计，我想稍微的解释下。这里说的“影响”不是说具体的读写能到某个速率，程序中就依赖这个数值，换个工作环境就性能大幅度降低（当然，为专门的机型做过优化的结果很可能有这个副作用）。而是说根据存储介质的特性，程序的设计起码要遵循某个设计套路。举个简单的例子，SATA机械盘的随机存取很慢，那系统设计时，就要尽可能的避免随机的IO出现，尽可能的转换成连续的文件存取来加速运行。比如Google的LevelDB就是转换随机的Key-Value写入为Binlog（连续文件写入）+ 内存插入MemTable（内存随机读写可以认为是O(1)的性能），之后批量dump到磁盘（连续文件写入）。这种<code style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;border: 1px solid rgb(214, 214, 214);outline: 0px;font-style: inherit;font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size: 14.399999618530273px;vertical-align: baseline;background-color: rgb(238, 238, 238);color: rgb(221, 17, 68);white-space: nowrap;text-shadow: rgb(255, 255, 255) 0px 1px;border-top-left-radius: 0.25em;border-top-right-radius: 0.25em;border-bottom-right-radius: 0.25em;border-bottom-left-radius: 0.25em;">LSM-Tree</code>的设计便是合理的利用了存储介质的特性，做到了最大化的性能利用（磁盘换成SSD也依旧能有很好的运行效率）。</p><h3 style="white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1.3em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;font-size: 22.399999618530273px;vertical-align: baseline;line-height: 1em;color: rgb(51, 51, 51);-webkit-font-smoothing: antialiased;">写在最后</h3><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">每天抽出不到半个小时，零零散散地写了一周，这是说是入门都有些谬赞了，只算是对Linux下的IO机制稍微深入的介绍了一点。无论如何，希望学习完Linux系统编程的同学，能继续的往下走一走，尝试理解系统调用背后隐含的机制和原理。探索的结果无所谓，重要的是探索的过程以及相关的学习经验和方法。前文提出的几个问题我并没有刻意去解答所有的，但是读到现在，不知道你自己能回答上几个了？</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);"><br style="-webkit-margin-before: 0px;-webkit-margin-after: 0px;"  /></p><h4 style="white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;font-size: 22.399999618530273px;vertical-align: baseline;color: rgb(51, 51, 51);-webkit-font-smoothing: antialiased;">参考文献</h4><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">[1] 图片引自《Computer Systems: A Programmer’s Perspective》Chapter 6 The Memory Hierarchy, 另可参考&nbsp;https://zh.wikipedia.org/wiki/%E5%AD%98%E5%82%A8%E5%99%A8%E5%B1%B1</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">[2] Locality of reference，https://en.wikipedia.org/wiki/Locality_of_reference</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">[3] 图片引自《The Linux Programming Interface》Chapter 13 FILE I/O BUFFERING</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">[4] Linux Storage Stack Diagram,&nbsp;&nbsp;https://www.thomas-krenn.com/en/wiki/Linux_Storage_Stack_Diagram</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">[5] O_DIRECT和O_SYNC详解,&nbsp;http://www.cnblogs.com/suzhou/p/5381738.html</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">[6]&nbsp;http://librelist.com/browser/usp.ruby/2013/6/5/o-append-atomicity/</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">[7] Coding for SSD,&nbsp;&nbsp;https://dirtysalt.github.io/coding-for-ssd.html</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">[8] fio作者Jens Axboe是Linux内核IO部分的maintainer，工具主页&nbsp;http://freecode.com/projects/fio/</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">[9] How to benchmark disk,&nbsp;https://www.binarylane.com.au/support/solutions/articles/1000055889-how-to-benchmark-disk-i-o</p><p style="font-size: 16px;white-space: normal;-webkit-margin-before: 0px;-webkit-margin-after: 0px;margin-top: 1em;border: 0px;outline: 0px;font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, Arial, sans-serif;vertical-align: baseline;caret-color: rgb(65, 63, 63);color: rgb(65, 63, 63);">[10] 深入Linux内核架构, （德）莫尔勒, 人民邮电出版社</p><p><br  /></p><p><span style="color: rgb(255, 169, 0);">（已完结）</span></p><p><br  /></p><p><br  /></p>
                </div>
                

                
  <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display: none;"></div>


                
                <div class="read-more__area" id="js_more_read_area" style="display:none;">
                    
                </div>

                
                                <div class="reward_area tc reward_area_primary" id="js_preview_reward_author" style="display:none;">
                    <div class="reward-avatar" style="display: none;" id="js_preview_reward_author_avatar">
                        <img src="" alt="" id="js_preview_reward_author_head">
                    </div>
                    
                                        <div class="reward-author" id="js_preview_reward_author_name">浅墨</div>
                                        <p class="reward_tips" id="js_preview_reward_author_wording" style="display:none;"></p>
                    <p class="reward_button_wrp">
                    
                      <span class="reward_pop_panel">
                        <img src="https://res.wx.qq.com/mpres/zh_CN/htmledition/pages/home/index/pic_mp_app4290ba.png" alt="">
                        <strong>扫一扫下载订阅号助手，用手机发文章</strong>
                      </span>
                        <a class="reward_button" id='js_preview_reward_author_link' href="##"><span id="js_preview_reward_link_text">赞赏</span></a>
                    </p>
                </div>

                <div class="reward_qrcode_area reward_area tc" id="js_preview_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                    <p id="js_preview_reward_ios_wording" class="reward_tips" style="display:none;"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" src="res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_reward_qrcode.2x42f400.png"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                            </div>
		<div class="comment">
			<h3 style="margin:26px 0;font-weight:100;padding-bottom:4px;border-bottom:1px solid #ccc;">精选留言</h3>
		    暂无...
		</div>
	</div>
	<div class='dy_all'>
		<a href='http://0xffffff.org/2017/05/01/41-linux-io/#more' target='_blank'>
			阅读全文
		</a>
	</div>
</body>