<!DOCTYPE html>
<head>
	<meta http-equiv='Content-Type' content='text/html;charset=utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no'>
	<title>
		Linux中常见同步机制设计原理
	</title>
	<script src='https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js'>
	</script>
	<style>
		a {color: #607fa6;text-decoration:none;word-wrap:break-word;word-break:break-all;}.rich_media_title{padding-bottom:10px;margin-bottom:14px;border-bottom:1px solid #e7e7eb;font-weight:400;} .rich_media_meta_list{font-size:14px;margin-bottom: 22px;}
		.rich_media_meta{display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:14px;}.rich_media_meta_text{color:#8c8c8c;color:rgba(0, 0, 0, 0.3)}.rich_media_meta_list
		em {font-style: normal;}@media screen and (max-width:768px){.rich_media{position:
		relative;padding: 20px 15px 15px;background-color: #fff;}}.rich_media_content{text-align:justify;} .rich_media_content * {max-width:100%!important;box-sizing: border-box!important;-webkit-box-sizing:
		border-box!important;word-wrap: break-word!important;}.rich_media_content
		blockquote {margin: 0;padding-left: 10px;border-left: 3px solid #dbdbdb;}.rich_media_content
		.list-paddingleft-2 {padding-left: 2.2em;}a.rich_media_meta_nickname{display: none;}@media screen and (min-width:1025px){.rich_media{position:relative;}a.rich_media_meta_nickname{display:inline-block!important;}span.rich_media_meta_nickname
		{display: inline-block!important;}.rich_media {width:677px;margin-left:auto;margin-right:auto;}}a.fwjm{font-size: 12px;color: #ececec;}.tenvideo_player {position: relative;width:
		100 %;height: 100 %;margin: auto;background: #000;}* {margin:0px;padding:0px;} body{line-height: 1.6;letter-spacing: .034em;}
		.dy_all {text-align: center;margin: 30px 0;} .dy_all a {display: inline-block;height:
		38px;line-height: 38px;padding: 0 18px;background-color: #009688;color:
		#fff;white-space: nowrap;font-size: 14px;border: none;border-radius: 2px;cursor:
		pointer;text-align: center;outline: 0;-webkit-appearance: none;transition:
		all .3s;-webkit-transition: all .3s;box-sizing: border-box;} img{max-width: 677px!important;}

		.crawler-info{padding: 8px 0;} .article-link>img{margin-left: 20px;width: 16px;}
		.comment-item::before,.comment-item::after{content:'';display:block;height:0;visibility:hidden;clear:both;*zoom:1;} .comment-item{margin-bottom:30px;}
		.avatar{width:12%; padding-right:10px;float:left;box-sizing:border-box;} .avatar img{width:100%;}
		.comment-body{float:left;width:88%;} .comment-body .comment-info{color:#b3b3b3;margin-bottom:4px;margin-top: -5px;} .comment-body .comment-info>span:last-child{float:right;} 
		.comment-author{border-left:4px solid green;padding-left:6px;margin:8px 0;}

		@media screen and (max-width: 420px) {.article-link>img {margin-left: 0px;}}
		@media screen and (min-width: 480px) {.avatar {width: 9%;}.comment-body {width: 91%;}}
	</style>
</head>
<body>
	<div id='js_article' class='rich_media'>
		<div class="crawler-info">
			<a href='https://www.52pojie.cn' class='fwjm' target='_blank'>
				提供的爬取软件来源于：52pojie.cn@夜泉 免费下载使用
			</a>
			<a href='https://mp.weixin.qq.com/s?__biz=MzI3NzA5MzUxNA==&amp;mid=2664605991&amp;idx=1&amp;sn=dff68876b3f71e66572584362ce7a600&amp;chksm=f04d84c2c73a0dd4da9a04237a9c19c429a21d58b9ad1f6e9802758bc553e2aac533313604bb&amp;scene=27#wechat_redirect&cpage=12' target='_blank' class="article-link">
				<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAQCAMAAABA3o1rAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjk4QUEzQzVDNkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjk4QUEzQzVENkNGQjExRTk5NzNBQ0VBMjgzMjY1NjkwIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OThBQTNDNUE2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OThBQTNDNUI2Q0ZCMTFFOTk3M0FDRUEyODMyNjU2OTAiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5TKSKsAAAAclBMVEUuLi77+/stLS1VVVXx8fFOTk7s7Ozt7e1qamp5eXlNTU2WlpZFRUU6Ojrq6urn5+d/f3/8/Pw9PT0/Pz+YmJg8PDyZmZlAQECfn5+QkJBBQUFra2vo6OhDQ0OSkpKenp5WVlY+Pj7r6+tpaWksLCz///9o6ILHAAAAJnRSTlP/////////////////////////////////////////////////AKd6gbwAAACNSURBVHjajJHpEoIwDISDVMotcnuCmLz/K9KCdlqO6v7p7Mw3yW4KxG85fnUkIVfZ5J0SsCtqcgRw0HzjQYY2AAOIdRuaK4ReAPJ5nmglL5qICahpU60C0uXguQ9TgIwGJoDnT9z/ABmxt60ot0N2CsDLfb9mvBxs9ql+n5o9bEDBgbif7/1F4g80CjAAqrVAnnsm5f8AAAAASUVORK5CYII=" />
			</a>
		</div>
		<div id="img-content">

                
                <h2 class="rich_media_title" id="activity-name">Linux中常见同步机制设计原理</h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                                                                            <span class="rich_media_meta rich_media_meta_text">
                                                        smcdef
                                                    </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);">Linux内核之旅</a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">Linux内核之旅</strong>
                              <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">LinuxKernelTravel</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">Linux内核之旅</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>


                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2018-12-07</em>





                </div>

                
                
                                
                
                
                
                                                
                                                                
                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <h2 style="color: rgb(31, 31, 31);font-size: 18px;font-weight: bold;padding: 0px;margin: 25px 0px 10px;font-family: Arial, Helvetica, sans-serif;font-style: normal;font-variant: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">引言</h2><p><span style="color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;display: inline !important;float: none;background-color: rgb(255, 255, 255);">今天谈谈linux中常见并发访问的保护机制设计原理。为什么要写这篇文章呢？其实想帮助自己及读者更深入的了解背后的原理（据可靠消息，锁的实现经常出现在笔试环节。既可以考察面试者对锁的原理的理解，又可以考察面试者编程技能）。我们抛开linux中汇编代码。用C语言为大家呈现背后实现的原理。同时，文章中的代码都没有考虑并发情况（例如某些操作需要原子性，或者数据需要保护等）。</span></p><blockquote style="margin: 0px 20px 20px;padding: 25px 20px;border-left-width: 5px;border-left-style: solid;border-left-color: rgb(105, 105, 105);border-right-width: 5px;border-right-style: solid;border-right-color: rgb(105, 105, 105);color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background: rgb(239, 239, 239);"><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;">注：部分代码都是根据ARM64架构汇编代码翻译成C语言并经过精简（例如：spin lock、read-write lock）。也有部分代码实现是为了呈现背后设计的原理自己编写的，而不是精简linux中实现的代码（例如mutex）。</p></blockquote><h2 style="color: rgb(31, 31, 31);font-size: 18px;font-weight: bold;padding: 0px;margin: 25px 0px 10px;font-family: Arial, Helvetica, sans-serif;font-style: normal;font-variant: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">自旋锁（spin lock）</h2><p><span style="color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;display: inline !important;float: none;background-color: rgb(255, 255, 255);">自旋锁是linux中使用非常频繁的锁，原理简单。当进程A申请锁成功后，进程B申请锁就会失败，但是不会调度，原地自旋。就在原地转到天昏地暗只为等到进程A释放锁。由于不会睡眠和调度的特性，在中断上下文中，数据的保护一般都是选择自旋锁。如果有多个进程去申请锁。当第一个申请锁成功的线程在释放的时候，其他进程是竞争的关系。因此是一种不公平。所以现在的linux采用的是排队机制。先到先得。谁先申请，谁就先得到锁。</span></p><h3 style="color: rgb(68, 68, 68);font-size: 14px;font-weight: bold;margin: 15px 0px 0px;padding: 8px 0px;font-family: Arial, Helvetica, sans-serif;font-style: normal;font-variant: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">原理</h3><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">举个例子，大家应该都去过银行办业务吧。银行的办事大厅一般会有几个窗口同步进行。今天很不巧，只有一个窗口提供服务。现在的银行服务都是采用取号排队，叫号服务的方式。当你去银行办理业务的时候，首先会去取号机器领取小票，上面写着你排多少号。然后你就可以排队等待了。一般还会有个显示屏，上面会显示一个数字（例如："请xxx号到1号窗口办理"），代表当前可以被服务顾客的排队号码。每办理完一个顾客的业务，显示屏上面的数字都会增加1。等待的顾客都会对比自己手上写的编号和显示屏上面是否一致，如果一致的话，就可以去前台办理业务了。现在早上刚开业，顾客A是今天的第一个顾客，去取号机器领取0号（next计数）小票，然后看到显示屏上显示0（owner计数），顾客A就知道现在轮到自己办理业务了。顾客A到前台办理业务（持有锁）中，顾客B来了。同样，顾客B去取号机器拿到1号（next计数）小票。然后乖乖的坐在旁边等候。顾客A依然在办理业务中，此时顾客C也来了。顾客C去取号机器拿到2号（next计数）小票。顾客C也乖乖的找个座位继续等待。终于，顾客A的业务办完了（释放锁）。然后，显示屏上面显示1（owner计数）。顾客B和C都对比显示屏上面的数字和自己手中小票的数字是否相等。顾客B终于可以办理业务了（持有锁）。顾客C依然等待中。顾客B的业务办完了（释放锁）。然后，显示屏上面显示2（owner计数）。顾客C终于开始办理业务（持有锁）。顾客C的业务办完了（释放锁）。3个顾客都办完了业务离开了。只留下一个银行柜台服务员。最终，显示屏上面显示3（owner计数）。取号机器的下一个排队号也是3号（next计数）。无人办理业务（锁是释放状态）。</p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="2.4659498207885306" data-s="300,640" src="data:image/JPG;base64,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 " src="SeWfibBcBT0GxEiaU11dKJWtOlLGpK0RicGkhRszsKib81Azc3Fuf1DUrDJEOEor084fIrLPmZA6Gz1FSBB9cb0icBw"  data-type="png" data-w="279" style="width: 171px;height: 422px;"  /></p><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">linux中针对每一个spin lock会有两个计数。分别是next和owner（初始值为0）。进程A申请锁时，会判断next和owner的值是否相等。如果相等就代表锁可以申请成功，否则原地自旋。直到owner和next的值相等才会退出自旋。假设进程A申请锁成功，然后会next加1。此时owner值为0，next值为1。进程B也申请锁，保存next得值到局部变量tmp（tmp = 1）中。由于next和owner值不相等，因此原地自旋读取owner的值，判断owner和tmp是否相等，直到相等退出自旋状态。当然next的值还是加1，变成2。进程A释放锁，此时会将owner的值加1，那么此时B进程的owner和tmp的值都是1，因此B进程获得锁。当B进程释放锁后，同样会将owner的值加1。最后owner和next都等于2，代表没有进程持有锁。next就是一个记录申请锁的次数，而owner是持有锁进程的计数值。<br  /></p><h3 style="color: rgb(68, 68, 68);font-size: 14px;font-weight: bold;margin: 15px 0px 0px;padding: 8px 0px;font-family: Arial, Helvetica, sans-serif;font-style: normal;font-variant: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">实现</h3><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">我们首先定义描述自旋锁的结构体arch_spinlock_t。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">typedef</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">union</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">unsigned</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">int</span><span class="pln" style="color: rgb(0, 0, 0);"> slock</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> __raw_tickets </span><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">			</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">unsigned</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">short</span><span class="pln" style="color: rgb(0, 0, 0);"> owner</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">			</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">unsigned</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">short</span><span class="pln" style="color: rgb(0, 0, 0);"> next</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		</span><span class="pun" style="color: rgb(102, 102, 0);">}</span><span class="pln" style="color: rgb(0, 0, 0);"> tickets</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="pun" style="color: rgb(102, 102, 0);">};</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">}</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">arch_spinlock_t</span><span class="pun" style="color: rgb(102, 102, 0);">;</span><span class="pln" style="color: rgb(0, 0, 0);"> </span></p></li></ol></pre></pre><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">如上面的原理描述，我们需要两个计数，分别是owner和next。slock所占内存区域覆盖owner和next（据说C语言学好的都能看得懂）。下面实现申请锁操作 arch_spin_lock。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">static</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">inline</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">void</span><span class="pln" style="color: rgb(0, 0, 0);"> arch_spin_lock</span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="typ" style="color: rgb(102, 0, 102);">arch_spinlock_t</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">*</span><span class="pln" style="color: rgb(0, 0, 0);">lock</span><span class="pun" style="color: rgb(102, 102, 0);">)</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="typ" style="color: rgb(102, 0, 102);">arch_spinlock_t</span><span class="pln" style="color: rgb(0, 0, 0);"> old_lock</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">&nbsp;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	old_lock</span><span class="pun" style="color: rgb(102, 102, 0);">.</span><span class="pln" style="color: rgb(0, 0, 0);">slock </span><span class="pun" style="color: rgb(102, 102, 0);">=</span><span class="pln" style="color: rgb(0, 0, 0);"> lock</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">slock</span><span class="pun" style="color: rgb(102, 102, 0);">;</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 1 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	lock</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">tickets</span><span class="pun" style="color: rgb(102, 102, 0);">.</span><span class="pln" style="color: rgb(0, 0, 0);">next</span><span class="pun" style="color: rgb(102, 102, 0);">++;</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 2 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">while</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="pln" style="color: rgb(0, 0, 0);">old_lock</span><span class="pun" style="color: rgb(102, 102, 0);">.</span><span class="pln" style="color: rgb(0, 0, 0);">tickets</span><span class="pun" style="color: rgb(102, 102, 0);">.</span><span class="pln" style="color: rgb(0, 0, 0);">next </span><span class="pun" style="color: rgb(102, 102, 0);">!=</span><span class="pln" style="color: rgb(0, 0, 0);"> old_lock</span><span class="pun" style="color: rgb(102, 102, 0);">.</span><span class="pln" style="color: rgb(0, 0, 0);">tickets</span><span class="pun" style="color: rgb(102, 102, 0);">.</span><span class="pln" style="color: rgb(0, 0, 0);">owner</span><span class="pun" style="color: rgb(102, 102, 0);">)</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">{</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="com" style="color: rgb(136, 0, 0);">/* 3 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		wfe</span><span class="pun" style="color: rgb(102, 102, 0);">();</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com" style="color: rgb(136, 0, 0);">/* 4 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		old_lock</span><span class="pun" style="color: rgb(102, 102, 0);">.</span><span class="pln" style="color: rgb(0, 0, 0);">tickets</span><span class="pun" style="color: rgb(102, 102, 0);">.</span><span class="pln" style="color: rgb(0, 0, 0);">owner </span><span class="pun" style="color: rgb(102, 102, 0);">=</span><span class="pln" style="color: rgb(0, 0, 0);"> lock</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">tickets</span><span class="pun" style="color: rgb(102, 102, 0);">.</span><span class="pln" style="color: rgb(0, 0, 0);">owner</span><span class="pun" style="color: rgb(102, 102, 0);">;</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 5 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="pun" style="color: rgb(102, 102, 0);">}</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">}</span><span class="pln" style="color: rgb(0, 0, 0);"> </span></p></li></ol></pre></pre><blockquote style="margin: 0px 20px 20px;padding: 25px 20px;border-left-width: 5px;border-left-style: solid;border-left-color: rgb(105, 105, 105);border-right-width: 5px;border-right-style: solid;border-right-color: rgb(105, 105, 105);color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background: rgb(239, 239, 239);"><ol style="" class=" list-paddingleft-2"><li><p>继续上面的举例。顾客从取号机器得到排队号。</p></li><li><p>取号机器更新下个顾客将要拿到的排队号。</p></li><li><p>看一下显示屏，判断是否轮到自己了。</p></li><li><p>wfe()函数是指ARM64架构的WFE(wait for event)汇编指令。WFE是让ARM核进入低功耗模式的指令。当进程拿不到锁的时候，原地自旋不如cpu睡眠。节能。睡下去之后，什么时候醒来呢？就是等到持有锁的进程释放的时候，醒过来判断是否可以持有锁。如果不能获得锁，继续睡眠即可。这里就相当于顾客先小憩一会，等到广播下一位排队者的时候，醒来看看是不是自己。</p></li><li><p>前台已经为上一个顾客办理完成业务，剩下排队的顾客都要抬头看一下显示屏是不是轮到自己了。</p></li></ol></blockquote><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">释放锁的操作就非常简单了。还记得上面银行办理业务的例子吗？释放锁的操作仅仅是显示屏上面的排队号加1。我们仅仅需要将owner计数加1即可。arch_spin_unlock实现如下。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">static</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">inline</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">void</span><span class="pln" style="color: rgb(0, 0, 0);"> arch_spin_unlock</span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="typ" style="color: rgb(102, 0, 102);">arch_spinlock_t</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">*</span><span class="pln" style="color: rgb(0, 0, 0);">lock</span><span class="pun" style="color: rgb(102, 102, 0);">)</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	lock</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">tickets</span><span class="pun" style="color: rgb(102, 102, 0);">.</span><span class="pln" style="color: rgb(0, 0, 0);">owner</span><span class="pun" style="color: rgb(102, 102, 0);">++;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	sev</span><span class="pun" style="color: rgb(102, 102, 0);">();</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">}</span><span class="pln" style="color: rgb(0, 0, 0);"> </span></p></li></ol></pre></pre><blockquote style="margin: 0px 20px 20px;padding: 25px 20px;border-left-width: 5px;border-left-style: solid;border-left-color: rgb(105, 105, 105);border-right-width: 5px;border-right-style: solid;border-right-color: rgb(105, 105, 105);color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background: rgb(239, 239, 239);"><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;">sev()函数是指ARM64架构的SEV汇编指令。当进程无法获取锁的时候会使用WFE指令使CPU睡眠。现在释放锁了，自然要唤醒所有睡眠的CPU醒来检查自己是不是可以获取锁。</p></blockquote><h2 style="color: rgb(31, 31, 31);font-size: 18px;font-weight: bold;padding: 0px;margin: 25px 0px 10px;font-family: Arial, Helvetica, sans-serif;font-style: normal;font-variant: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">信号量（semaphore）</h2><p><span style="color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;display: inline !important;float: none;background-color: rgb(255, 255, 255);">信号量（semaphore）是进程间通信处理同步互斥的机制。是在多线程环境下使用的一种措施，它负责协调各个进程，以保证他们能够正确、合理的使用公共资源。 它和spin lock最大的不同之处就是：无法获取信号量的进程可以睡眠，因此会导致系统调度。</span></p><h3 style="color: rgb(68, 68, 68);font-size: 14px;font-weight: bold;margin: 15px 0px 0px;padding: 8px 0px;font-family: Arial, Helvetica, sans-serif;font-style: normal;font-variant: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">原理</h3><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">信号量一般可以用来标记可用资源的个数。老规矩，还是举个例子。假设图书馆有2本《C语言从入门到放弃》书籍。A同学想学C语言，于是发现这本书特别的好。于是就去学校的图书馆借书，A同学成功的从图书馆借走一本。这时，A同学室友B同学发现A同学竟然在偷偷的学习武功秘籍（C语言）。于是，B同学也去借一本。此时，图书馆已经没有书了。C同学也想借这本书，可能是这本书太火了。图书馆管理员告诉C同学，图书馆这本书都被借走了。如果有同学换回来，会第一时间通知你。于是，管理员就把C同学的信息登记先来，以备后续通知C同学来借书。所以，C同学只能悲伤的走了（如果是自旋锁的原理的话，那么C同学将会端个小板凳坐在图书馆，一直要等到A同学或者B同学还书并借走）。</p><h3 style="color: rgb(68, 68, 68);font-size: 14px;font-weight: bold;margin: 15px 0px 0px;padding: 8px 0px;font-family: Arial, Helvetica, sans-serif;font-style: normal;font-variant: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">实现</h3><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">为了记录可用资源的数量，我们肯定需要一个count计数，标记当前可用资源数量。当然还要一个可以像图书管理员一样的笔记本功能。用来记录等待借书的同学。所以，一个双向链表即可。因此只需要一个count计数和等待进程的链表头即可。描述信号量的结构体如下。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> semaphore </span><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">unsigned</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">int</span><span class="pln" style="color: rgb(0, 0, 0);"> count</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pln" style="color: rgb(0, 0, 0);">_head wait_list</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">};</span><span class="pln" style="color: rgb(0, 0, 0);"> </span></p></li></ol></pre></pre><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">在linux中，每个进程就相当于是每个借书的同学。通知一个同学，就相当于唤醒这个进程。因此，我们还需要一个结构体记录当前的进程信息（task_struct）。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> semaphore_waiter </span><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pln" style="color: rgb(0, 0, 0);">_head </span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> task_struct </span><span class="pun" style="color: rgb(102, 102, 0);">*</span><span class="pln" style="color: rgb(0, 0, 0);">task</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">};</span><span class="pln" style="color: rgb(0, 0, 0);"> </span></p></li></ol></pre></pre><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">struct semaphore_waiter的list成员是当进程无法获取信号量的时候挂入semaphore的wait_list成员。task成员就是记录后续被唤醒的进程信息。</p><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">一切准备就绪，现在就可以实现信号量的申请函数。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">void</span><span class="pln" style="color: rgb(0, 0, 0);"> down</span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> semaphore </span><span class="pun" style="color: rgb(102, 102, 0);">*</span><span class="pln" style="color: rgb(0, 0, 0);">sem</span><span class="pun" style="color: rgb(102, 102, 0);">)</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> semaphore_waiter waiter</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">&nbsp;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">if</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="pln" style="color: rgb(0, 0, 0);">sem</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">count </span><span class="pun" style="color: rgb(102, 102, 0);">&gt;</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="lit" style="color: rgb(0, 102, 102);">0</span><span class="pun" style="color: rgb(102, 102, 0);">)</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		sem</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">count</span><span class="pun" style="color: rgb(102, 102, 0);">--;</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 1 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">return</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="pun" style="color: rgb(102, 102, 0);">}</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">&nbsp;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	waiter</span><span class="pun" style="color: rgb(102, 102, 0);">.</span><span class="pln" style="color: rgb(0, 0, 0);">task </span><span class="pun" style="color: rgb(102, 102, 0);">=</span><span class="pln" style="color: rgb(0, 0, 0);"> current</span><span class="pun" style="color: rgb(102, 102, 0);">;</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com" style="color: rgb(136, 0, 0);">/* 2 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pln" style="color: rgb(0, 0, 0);">_add_tail</span><span class="pun" style="color: rgb(102, 102, 0);">(&amp;</span><span class="pln" style="color: rgb(0, 0, 0);">waiter</span><span class="pun" style="color: rgb(102, 102, 0);">.</span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pun" style="color: rgb(102, 102, 0);">,</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">&amp;</span><span class="pln" style="color: rgb(0, 0, 0);">sem</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">wait_list</span><span class="pun" style="color: rgb(102, 102, 0);">);</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 2 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	schedule</span><span class="pun" style="color: rgb(102, 102, 0);">();</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 3 */</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">}</span><span class="pln" style="color: rgb(0, 0, 0);"> </span></p></li></ol></pre></pre><blockquote style="margin: 0px 20px 20px;padding: 25px 20px;border-left-width: 5px;border-left-style: solid;border-left-color: rgb(105, 105, 105);border-right-width: 5px;border-right-style: solid;border-right-color: rgb(105, 105, 105);color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background: rgb(239, 239, 239);"><ol style="" class=" list-paddingleft-2"><li><p>如果信号量标记的资源还有剩余，自然可以成功获取信号量。只需要递减可用资源计数。</p></li><li><p>既然无法获取信号量，就需要将当前进程挂入信号量的等待队列链表上。</p></li><li><p>schedule()主要是触发任务调度的示意函数，主动让出CPU使用权。在让出之前，需要将当前进程从运行队列上移除。</p></li></ol></blockquote><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">释放信号的实现也是比较简单。实现如下。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">void</span><span class="pln" style="color: rgb(0, 0, 0);"> up</span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> semaphore </span><span class="pun" style="color: rgb(102, 102, 0);">*</span><span class="pln" style="color: rgb(0, 0, 0);">sem</span><span class="pun" style="color: rgb(102, 102, 0);">)</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> semaphore_waiter waiter</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">&nbsp;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">if</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pln" style="color: rgb(0, 0, 0);">_empty</span><span class="pun" style="color: rgb(102, 102, 0);">(&amp;</span><span class="pln" style="color: rgb(0, 0, 0);">sem</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">wait_list</span><span class="pun" style="color: rgb(102, 102, 0);">))</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		sem</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">count</span><span class="pun" style="color: rgb(102, 102, 0);">++;</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com" style="color: rgb(136, 0, 0);">/* 1 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">return</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="pun" style="color: rgb(102, 102, 0);">}</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">&nbsp;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	waiter </span><span class="pun" style="color: rgb(102, 102, 0);">=</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pln" style="color: rgb(0, 0, 0);">_first_entry</span><span class="pun" style="color: rgb(102, 102, 0);">(&amp;</span><span class="pln" style="color: rgb(0, 0, 0);">sem</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">wait_list</span><span class="pun" style="color: rgb(102, 102, 0);">,</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> semaphore_waiter</span><span class="pun" style="color: rgb(102, 102, 0);">,</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pun" style="color: rgb(102, 102, 0);">);</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pln" style="color: rgb(0, 0, 0);">_del</span><span class="pun" style="color: rgb(102, 102, 0);">(&amp;</span><span class="pln" style="color: rgb(0, 0, 0);">waiter</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pun" style="color: rgb(102, 102, 0);">);</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 2 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	wake_up_process</span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="pln" style="color: rgb(0, 0, 0);">waiter</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">task</span><span class="pun" style="color: rgb(102, 102, 0);">);</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 2 */</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">}</span><span class="pln" style="color: rgb(0, 0, 0);"> </span></p></li></ol></pre></pre><blockquote style="margin: 0px 20px 20px;padding: 25px 20px;border-left-width: 5px;border-left-style: solid;border-left-color: rgb(105, 105, 105);border-right-width: 5px;border-right-style: solid;border-right-color: rgb(105, 105, 105);color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background: rgb(239, 239, 239);"><ol style="" class=" list-paddingleft-2"><li><p>如果等待链表没有进程，那么自然只需要增加资源计数。</p></li><li><p>从等待进程链表头取出第一个进程，并从链表上移除。然后就是唤醒该进程。</p></li></ol></blockquote><h2 style="color: rgb(31, 31, 31);font-size: 18px;font-weight: bold;padding: 0px;margin: 25px 0px 10px;font-family: Arial, Helvetica, sans-serif;font-style: normal;font-variant: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">读写锁（read-write lock）</h2><p><span style="color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;display: inline !important;float: none;background-color: rgb(255, 255, 255);">不管是自旋锁还是信号量在同一时间只能有一个进程进入临界区。对于有些情况，我们是可以区分读写操作的。因此，我们希望对于读操作的进程可以并发进行。对于写操作只限于一个进程进入临界区。而这种同步机制就是读写锁。读写锁一般具有以下几种性质。</span></p><ul style="" class=" list-paddingleft-2"><li><p>同一时间有且仅有一个写进程进入临界区。</p></li><li><p>在没有写进程进入临界区的时候，同时可以有多个读进程进入临界区。</p></li><li><p>读进程和写进程不可以同时进入临界区。</p></li></ul><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">读写锁有两种，一种是信号量类型，另一种是spin lock类型。下面以spin lock类型讲解。</p><h3 style="color: rgb(68, 68, 68);font-size: 14px;font-weight: bold;margin: 15px 0px 0px;padding: 8px 0px;font-family: Arial, Helvetica, sans-serif;font-style: normal;font-variant: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">原理</h3><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">老规矩，还是举个例子理解读写锁。我绞尽脑汁才想到一个比较贴切的例子。这个例子来源于生活。我发现公司一般都会有保洁阿姨打扫厕所。如果以男厕所为例的话，我觉得男士进入厕所就相当于读者进入临界区。因为可以有多个男士进厕所。而保洁阿姨进入男士厕所就相当于写者进入临界区。假设A男士发现保洁阿姨不在打扫厕所，就进入厕所。随后B和C同时也进入厕所。然后保洁阿姨准备打扫厕所，发现有男士在厕所里面，因此只能在门口等待。ABC都离开了厕所。保洁阿姨迅速进入厕所打扫。然后D男士去上厕所，发现保洁阿姨在里面。灰溜溜的出来了在门口等着。现在体会到了写者（保洁阿姨）具有排他性，读者（男士）可以并发进入临界区了吧。</p><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">既然我们允许多个读者进入临界区，因此我们需要一个计数统计读者的个数。同时，由于写者永远只存在一个进入临界区，因此只需要一个bit标记是否有写进程进入临界区。所以，我们可以将两个计数合二为一。只需要1个unsigned int类型即可。最高位（bit31）代表是否有写者进入临界区，低31位（0~30bit）统计读者个数。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><code class="language-c" lang="c"> <pre class="prettyprint linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="pun" style="color: rgb(102, 102, 0);">+----+-------------------------------------------------+</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">|</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="lit" style="color: rgb(0, 102, 102);">31</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">|</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="lit" style="color: rgb(0, 102, 102);">30</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="lit" style="color: rgb(0, 102, 102);">0</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">|</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">+----+-------------------------------------------------+</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp;</span><span class="pun" style="color: rgb(102, 102, 0);">|</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun" style="color: rgb(102, 102, 0);">|</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp;</span><span class="pun" style="color: rgb(102, 102, 0);">|</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun" style="color: rgb(102, 102, 0);">+----&gt;</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">[</span><span class="lit" style="color: rgb(0, 102, 102);">0</span><span class="pun" style="color: rgb(102, 102, 0);">:</span><span class="lit" style="color: rgb(0, 102, 102);">30</span><span class="pun" style="color: rgb(102, 102, 0);">]</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">Read</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">Thread</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">Counter</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp;</span><span class="pun" style="color: rgb(102, 102, 0);">+-------------------------&gt;</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">[</span><span class="lit" style="color: rgb(0, 102, 102);">31</span><span class="pun" style="color: rgb(102, 102, 0);">]</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp;</span><span class="typ" style="color: rgb(102, 0, 102);">Write</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">Thread</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">Counter</span></p></li></ol></pre></code></pre><h3 style="color: rgb(68, 68, 68);font-size: 14px;font-weight: bold;margin: 15px 0px 0px;padding: 8px 0px;font-family: Arial, Helvetica, sans-serif;font-style: normal;font-variant: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">实现</h3><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">描述读写锁只需要1个变量即可，因此我们可以定义读写锁的结构体如下。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">typedef</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">volatile</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">unsigned</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">int</span><span class="pln" style="color: rgb(0, 0, 0);"> lock</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">}</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">arch_rwlock_t</span><span class="pun" style="color: rgb(102, 102, 0);">;</span><span class="pln" style="color: rgb(0, 0, 0);"> </span></p></li></ol></pre></pre><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">既然区分读写操作，因此肯定会有两个申请锁函数，分别是读和写。首先，我们看一下read_lock操作的实现。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">static</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">inline</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">void</span><span class="pln" style="color: rgb(0, 0, 0);"> arch_read_lock</span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="typ" style="color: rgb(102, 0, 102);">arch_rwlock_t</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">*</span><span class="pln" style="color: rgb(0, 0, 0);">rw</span><span class="pun" style="color: rgb(102, 102, 0);">)</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">unsigned</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">int</span><span class="pln" style="color: rgb(0, 0, 0);"> tmp</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">&nbsp;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	sevl</span><span class="pun" style="color: rgb(102, 102, 0);">();</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 1 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">do</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		wfe</span><span class="pun" style="color: rgb(102, 102, 0);">();</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		tmp </span><span class="pun" style="color: rgb(102, 102, 0);">=</span><span class="pln" style="color: rgb(0, 0, 0);"> rw</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">lock</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		tmp</span><span class="pun" style="color: rgb(102, 102, 0);">++;</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com" style="color: rgb(136, 0, 0);">/* 2 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="pun" style="color: rgb(102, 102, 0);">}</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">while</span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="pln" style="color: rgb(0, 0, 0);">tmp </span><span class="pun" style="color: rgb(102, 102, 0);">&amp;</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="lit" style="color: rgb(0, 102, 102);">1</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">&lt;&lt;</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="lit" style="color: rgb(0, 102, 102);">31</span><span class="pun" style="color: rgb(102, 102, 0);">));</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 3 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	rw</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">lock </span><span class="pun" style="color: rgb(102, 102, 0);">=</span><span class="pln" style="color: rgb(0, 0, 0);"> tmp</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">}</span><span class="pln" style="color: rgb(0, 0, 0);"> </span></p></li></ol></pre></pre><blockquote style="margin: 0px 20px 20px;padding: 25px 20px;border-left-width: 5px;border-left-style: solid;border-left-color: rgb(105, 105, 105);border-right-width: 5px;border-right-style: solid;border-right-color: rgb(105, 105, 105);color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background: rgb(239, 239, 239);"><ol style="" class=" list-paddingleft-2"><li><p>sevl()函数是ARM64架构中SEVL汇编指令。SEVL和SEV的区别是，SEVL仅仅修改本地CPU的PE寄存器值，这样下面的WFE指令第一次执行的时候不会睡眠。</p></li><li><p>增加读者计数，最后会更新到rw-&gt;lock中。</p></li><li><p>更新rw-&gt;lock前提是没有写者，因此这里会判断是否有写者已经进入临界区（判断方法是rw-&gt;lock变量bit31的值）。如果，有写者已经进入临界区，就在这里循环，并WFE指令睡眠。类似上面介绍的spin lock实现。</p></li></ol></blockquote><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">当读进程离开临界区的时候会调用read_unlock释放锁。read_unlock实现如下。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">static</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">inline</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">void</span><span class="pln" style="color: rgb(0, 0, 0);"> arch_read_unlock</span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="typ" style="color: rgb(102, 0, 102);">arch_rwlock_t</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">*</span><span class="pln" style="color: rgb(0, 0, 0);">rw</span><span class="pun" style="color: rgb(102, 102, 0);">)</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	rw</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">lock</span><span class="pun" style="color: rgb(102, 102, 0);">--;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	sev</span><span class="pun" style="color: rgb(102, 102, 0);">();</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">}</span><span class="pln" style="color: rgb(0, 0, 0);"> </span></p></li></ol></pre></pre><blockquote style="margin: 0px 20px 20px;padding: 25px 20px;border-left-width: 5px;border-left-style: solid;border-left-color: rgb(105, 105, 105);border-right-width: 5px;border-right-style: solid;border-right-color: rgb(105, 105, 105);color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background: rgb(239, 239, 239);"><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;">实现很简单，和spin_unlock如出一辙。递减读者计数，然后使用SEV指令唤醒所有的CPU，检查等待状态的进程是否可以获取锁。</p></blockquote><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">读操作看完了，我们看看写操作是如何实现的。arch_write_lock实现如下。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">static</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">inline</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">void</span><span class="pln" style="color: rgb(0, 0, 0);"> arch_write_lock</span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="typ" style="color: rgb(102, 0, 102);">arch_rwlock_t</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">*</span><span class="pln" style="color: rgb(0, 0, 0);">rw</span><span class="pun" style="color: rgb(102, 102, 0);">)</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">unsigned</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">int</span><span class="pln" style="color: rgb(0, 0, 0);"> tmp</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">&nbsp;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	sevl</span><span class="pun" style="color: rgb(102, 102, 0);">();</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">do</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		wfe</span><span class="pun" style="color: rgb(102, 102, 0);">();</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		tmp </span><span class="pun" style="color: rgb(102, 102, 0);">=</span><span class="pln" style="color: rgb(0, 0, 0);"> rw</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">lock</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="pun" style="color: rgb(102, 102, 0);">}</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">while</span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="pln" style="color: rgb(0, 0, 0);">tmp</span><span class="pun" style="color: rgb(102, 102, 0);">);</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 1 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	rw</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">lock </span><span class="pun" style="color: rgb(102, 102, 0);">=</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="lit" style="color: rgb(0, 102, 102);">1</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">&lt;&lt;</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="lit" style="color: rgb(0, 102, 102);">31</span><span class="pun" style="color: rgb(102, 102, 0);">;</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 2 */</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">}</span><span class="pln" style="color: rgb(0, 0, 0);"> </span></p></li></ol></pre></pre><blockquote style="margin: 0px 20px 20px;padding: 25px 20px;border-left-width: 5px;border-left-style: solid;border-left-color: rgb(105, 105, 105);border-right-width: 5px;border-right-style: solid;border-right-color: rgb(105, 105, 105);color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background: rgb(239, 239, 239);"><ol style="" class=" list-paddingleft-2"><li><p>由于写者是排他的（读者和写者都不能有），因此这里只有rw-&gt;lock的值为0，当前的写者才可以进入临界区。</p></li><li><p>置位rw-&gt;lock的bit31，代表有写者进入临界区。</p></li></ol></blockquote><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">当写进程离开临界区的时候会调用write_unlock释放锁。write_unlock实现如下。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">static</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">inline</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">void</span><span class="pln" style="color: rgb(0, 0, 0);"> arch_write_unlock</span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="typ" style="color: rgb(102, 0, 102);">arch_rwlock_t</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">*</span><span class="pln" style="color: rgb(0, 0, 0);">rw</span><span class="pun" style="color: rgb(102, 102, 0);">)</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	rw</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">lock </span><span class="pun" style="color: rgb(102, 102, 0);">=</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="lit" style="color: rgb(0, 102, 102);">0</span><span class="pun" style="color: rgb(102, 102, 0);">;</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 1 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	sev</span><span class="pun" style="color: rgb(102, 102, 0);">();</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com" style="color: rgb(136, 0, 0);">/* 2 */</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">}</span><span class="pln" style="color: rgb(0, 0, 0);"> </span></p></li></ol></pre></pre><blockquote style="margin: 0px 20px 20px;padding: 25px 20px;border-left-width: 5px;border-left-style: solid;border-left-color: rgb(105, 105, 105);border-right-width: 5px;border-right-style: solid;border-right-color: rgb(105, 105, 105);color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background: rgb(239, 239, 239);"><ol style="" class=" list-paddingleft-2"><li><p>同样由于写者是排他的，因此只需要将rw-&gt;lock置0即可。代表没有任何进程进入临界区。毕竟是因为同一时间只能有一个写者进入临界区，当这个写者离开临界区的时候，肯定是意味着现在没有任何进程进入临界区。</p></li><li><p>使用SEV指令唤醒所有的CPU，检查等待状态的进程是否可以获取锁。</p></li></ol></blockquote><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">以上的代码实现其实会导致写进程饿死现象。例如，A、B、C三个进程进入读临界区，D进程尝试获得写锁，此时只能等待A、B、C三个进程退出临界区。如果在退出之前又有F、G进程进入读临界区，那么将出现D进程饿死现象。</p><h2 style="color: rgb(31, 31, 31);font-size: 18px;font-weight: bold;padding: 0px;margin: 25px 0px 10px;font-family: Arial, Helvetica, sans-serif;font-style: normal;font-variant: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">互斥量（mutex）</h2><p><span style="color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;display: inline !important;float: none;background-color: rgb(255, 255, 255);">前文提到的semaphore在初始化count计数的时候，可以分为计数信号量和互斥信号量（二值信号量）。mutex和初始化计数为1的二值信号量有很大的相似之处。他们都可以用做资源互斥。但是mutex却有一个特殊的地方：只有持锁者才能解锁。但是，二值信号量却可以在一个进程中获取信号量，在另一个进程中释放信号量。如果是应用在嵌入式应用的RTOS，针对mutex的实现还会考虑优先级反转问题。</span></p><h3 style="color: rgb(68, 68, 68);font-size: 14px;font-weight: bold;margin: 15px 0px 0px;padding: 8px 0px;font-family: Arial, Helvetica, sans-serif;font-style: normal;font-variant: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">原理</h3><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">既然mutex是一种二值信号量，因此就不需要像semaphore那样需要一个count计数。由于mutex具有“持锁者才能解锁”的特点，所以我们需要一个变量owner记录持锁进程。释放锁的时候必须是同一个进程才能释放。当然也需要一个链表头，主要用来便利睡眠等待的进程。原理和semaphore及其相似，因此在代码上也有体现。</p><h3 style="color: rgb(68, 68, 68);font-size: 14px;font-weight: bold;margin: 15px 0px 0px;padding: 8px 0px;font-family: Arial, Helvetica, sans-serif;font-style: normal;font-variant: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">实现</h3><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">mutex的实现代码和linux中实现会有差异，但是依然可以为你呈现设计的原理。下面的设计代码更像是部分RTOS中的代码。mutex和semaphore一样，我们需要两个类似的结构体分别描述mutex。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> mutex_waiter </span><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pln" style="color: rgb(0, 0, 0);">_head &nbsp; </span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> task_struct </span><span class="pun" style="color: rgb(102, 102, 0);">*</span><span class="pln" style="color: rgb(0, 0, 0);">task</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">};</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">&nbsp;</span></p></li><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> mutex </span><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp;</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">long</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; owner</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp;</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pln" style="color: rgb(0, 0, 0);">_head wait_list</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">};</span><span class="pln" style="color: rgb(0, 0, 0);"> </span></p></li></ol></pre></pre><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">struct mutex_waiter的list成员是当进程无法获取互斥量的时候挂入mutex的wait_list链表。</p><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">首先实现申请互斥量的函数。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">void</span><span class="pln" style="color: rgb(0, 0, 0);"> mutex_take</span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> mutex </span><span class="pun" style="color: rgb(102, 102, 0);">*</span><span class="pln" style="color: rgb(0, 0, 0);">mutex</span><span class="pun" style="color: rgb(102, 102, 0);">)</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> mutex_waiter waiter</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">&nbsp;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">if</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">(!</span><span class="pln" style="color: rgb(0, 0, 0);">mutex</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">owner</span><span class="pun" style="color: rgb(102, 102, 0);">)</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		mutex</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">owner </span><span class="pun" style="color: rgb(102, 102, 0);">=</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">long</span><span class="pun" style="color: rgb(102, 102, 0);">)</span><span class="pln" style="color: rgb(0, 0, 0);">current</span><span class="pun" style="color: rgb(102, 102, 0);">;</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 1 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">return</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="pun" style="color: rgb(102, 102, 0);">}</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">&nbsp;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	waiter</span><span class="pun" style="color: rgb(102, 102, 0);">.</span><span class="pln" style="color: rgb(0, 0, 0);">task </span><span class="pun" style="color: rgb(102, 102, 0);">=</span><span class="pln" style="color: rgb(0, 0, 0);"> current</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pln" style="color: rgb(0, 0, 0);">_add_tail</span><span class="pun" style="color: rgb(102, 102, 0);">(&amp;</span><span class="pln" style="color: rgb(0, 0, 0);">waiter</span><span class="pun" style="color: rgb(102, 102, 0);">.</span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pun" style="color: rgb(102, 102, 0);">,</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">&amp;</span><span class="pln" style="color: rgb(0, 0, 0);">mutex</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">wait_list</span><span class="pun" style="color: rgb(102, 102, 0);">);</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="com" style="color: rgb(136, 0, 0);">/* 2 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	schedule</span><span class="pun" style="color: rgb(102, 102, 0);">();</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 2 */</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">}</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp;</span></p></li></ol></pre></pre><blockquote style="margin: 0px 20px 20px;padding: 25px 20px;border-left-width: 5px;border-left-style: solid;border-left-color: rgb(105, 105, 105);border-right-width: 5px;border-right-style: solid;border-right-color: rgb(105, 105, 105);color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background: rgb(239, 239, 239);"><ol style="" class=" list-paddingleft-2"><li><p>当mutex-&gt;owner的值为0的时候，代表没有任何进程持有锁。因此可以直接申请成功。然后，记录当前申请锁进程的task_struct。</p></li><li><p>既然不能获取互斥量，自然就需要睡眠等待，挂入等待链表。</p></li></ol></blockquote><p style="padding: 0px 0px 15px;margin: 0px;line-height: 20px;color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);">互斥量的释放代码实现也同样和semaphore有很多相似之处。不信，你看。</p><pre style="color: rgb(50, 50, 50);font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><code class="language-c" lang="c"> <pre class="prettyprint lang-cpp linenums" style="border-color: rgb(136, 136, 136);border-style: solid;border-width: 0px;font-family: &quot;Courier New&quot;, Courier, monospace;font-size: 12px;overflow: auto;margin: 5px 0px;padding: 0px;line-height: 12pt;"><ol class="linenums list-paddingleft-2" style=""><li><p><span class="typ" style="color: rgb(102, 0, 102);">int</span><span class="pln" style="color: rgb(0, 0, 0);"> mutex_release</span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> mutex </span><span class="pun" style="color: rgb(102, 102, 0);">*</span><span class="pln" style="color: rgb(0, 0, 0);">mutex</span><span class="pun" style="color: rgb(102, 102, 0);">)</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> mutex_waiter </span><span class="pun" style="color: rgb(102, 102, 0);">*</span><span class="pln" style="color: rgb(0, 0, 0);">waiter</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">&nbsp;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">if</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="pln" style="color: rgb(0, 0, 0);">mutex</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">owner </span><span class="pun" style="color: rgb(102, 102, 0);">!=</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">long</span><span class="pun" style="color: rgb(102, 102, 0);">)</span><span class="pln" style="color: rgb(0, 0, 0);">current</span><span class="pun" style="color: rgb(102, 102, 0);">)</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 1 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">return</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">-</span><span class="lit" style="color: rgb(0, 102, 102);">1</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">&nbsp;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">if</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pln" style="color: rgb(0, 0, 0);">_empty</span><span class="pun" style="color: rgb(102, 102, 0);">(&amp;</span><span class="pln" style="color: rgb(0, 0, 0);">mutex</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">wait_list</span><span class="pun" style="color: rgb(102, 102, 0);">))</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">{</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		mutex</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">owner </span><span class="pun" style="color: rgb(102, 102, 0);">=</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="lit" style="color: rgb(0, 102, 102);">0</span><span class="pun" style="color: rgb(102, 102, 0);">;</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com" style="color: rgb(136, 0, 0);">/* 2 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">		</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">return</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="lit" style="color: rgb(0, 102, 102);">0</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="pun" style="color: rgb(102, 102, 0);">}</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">&nbsp;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	waiter </span><span class="pun" style="color: rgb(102, 102, 0);">=</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pln" style="color: rgb(0, 0, 0);">_first_entry</span><span class="pun" style="color: rgb(102, 102, 0);">(&amp;</span><span class="pln" style="color: rgb(0, 0, 0);">mutex</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">wait_list</span><span class="pun" style="color: rgb(102, 102, 0);">,</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">struct</span><span class="pln" style="color: rgb(0, 0, 0);"> mutex_waiter</span><span class="pun" style="color: rgb(102, 102, 0);">,</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pun" style="color: rgb(102, 102, 0);">);</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pln" style="color: rgb(0, 0, 0);">_del</span><span class="pun" style="color: rgb(102, 102, 0);">(&amp;</span><span class="pln" style="color: rgb(0, 0, 0);">waiter</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="typ" style="color: rgb(102, 0, 102);">list</span><span class="pun" style="color: rgb(102, 102, 0);">);</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	mutex</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">owner </span><span class="pun" style="color: rgb(102, 102, 0);">=</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">long</span><span class="pun" style="color: rgb(102, 102, 0);">)</span><span class="pln" style="color: rgb(0, 0, 0);">waiter</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">task</span><span class="pun" style="color: rgb(102, 102, 0);">;</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 3 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	wake_up_process</span><span class="pun" style="color: rgb(102, 102, 0);">(</span><span class="pln" style="color: rgb(0, 0, 0);">waiter</span><span class="pun" style="color: rgb(102, 102, 0);">-&gt;</span><span class="pln" style="color: rgb(0, 0, 0);">task</span><span class="pun" style="color: rgb(102, 102, 0);">);</span><span class="pln" style="color: rgb(0, 0, 0);"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com" style="color: rgb(136, 0, 0);">/* 4 */</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">&nbsp;</span></p></li><li><p><span class="pln" style="color: rgb(0, 0, 0);">	</span><span class="kwd" style="color: rgb(0, 0, 136);font-weight: bold;">return</span><span class="pln" style="color: rgb(0, 0, 0);"> </span><span class="lit" style="color: rgb(0, 102, 102);">0</span><span class="pun" style="color: rgb(102, 102, 0);">;</span></p></li><li><p><span class="pun" style="color: rgb(102, 102, 0);">}</span></p></li></ol></pre></code></pre><blockquote style="margin: 0px 20px 20px;padding: 25px 20px;border-left-width: 5px;border-left-style: solid;border-left-color: rgb(105, 105, 105);border-right-width: 5px;border-right-style: solid;border-right-color: rgb(105, 105, 105);color: rgb(50, 50, 50);font-family: Arial, Helvetica, sans-serif;font-size: 13px;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;line-height: 18px;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background: rgb(239, 239, 239);"><ol style="" class=" list-paddingleft-2"><li><p>mutex具有“持锁者才能解锁”的特点就是在这行代码体现。</p></li><li><p>如果等待链表没有进程，那么自然只需要将mutex-&gt;owner置0，代表没有锁是释放状态。</p></li><li><p>mutex-&gt;owner的值改成当前可以持锁进程的task_struct。</p></li><li><p>从等待进程链表取出第一个进程，并从链表上移除。然后就是唤醒该进程。</p></li></ol></blockquote><p class="tag" style="color: rgb(169, 121, 101);padding: 0px 0px 15px;margin: 0px;line-height: 20px;font-size: 12px;font-family: Arial, Helvetica, sans-serif;font-style: normal;font-variant: normal;font-weight: normal;letter-spacing: normal;orphans: auto;text-align: left;text-indent: 0px;text-transform: none;white-space: normal;widows: 1;word-spacing: 0px;-webkit-text-stroke-width: 0px;background-color: rgb(255, 255, 255);"><br  /></p><p><br  /></p>
                </div>
                

                
  <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display: none;"></div>


                
                <div class="read-more__area" id="js_more_read_area" style="display:none;">
                    
                </div>

                
                                <div class="reward_area tc reward_area_primary" id="js_preview_reward_author" style="display:none;">
                    <div class="reward-avatar" style="display: none;" id="js_preview_reward_author_avatar">
                        <img src="" alt="" id="js_preview_reward_author_head">
                    </div>
                    
                                        <div class="reward-author" id="js_preview_reward_author_name">smcdef</div>
                                        <p class="reward_tips" id="js_preview_reward_author_wording" style="display:none;"></p>
                    <p class="reward_button_wrp">
                    
                      <span class="reward_pop_panel">
                        <img src="https://res.wx.qq.com/mpres/zh_CN/htmledition/pages/home/index/pic_mp_app4290ba.png" alt="">
                        <strong>扫一扫下载订阅号助手，用手机发文章</strong>
                      </span>
                        <a class="reward_button" id='js_preview_reward_author_link' href="##"><span id="js_preview_reward_link_text">赞赏</span></a>
                    </p>
                </div>

                <div class="reward_qrcode_area reward_area tc" id="js_preview_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                    <p id="js_preview_reward_ios_wording" class="reward_tips" style="display:none;"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" src="res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_reward_qrcode.2x42f400.png"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                            </div>
		<div class="comment">
			<h3 style="margin:26px 0;font-weight:100;padding-bottom:4px;border-bottom:1px solid #ccc;">精选留言</h3>
		    暂无...
		</div>
	</div>
	<div class='dy_all'>
		<a href='https://www.52pojie.cn/' target='_blank'>
			吾爱破解论坛
		</a>
	</div>
</body>